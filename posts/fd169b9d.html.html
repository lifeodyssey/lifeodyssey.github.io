<!DOCTYPE html><html class="font-sans scroll-smooth" lang=zh-CN><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,viewport-fit=cover" name=viewport><link href=/icons/favicon.svg rel=icon type=image/svg+xml><title>tensorflow基础 | 乔克叔叔的床边故事</title><meta content="开始炼丹的第二天 import tensorflow as tf mnist = tf.keras.datasets.mnist (x_train, y_train), (x_test, y_test) = mnist.load_data..." name=description><meta content=周大侠 name=author><meta content="Astro v5.13.7" name=generator><meta content="oklch(96% 0.005 298)" name=theme-color><link href=/fonts/EarlySummer-VF-Split/EarlySummer-VF-Subset.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Snell-Black-SF.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Snell-Bold-SF.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/STIX-VF.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/STIX-Italic-VF.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/_astro/katex.min.COXD5gRV.css rel=stylesheet media=print onload="this.media=&#34;all&#34;"><link href=https://lifeodyssey.github.io/posts/fd169b9d.html.html rel=canonical><link href=/sitemap-index.xml rel=sitemap><link href=/rss.xml rel=alternate type=application/rss+xml title="RSS Feed"><link href=/atom.xml rel=alternate type=application/atom+xml title="Atom Feed"><link href=https://lifeodyssey.github.io rel=alternate hreflang=zh><link href=https://lifeodyssey.github.io/en/ rel=alternate hreflang=en><link href=https://lifeodyssey.github.io/ja/ rel=alternate hreflang=ja><meta content=article property=og:type><meta content=https://lifeodyssey.github.io/posts/fd169b9d.html.html property=og:url><meta content="tensorflow基础 | 乔克叔叔的床边故事" property=og:title><meta content="开始炼丹的第二天 import tensorflow as tf mnist = tf.keras.datasets.mnist (x_train, y_train), (x_test, y_test) = mnist.load_data..." property=og:description><meta content=https://lifeodyssey.github.io/og/fd169b9d.png property=og:image><meta content=summary_large_image name=twitter:card><meta content=true name=astro-view-transitions-enabled><meta content=none name=astro-view-transitions-fallback><script type=module src=/_astro/ClientRouter.astro_astro_type_script_index_0_lang.1k2cUud7.js></script><script>!function(){function e(e=document){const t=function(){const e=localStorage.getItem("theme");return!!e&&"dark"===e}();e.documentElement.classList.toggle("dark",t);const n=e.head.querySelector('meta[name="theme-color"]');n&&n.setAttribute("content",t?"oklch(22% 0.005 298)":"oklch(96% 0.005 298)")}function t(e=document){const t=window.matchMedia("(prefers-reduced-motion: reduce)").matches||!("startViewTransition"in e);e.documentElement.classList.toggle("reduce-motion",t)}document.addEventListener("astro:before-swap",(({newDocument:n})=>{e(n),t(n)})),e(),t()}()</script><link href=/_astro/_about_.Dzb1Me_E.css rel=stylesheet><link href=/_astro/_posts_slug_.CM85RmC-.css rel=stylesheet><script type=module src=/_astro/page.BNYwb576.js></script><script>!function(t,e,n,r){(window.crossOriginIsolated||navigator.serviceWorker)&&((r=t[e]=Object.assign(t[e]||{},{lib:"/~partytown/",debug:!1}))[n]=(r[n]||[]).concat(["dataLayer.push","gtag"]))}(window,"partytown","forward");const tp={preserveBehavior:!1},ep=t=>{if("string"==typeof t)return[t,tp];const[e,n=tp]=t;return[e,{...tp,...n}]},n=Object.freeze((()=>{const t=new Set;let e=[];do{Object.getOwnPropertyNames(e).forEach((n=>{"function"==typeof e[n]&&t.add(n)}))}while((e=Object.getPrototypeOf(e))!==Object.prototype);return Array.from(t)})());!function(t,e,r,o,i,a,s,c,d,p,l=t,u){function f(){u||(u=1,"/"==(s=(a.lib||"/~partytown/")+(a.debug?"debug/":""))[0]&&(d=e.querySelectorAll('script[type="text/partytown"]'),o!=t?o.dispatchEvent(new CustomEvent("pt1",{detail:t})):(c=setTimeout(w,(null==a?void 0:a.fallbackTimeout)||1e4),e.addEventListener("pt0",h),i?y(1):r.serviceWorker?r.serviceWorker.register(s+(a.swPath||"partytown-sw.js"),{scope:s}).then((function(t){t.active?y():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&y()}))}),console.error):w())))}function y(n){p=e.createElement(n?"script":"iframe"),t._pttab=Date.now(),n||(p.style.display="block",p.style.width="0",p.style.height="0",p.style.border="0",p.style.visibility="hidden",p.setAttribute("aria-hidden",!0)),p.src=s+"partytown-"+(n?"atomics.js?v=0.11.1":"sandbox-sw.html?"+t._pttab),e.querySelector(a.sandboxParent||"body").appendChild(p)}function w(n,r){for(h(),o==t&&(a.forward||[]).map((function(e){const[n]=ep(e);delete t[n.split(".")[0]]})),n=0;n<d.length;n++)(r=e.createElement("script")).innerHTML=d[n].innerHTML,r.nonce=a.nonce,e.head.appendChild(r);p&&p.parentNode.removeChild(p)}function h(){clearTimeout(c)}a=t.partytown||{},o==t&&(a.forward||[]).map((function(e){const[r,{preserveBehavior:o}]=ep(e);l=t,r.split(".").map((function(e,r,i){var a;l=l[i[r]]=r+1<i.length?l[i[r]]||(a=i[r+1],n.includes(a)?[]:{}):(()=>{let e=null;if(o){const{methodOrProperty:n,thisObject:r}=((t,e)=>{let n=t;for(let t=0;t<e.length-1;t+=1)n=n[e[t]];return{thisObject:n,methodOrProperty:e.length>0?n[e[e.length-1]]:void 0}})(t,i);"function"==typeof n&&(e=(...t)=>n.apply(r,...t))}return function(){let n;return e&&(n=e(arguments)),(t._ptf=t._ptf||[]).push(i,arguments),n}})()}))})),"complete"==e.readyState?f():(t.addEventListener("DOMContentLoaded",f),t.addEventListener("load",f))}(window,document,navigator,top,window.crossOriginIsolated),document.addEventListener("astro:before-swap",(t=>{let e=document.body.querySelector("iframe[src*='/~partytown/']");e&&t.newDocument.body.append(e)}))</script><style>[data-astro-transition-scope=astro-va26yt7w-1]{view-transition-name:post-fd169b9d-zh}@layer astro{::view-transition-old(post-fd169b9d-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}::view-transition-new(post-fd169b9d-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}[data-astro-transition=back]::view-transition-old(post-fd169b9d-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}[data-astro-transition=back]::view-transition-new(post-fd169b9d-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}}[data-astro-transition-fallback=old] [data-astro-transition-scope=astro-va26yt7w-1],[data-astro-transition-fallback=old][data-astro-transition-scope=astro-va26yt7w-1]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}[data-astro-transition-fallback=new] [data-astro-transition-scope=astro-va26yt7w-1],[data-astro-transition-fallback=new][data-astro-transition-scope=astro-va26yt7w-1]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}[data-astro-transition=back][data-astro-transition-fallback=old] [data-astro-transition-scope=astro-va26yt7w-1],[data-astro-transition=back][data-astro-transition-fallback=old][data-astro-transition-scope=astro-va26yt7w-1]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}[data-astro-transition=back][data-astro-transition-fallback=new] [data-astro-transition-scope=astro-va26yt7w-1],[data-astro-transition=back][data-astro-transition-fallback=new][data-astro-transition-scope=astro-va26yt7w-1]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}</style><style>[data-astro-transition-scope=astro-aqc54ihn-2]{view-transition-name:time-fd169b9d-zh}@layer astro{::view-transition-old(time-fd169b9d-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}::view-transition-new(time-fd169b9d-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}[data-astro-transition=back]::view-transition-old(time-fd169b9d-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}[data-astro-transition=back]::view-transition-new(time-fd169b9d-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}}[data-astro-transition-fallback=old] [data-astro-transition-scope=astro-aqc54ihn-2],[data-astro-transition-fallback=old][data-astro-transition-scope=astro-aqc54ihn-2]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}[data-astro-transition-fallback=new] [data-astro-transition-scope=astro-aqc54ihn-2],[data-astro-transition-fallback=new][data-astro-transition-scope=astro-aqc54ihn-2]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}[data-astro-transition=back][data-astro-transition-fallback=old] [data-astro-transition-scope=astro-aqc54ihn-2],[data-astro-transition=back][data-astro-transition-fallback=old][data-astro-transition-scope=astro-aqc54ihn-2]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}[data-astro-transition=back][data-astro-transition-fallback=new] [data-astro-transition-scope=astro-aqc54ihn-2],[data-astro-transition=back][data-astro-transition-fallback=new][data-astro-transition-scope=astro-aqc54ihn-2]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}</style><style>[data-astro-transition-scope=astro-wif6pdce-3]{view-transition-name:site-title-zh}@layer astro{::view-transition-old(site-title-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}::view-transition-new(site-title-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}[data-astro-transition=back]::view-transition-old(site-title-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}[data-astro-transition=back]::view-transition-new(site-title-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}}[data-astro-transition-fallback=old] [data-astro-transition-scope=astro-wif6pdce-3],[data-astro-transition-fallback=old][data-astro-transition-scope=astro-wif6pdce-3]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}[data-astro-transition-fallback=new] [data-astro-transition-scope=astro-wif6pdce-3],[data-astro-transition-fallback=new][data-astro-transition-scope=astro-wif6pdce-3]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}[data-astro-transition=back][data-astro-transition-fallback=old] [data-astro-transition-scope=astro-wif6pdce-3],[data-astro-transition=back][data-astro-transition-fallback=old][data-astro-transition-scope=astro-wif6pdce-3]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}[data-astro-transition=back][data-astro-transition-fallback=new] [data-astro-transition-scope=astro-wif6pdce-3],[data-astro-transition=back][data-astro-transition-fallback=new][data-astro-transition-scope=astro-wif6pdce-3]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}</style></head><body><div class="w-full max-w-205.848 min-h-dvh min-h-vh mx-auto" lg="mx-[max(5.75rem,calc(50vw-34.25rem))] my-20 max-w-[min(calc(75vw-16rem),44rem)] min-h-full p-0" p="x-[min(7.25vw,3.731rem)] y-10"><header class="cjk:tracking-0.02em lg:uno-desktop-column lg:top-20 mb-10.8"><h2 class="font-bold c-secondary font-title lg:c-primary lg:mb-1.8 lg:mt-0 lg:text-9 mb-2.8 mt-3 text-5.375"><div class="inline-block box-content pr-1" data-astro-transition-scope=astro-wif6pdce-3 data-disable-theme-transition><a href=/ id=site-title-link>乔克叔叔的床边故事</a></div></h2></header><nav aria-label="Site Navigation" class="hidden cjk:tracking-0.02em font-navbar font-semibold leading-2.45em lg:block lg:bottom-[min(9.04rem+3.85vw,12.5rem)] lg:text-4 lg:uno-desktop-column mb-10.5 text-3.6"><ul><li><a href=/ class="c-primary after:bottom-0.7em font-bold highlight-static">文章</a></li><li><a href=/tags/ class="highlight-hover hover:c-primary after:bottom-0.7em hover:font-bold transition-[colors,font-weight]">标签</a></li><li><a href=/about/ class="highlight-hover hover:c-primary after:bottom-0.7em hover:font-bold transition-[colors,font-weight]">关于</a></li><li><a href=/search/ class="highlight-hover hover:c-primary after:bottom-0.7em hover:font-bold transition-[colors,font-weight]">Search</a></li></ul></nav><main class=mb-10><article class=heti><div class=relative><button aria-label="Go back" class=hidden id=back-button lg="absolute left--10 top-3.8 block aspect-square w-4.5 c-secondary/40 transition-colors ease-out hover:c-secondary/80 active:scale-90!"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d=M17.8.7L4,12l13.8,11.4.7-.9L7.2,12,18.5,1.5l-.7-.8Z /></svg></button><script type=module>function e(t){if(!(t.target instanceof Element?t.target:null)?.closest("#back-button"))return;if(window.history.length>1)return void window.history.back();const e=document.getElementById("site-title-link");e&&e.click()}document.addEventListener("click",e,{passive:!0})</script><h1 class=post-title><span data-astro-transition-scope=astro-va26yt7w-1 data-disable-theme-transition>tensorflow基础</span></h1></div><div class="c-primary block font-time mb-17.2" data-astro-transition-scope=astro-aqc54ihn-2 data-disable-theme-transition id=post-date><time datetime=2022-01-04>2022-01-04 </time><span class=ml-1.75>27 min</span></div><div class="2xl:bg-secondary/0 2xl:border-none 2xl:fixed 2xl:left-0 2xl:max-w-[min(calc(50vw-38rem),13rem)] 2xl:top-44.5 bg-secondary/5 mb-6 uno-round-border" data-astro-cid-v5otsao3 id=toc-container><input data-astro-cid-v5otsao3 hidden id=toc-toggle type=checkbox><div class="w-full h-12 relative" data-astro-cid-v5otsao3><label class="flex absolute inset-0 items-center 2xl:c-secondary/40 2xl:ease-out 2xl:flex 2xl:hover:c-secondary/80 2xl:static 2xl:transition-colors cursor-pointer" data-astro-cid-v5otsao3 for=toc-toggle><span data-astro-cid-v5otsao3 id=toc-mobile-text>目录</span><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24" class="aspect-square 2xl:active:scale-90! 2xl:block 2xl:mt-4 2xl:origin-center hidden ml-4 w-4.2" data-astro-cid-v5otsao3=true id=toc-desktop-icon><path d="M22.2 2.3H1.8V4h19.9zM22.2 20H1.8v1.7h19.9zM15.5 11.2H1.8v1.6H15z"/></svg></label></div><div id=toc-accordion-wrapper data-astro-cid-v5otsao3><nav aria-label="Table of Contents" data-astro-cid-v5otsao3 id=toc-accordion-content><ul data-astro-cid-v5otsao3 id=toc-links-list><li class=ml-0 data-astro-cid-v5otsao3><a href=#训练过程 class="highlight-hover no-heti toc-links-h2" data-astro-cid-v5otsao3>训练过程</a></li><li class=ml-0 data-astro-cid-v5otsao3><a href=#保存和恢复模型 class="highlight-hover no-heti toc-links-h2" data-astro-cid-v5otsao3>保存和恢复模型</a></li><li class=ml-4 data-astro-cid-v5otsao3><a href=#checkpoint-回调选项 class="highlight-hover no-heti toc-links-h3" data-astro-cid-v5otsao3>checkpoint 回调选项</a></li><li class=ml-0 data-astro-cid-v5otsao3><a href=#手动保存权重 class="highlight-hover no-heti toc-links-h2" data-astro-cid-v5otsao3>手动保存权重</a></li><li class=ml-4 data-astro-cid-v5otsao3><a href=#hdf5-格式 class="highlight-hover no-heti toc-links-h3" data-astro-cid-v5otsao3>HDF5 格式</a></li><li class=ml-8 data-astro-cid-v5otsao3><a href=#限制 class="highlight-hover no-heti toc-links-h4" data-astro-cid-v5otsao3>限制</a></li><li class=ml-0 data-astro-cid-v5otsao3><a href=#定义模型 class="highlight-hover no-heti toc-links-h2" data-astro-cid-v5otsao3>定义模型</a></li><li class=ml-0 data-astro-cid-v5otsao3><a href=#实例化调节器并执行超调 class="highlight-hover no-heti toc-links-h2" data-astro-cid-v5otsao3>实例化调节器并执行超调</a></li><li class=ml-0 data-astro-cid-v5otsao3><a href=#从预训练卷积网络创建基础模型 class="highlight-hover no-heti toc-links-h2" data-astro-cid-v5otsao3>从预训练卷积网络创建基础模型</a></li></ul></nav></div></div><script type=module>let s=null,i=null;function g(){if(!(window.innerWidth>=1536))return;const t=document.getElementById("toc-accordion-content");if(!t)return;const e=t.getElementsByTagName("a");if(0===e.length)return;const n=Array.from(e,(t=>t)),o=n.some((t=>t.classList.contains("toc-links-h2")))?"toc-links-h2":"toc-links-h3",c=new Map;n.forEach((t=>{const e=t.getAttribute("href")?.substring(1);e&&c.set(e,t)}));let r=null;function l(t){t!==r&&(n.forEach((t=>{t.classList.remove("toc-link-active")})),t.classList.add("toc-link-active"),t.classList.contains(o)||function(t){for(let e=n.indexOf(t)-1;e>=0;e--){const t=n[e];if(t.classList.contains(o)){t.classList.add("toc-link-active");break}}}(t),r=t,t.scrollIntoView({behavior:"smooth",block:"nearest"}))}s=new IntersectionObserver((t=>{const e=t.find((t=>t.isIntersecting))?.target?.id;if(e){const t=c.get(e);t&&l(t)}}),{rootMargin:"0% 0% -66% 0%",threshold:[.4]}),Array.from(document.querySelectorAll("h2, h3, h4")).filter((t=>t.id&&"footnotes"!==t.id)).forEach((t=>s?.observe(t)));const a=document.getElementById("post-copyright");a&&(i=new IntersectionObserver((t=>{!t[0].isIntersecting&&t[0].boundingClientRect.top<0&&(n.forEach((t=>t.classList.remove("toc-link-active"))),r=null)}),{rootMargin:"0px 0px 0px 0px",threshold:0}),i?.observe(a),n.length>0&&l(n[0]))}function m(){s?.disconnect(),i?.disconnect(),s=null,i=null}document.addEventListener("astro:after-swap",g),document.addEventListener("astro:before-swap",m),g()</script><div id=post-content><p>开始炼丹的第二天</p><h1 id=一个简单的神经网络搭建流程>一个简单的神经网络搭建流程<a href=#一个简单的神经网络搭建流程 class=heading-anchor-link aria-label="Link to 一个简单的神经网络搭建流程"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M2.6 21.4c2 2 5.9 2.9 8.9 0l3.5-3.5-1-1-3.5 3.5c-1.4 1.4-4.2 1.9-6.4-.3s-1.8-5-.3-6.4l3.5-3.5-1-1-3.5 3.5c-3 3-2 6.9 0 8.9ZM21.4 2.6c2 2 2.9 5.9 0 8.9L17.9 15l-1-1 3.5-3.5c1.4-1.4 1.9-4.2-.3-6.4s-5-1.8-6.4-.3l-3.5 3.5-1-1 3.5-3.5c3-3 6.9-2 8.9 0Z"></path><path d="m8.01 14.97 6.93-6.93 1.061 1.06-6.93 6.93z"></path></svg></a></h1><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#d73a49;--shiki-dark:#F97583>import</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tensorflow </span><span style=color:#d73a49;--shiki-dark:#F97583>as</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>mnist </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.keras.datasets.mnist</span></span>
<span class=line></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>(x_train, y_train), (x_test, y_test) </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> mnist.load_data()</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>x_train, x_test </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> x_train </span><span style=color:#d73a49;--shiki-dark:#F97583>/</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 255.0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, x_test </span><span style=color:#d73a49;--shiki-dark:#F97583>/</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 255.0</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>model </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.keras.models.Sequential([</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  tf.keras.layers.Flatten(</span><span style=color:#e36209;--shiki-dark:#FFAB70>input_shape</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>28</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>28</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)),</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  tf.keras.layers.Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>128</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>activation</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'relu'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>),</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  tf.keras.layers.Dropout(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0.2</span><span style=color:#24292e;--shiki-dark:#E1E4E8>),</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  tf.keras.layers.Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>10</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>activation</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'softmax'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>])</span></span>
<span class=line></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>model.compile(</span><span style=color:#e36209;--shiki-dark:#FFAB70>optimizer</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'adam'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>              loss</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'sparse_categorical_crossentropy'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>              metrics</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'accuracy'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>])</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>model.fit(x_train, y_train, </span><span style=color:#e36209;--shiki-dark:#FFAB70>epochs</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>5</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>model.evaluate(x_test,  y_test, </span><span style=color:#e36209;--shiki-dark:#FFAB70>verbose</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>2</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span></code></pre></div><p>产出的结果</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=bash style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 1/5</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>1875/1875</span><span style=color:#24292e;--shiki-dark:#E1E4E8> [==============================] - 3s 2ms/step - loss: 0.2962 - accuracy: 0.9155</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 2/5</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>1875/1875</span><span style=color:#24292e;--shiki-dark:#E1E4E8> [==============================] - 3s 2ms/step - loss: 0.1420 - accuracy: 0.9581</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 3/5</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>1875/1875</span><span style=color:#24292e;--shiki-dark:#E1E4E8> [==============================] - 3s 2ms/step - loss: 0.1064 - accuracy: 0.9672</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 4/5</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>1875/1875</span><span style=color:#24292e;--shiki-dark:#E1E4E8> [==============================] - 3s 2ms/step - loss: 0.0885 - accuracy: 0.9730</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 5/5</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>1875/1875</span><span style=color:#24292e;--shiki-dark:#E1E4E8> [==============================] - 3s 2ms/step - loss: 0.0749 - accuracy: 0.9765</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>313/313</span><span style=color:#032f62;--shiki-dark:#9ECBFF> -</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 0s</span><span style=color:#032f62;--shiki-dark:#9ECBFF> -</span><span style=color:#032f62;--shiki-dark:#9ECBFF> loss:</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 0.0748</span><span style=color:#032f62;--shiki-dark:#9ECBFF> -</span><span style=color:#032f62;--shiki-dark:#9ECBFF> accuracy:</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 0.9778</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>[0.07484959065914154, 0.9778000116348267]</span></span></code></pre></div><p>来看一下这个简单的神经网络的结构</p><p>x_train, x_test = x_train / 255.0, x_test / 255.0 是因为minist这个数据集是0-255的，做了规范化。</p><p>tf.keras.models.Sequential 则是一个计算的连接器，意思就是这个网络由下面这几步骤连接起来，按照顺序进行计算。</p><p>该网络的第一层 <code>tf.keras.layers.Flatten</code> 将图像格式从二维数组（28 x 28 像素）转换成一维数组（28 x 28 = 784 像素）。将该层视为图像中未堆叠的像素行并将其排列起来。该层没有要学习的参数，它只会重新格式化数据</p><p>展平像素后，网络会包括两个 <code>tf.keras.layers.Dense</code> 层的序列。它们是密集连接或全连接神经层。第一个 <code>Dense</code> 层有 128 个节点（或神经元）。第二个（也是最后一个）层会返回一个长度为 10 的 logits 数组。每个节点都包含一个得分，用来表示当前图像属于 10 个类中的哪一类。</p><p>这里面的Dropout则是一个正则化的trick，用来放置过拟合。Dropout的意思是：每次训练时随机忽略一部分神经元，这些神经元dropped-out了。换句话讲，这些神经元在正向传播时对下游的启动影响被忽略，反向传播时也不会更新权重。</p><p>神经网络的所谓“学习”是指，让各个神经元的权重符合需要的特性。不同的神经元组合后可以分辨数据的某个特征。每个神经元的邻居会依赖邻居的行为组成的特征，如果过度依赖，就会造成过拟合。如果每次随机拿走一部分神经元，那么剩下的神经元就需要补上消失神经元的功能，整个网络变成很多独立网络（对同一问题的不同解决方法）的合集。。意思就是在训练完第一个Dense之后，去掉20%的神经元来训练下一个Dense。相当于手动设置了一部分可能出错的神经元，用其他神经元来纠错。</p><p>model.compile(optimizer=‘adam’, loss=‘sparse_categorical_crossentropy’, metrics=[‘accuracy’])</p><p>这个是模型的编译。需要添加三个东西。</p><ul><li><em>损失函数</em> - 用于测量模型在训练期间的准确率。您会希望最小化此函数，以便将模型“引导”到正确的方向上。</li><li><em>优化器</em> - 决定模型如何根据其看到的数据和自身的损失函数进行更新。</li><li><em>指标</em> - 用于监控训练和测试步骤。以下示例使用了<em>准确率</em>，即被正确分类的图像的比率</li></ul><p>损失函数和指标是两个因为目的不同而分开的东西。</p><p>损失函数存在的意义是在优化参数中需要最小化的一个函数，它存在的目的是优化模型的参数，当这个值最小的时候模型最好，一般需要求导或者做gradiant之类的。。而指标则是我们关心的评价。</p><p>举个例子，在回归中，MSE既可以是损失函数也可以是指标，但是R^2就不一定能作为损失函数使用，因为R2越大模型越好。</p><p>在分类问题中，我们可能只关注Accuracy（准确率Precision（精准率）Recall（召回率）ROC-AUC P-R曲线里面的某一项指标，但是这些指标一个可能是算起来困难花费时间，另一个是可能和R2有同样地问题，所以我们用的是交叉熵之类的。</p><p>具体的可以看<a href=https://cloud.tencent.com/developer/article/1165263 rel="nofollow noopener noreferrer external" target=_blank>这里</a></p><p>后面就很熟悉了。唯一一个之前没见过的东西就是 verbose=2</p><ul><li><strong>verbose</strong>: ‘auto’, 0, 1, or 2. Verbosity mode. 0 = silent, 1 = progress bar, 2 = one line per epoch. ‘auto’ defaults to 1 for most cases, but 2 when used with <code>ParameterServerStrategy</code>. Note that the progress bar is not particularly useful when logged to a file, so verbose=2 is recommended when not running interactively (eg, in a production environment).</li></ul><p>所以看一眼输出</p><p>Epoch 5/5 1875/1875 [==============================] - 3s 2ms/step - loss: 0.0749 - accuracy: 0.9765 313/313 - 0s - loss: 0.0748 - accuracy: 0.9778</p><p>这种类似的是因为我们verbose=2之后输出的在训练集上面的结果</p><p>[0.07484959065914154, 0.9778000116348267]这个则是在测试集上面的</p><h1 id=回归>回归<a href=#回归 class=heading-anchor-link aria-label="Link to 回归"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M2.6 21.4c2 2 5.9 2.9 8.9 0l3.5-3.5-1-1-3.5 3.5c-1.4 1.4-4.2 1.9-6.4-.3s-1.8-5-.3-6.4l3.5-3.5-1-1-3.5 3.5c-3 3-2 6.9 0 8.9ZM21.4 2.6c2 2 2.9 5.9 0 8.9L17.9 15l-1-1 3.5-3.5c1.4-1.4 1.9-4.2-.3-6.4s-5-1.8-6.4-.3l-3.5 3.5-1-1 3.5-3.5c3-3 6.9-2 8.9 0Z"></path><path d="m8.01 14.97 6.93-6.93 1.061 1.06-6.93 6.93z"></path></svg></a></h1><p>大部分流程和前面一样，不再具体解释，例子来自于<a href=https://tensorflow.google.cn/tutorials/keras/regression rel="nofollow noopener noreferrer external" target=_blank>这里</a></p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#d73a49;--shiki-dark:#F97583>import</span><span style=color:#24292e;--shiki-dark:#E1E4E8> pathlib</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>import</span><span style=color:#24292e;--shiki-dark:#E1E4E8> matplotlib.pyplot </span><span style=color:#d73a49;--shiki-dark:#F97583>as</span><span style=color:#24292e;--shiki-dark:#E1E4E8> plt</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>import</span><span style=color:#24292e;--shiki-dark:#E1E4E8> pandas </span><span style=color:#d73a49;--shiki-dark:#F97583>as</span><span style=color:#24292e;--shiki-dark:#E1E4E8> pd</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>import</span><span style=color:#24292e;--shiki-dark:#E1E4E8> seaborn </span><span style=color:#d73a49;--shiki-dark:#F97583>as</span><span style=color:#24292e;--shiki-dark:#E1E4E8> sns</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>import</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tensorflow </span><span style=color:#d73a49;--shiki-dark:#F97583>as</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>from</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tensorflow </span><span style=color:#d73a49;--shiki-dark:#F97583>import</span><span style=color:#24292e;--shiki-dark:#E1E4E8> keras</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>from</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tensorflow.keras </span><span style=color:#d73a49;--shiki-dark:#F97583>import</span><span style=color:#24292e;--shiki-dark:#E1E4E8> layers</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>...</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.</span><span style=color:#6a737d;--shiki-dark:#6A737D>#做了一些数据的清洗之后 我直接跳到模型的构建那里</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> build_model</span><span style=color:#24292e;--shiki-dark:#E1E4E8>():</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  model </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> keras.Sequential([</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    layers.Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>64</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>activation</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'relu'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>input_shape</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>len</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(train_dataset.keys())]),</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    layers.Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>64</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>activation</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'relu'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>),</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    layers.Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  ])</span></span>
<span class=line></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  optimizer </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.keras.optimizers.RMSprop(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0.001</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  model.compile(</span><span style=color:#e36209;--shiki-dark:#FFAB70>loss</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'mse'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                optimizer</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>optimizer,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                metrics</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'mae'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#032f62;--shiki-dark:#9ECBFF>'mse'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>])</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>  return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> model</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>model </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> build_model()</span></span></code></pre></div><p>因为输出的是单独一个值，所以最后一层只有一个神经元。这个build model相当于一个生成model的函数。</p><p>在生成完模型之后可以看一下模型的简单描述</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>model.summary()</span></span>
<span class=line></span></code></pre></div><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=bash style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Model:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> "sequential"</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>_________________________________________________________________</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Layer</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (type)                 Output Shape              Param </span><span style=color:#6a737d;--shiki-dark:#6A737D>#   </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>=================================================================</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>dense</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (Dense)                (</span><span style=color:#6f42c1;--shiki-dark:#B392F0>None,</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 64</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)                640       </span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>_________________________________________________________________</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>dense_1</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (Dense)              (</span><span style=color:#6f42c1;--shiki-dark:#B392F0>None,</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 64</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)                4160      </span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>_________________________________________________________________</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>dense_2</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (Dense)              (</span><span style=color:#6f42c1;--shiki-dark:#B392F0>None,</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)                 65        </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>=================================================================</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Total</span><span style=color:#032f62;--shiki-dark:#9ECBFF> params:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 4,865</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Trainable</span><span style=color:#032f62;--shiki-dark:#9ECBFF> params:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 4,865</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Non-trainable</span><span style=color:#032f62;--shiki-dark:#9ECBFF> params:</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 0</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>_________________________________________________________________</span></span></code></pre></div><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># 通过为每个完成的时期打印一个点来显示训练进度</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>class</span><span style=color:#6f42c1;--shiki-dark:#B392F0> PrintDot</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#6f42c1;--shiki-dark:#B392F0>keras</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.</span><span style=color:#6f42c1;--shiki-dark:#B392F0>callbacks</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.</span><span style=color:#6f42c1;--shiki-dark:#B392F0>Callback</span><span style=color:#24292e;--shiki-dark:#E1E4E8>):</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>  def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> on_epoch_end</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, epoch, logs):</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    if</span><span style=color:#24292e;--shiki-dark:#E1E4E8> epoch </span><span style=color:#d73a49;--shiki-dark:#F97583>%</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 100</span><span style=color:#d73a49;--shiki-dark:#F97583> ==</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>: </span><span style=color:#005cc5;--shiki-dark:#79B8FF>print</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>''</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>    print</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'.'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>end</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>''</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>EPOCHS</span><span style=color:#d73a49;--shiki-dark:#F97583> =</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 1000</span></span>
<span class=line></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>history </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> model.fit(</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  normed_train_data, train_labels,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>  epochs</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>EPOCHS</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>validation_split</span><span style=color:#d73a49;--shiki-dark:#F97583> =</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 0.2</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>verbose</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>  callbacks</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>[PrintDot()])</span></span></code></pre></div><p><a href=https://www.tensorflow.org/api_docs/python/tf/keras/callbacks/Callback rel="nofollow noopener noreferrer external" target=_blank>callbacks</a>是每个epochs结束的时候执行的函数。</p><p>validation则是搞一个交叉验证。</p><p>history对象则可以可视化模型的训练进度。</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#d73a49;--shiki-dark:#F97583>def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> plot_history</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(history):</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  hist </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> pd.DataFrame(history.history)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  hist[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'epoch'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>] </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> history.epoch</span></span>
<span class=line></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  plt.figure()</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  plt.xlabel(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Epoch'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  plt.ylabel(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Mean Abs Error [MPG]'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  plt.plot(hist[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'epoch'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>], hist[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'mae'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>],</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>           label</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Train Error'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  plt.plot(hist[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'epoch'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>], hist[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'val_mae'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>],</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>           label</span><span style=color:#d73a49;--shiki-dark:#F97583> =</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 'Val Error'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  plt.ylim([</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>5</span><span style=color:#24292e;--shiki-dark:#E1E4E8>])</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  plt.legend()</span></span>
<span class=line></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  plt.figure()</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  plt.xlabel(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Epoch'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  plt.ylabel(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Mean Square Error [$MPG^2$]'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  plt.plot(hist[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'epoch'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>], hist[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'mse'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>],</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>           label</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Train Error'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  plt.plot(hist[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'epoch'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>], hist[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'val_mse'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>],</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>           label</span><span style=color:#d73a49;--shiki-dark:#F97583> =</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 'Val Error'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  plt.ylim([</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>20</span><span style=color:#24292e;--shiki-dark:#E1E4E8>])</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  plt.legend()</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  plt.show()</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>plot_history(history)</span></span></code></pre></div><figure><img alt=png src=https://raw.githubusercontent.com/lifeodyssey/Figurebed/master/image.202202211438886.png><figcaption>png</figcaption></figure><figure><img alt=png src=https://raw.githubusercontent.com/lifeodyssey/Figurebed/master/image.202202211439263.png><figcaption>png</figcaption></figure><p>该图表显示在约100个 epochs 之后误差非但没有改进，反而出现恶化。 让我们更新 <code>model.fit</code> 调用，当验证值没有提高上是自动停止训练。 我们将使用一个 <em>EarlyStopping callback</em> 来测试每个 epoch 的训练条件。如果经过一定数量的 epochs 后没有改进，则自动停止训练。</p><p>你可以从<a href=https://tensorflow.google.cn/versions/master/api_docs/python/tf/keras/callbacks/EarlyStopping rel="nofollow noopener noreferrer external" target=_blank>这里</a>学习到更多的回调。</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>model </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> build_model()</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># patience 值用来检查改进 epochs 的数量</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>early_stop </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> keras.callbacks.EarlyStopping(</span><span style=color:#e36209;--shiki-dark:#FFAB70>monitor</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'val_loss'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>patience</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>10</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>#即如果在10个训练后没有改进，就停止</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>history </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> model.fit(normed_train_data, train_labels, </span><span style=color:#e36209;--shiki-dark:#FFAB70>epochs</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>EPOCHS</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                    validation_split</span><span style=color:#d73a49;--shiki-dark:#F97583> =</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 0.2</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>verbose</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>callbacks</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>[early_stop, PrintDot()])</span></span>
<span class=line></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>plot_history(history)</span></span></code></pre></div><h1 id=过拟合和欠拟合>过拟合和欠拟合<a href=#过拟合和欠拟合 class=heading-anchor-link aria-label="Link to 过拟合和欠拟合"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M2.6 21.4c2 2 5.9 2.9 8.9 0l3.5-3.5-1-1-3.5 3.5c-1.4 1.4-4.2 1.9-6.4-.3s-1.8-5-.3-6.4l3.5-3.5-1-1-3.5 3.5c-3 3-2 6.9 0 8.9ZM21.4 2.6c2 2 2.9 5.9 0 8.9L17.9 15l-1-1 3.5-3.5c1.4-1.4 1.9-4.2-.3-6.4s-5-1.8-6.4-.3l-3.5 3.5-1-1 3.5-3.5c3-3 6.9-2 8.9 0Z"></path><path d="m8.01 14.97 6.93-6.93 1.061 1.06-6.93 6.93z"></path></svg></a></h1><p><a href=https://tensorflow.google.cn/tutorials/keras/overfit_and_underfit rel="nofollow noopener noreferrer external" target=_blank>这一节</a>开始就是英语了</p><p>依然是省略了一些前期处理</p><p>防止过度拟合的最简单方法是以一个小模型开始。一个具有少量可学习参数的模型（由层数和每层的单元数决定）。在深度学习中，一个模型中的可学习参数的数量通常被称为模型的 “容量”。</p><p>直观地说，一个拥有更多参数的模型将拥有更多的 “记忆能力”，因此能够轻易地在训练样本和它们的目标之间学习一个完美的类似字典的映射，这种映射没有任何泛化能力，但在对以前未见过的数据进行预测时，这将毫无用处。</p><p>永远记住这一点：深度学习模型往往善于拟合训练数据，但真正的挑战是泛化，而不是拟合。</p><p>另一方面，如果网络的记忆资源有限，它将无法轻易学习映射。为了使其损失最小化，它将不得不学习具有更多预测能力的压缩表征。同时，如果你让你的模型太小，它将难以适应训练数据。在 “容量太大 “和 “容量不足 “之间存在着一种平衡。</p><p>不幸的是，没有神奇的公式来确定你的模型的正确大小或架构（就层数而言，或每层的正确大小）。你将不得不使用一系列不同的架构进行试验。</p><p>为了找到一个合适的模型大小，最好从相对较少的层和参数开始，然后开始增加层的大小或增加新的层，直到你看到验证损失的回报递减。</p><p>接下来将从一个只使用密集连接层（tf.keras.layer.Dense）的简单模型开始作为基线，然后创建更大的模型，并进行比较。</p><h2 id=训练过程>训练过程<a href=#训练过程 class=heading-anchor-link aria-label="Link to 训练过程"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M2.6 21.4c2 2 5.9 2.9 8.9 0l3.5-3.5-1-1-3.5 3.5c-1.4 1.4-4.2 1.9-6.4-.3s-1.8-5-.3-6.4l3.5-3.5-1-1-3.5 3.5c-3 3-2 6.9 0 8.9ZM21.4 2.6c2 2 2.9 5.9 0 8.9L17.9 15l-1-1 3.5-3.5c1.4-1.4 1.9-4.2-.3-6.4s-5-1.8-6.4-.3l-3.5 3.5-1-1 3.5-3.5c3-3 6.9-2 8.9 0Z"></path><path d="m8.01 14.97 6.93-6.93 1.061 1.06-6.93 6.93z"></path></svg></a></h2><p>一般来说学习率越小效果越好,这个不难理解，我们可以利用<a href=https://tensorflow.google.cn/api_docs/python/tf/keras/optimizers/schedules rel="nofollow noopener noreferrer external" target=_blank><code>tf.keras.optimizers.schedules</code></a>来随着时间减少学习率</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>lr_schedule </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.keras.optimizers.schedules.InverseTimeDecay(</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>  0.001</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>  decay_steps</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>STEPS_PER_EPOCH</span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1000</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>  decay_rate</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>  staircase</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>False</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> get_optimizer</span><span style=color:#24292e;--shiki-dark:#E1E4E8>():</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>  return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.keras.optimizers.Adam(lr_schedule)</span></span></code></pre></div><p>这个函数会双曲线的来减少学习率，比如，第1000epochs会降低到一半，两千会到1/3。具体的公式是</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>tf.keras.optimizers.schedules.InverseTimeDecay(</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    initial_learning_rate, decay_steps, decay_rate, </span><span style=color:#e36209;--shiki-dark:#FFAB70>staircase</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>False</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>name</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>None</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span><span style=color:#6a737d;--shiki-dark:#6A737D>#这是参数</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>#这是默认的函数（staircase=False）</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> decayed_learning_rate</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(step):</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>  return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> initial_learning_rate </span><span style=color:#d73a49;--shiki-dark:#F97583>/</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#d73a49;--shiki-dark:#F97583> +</span><span style=color:#24292e;--shiki-dark:#E1E4E8> decay_rate </span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#24292e;--shiki-dark:#E1E4E8> step </span><span style=color:#d73a49;--shiki-dark:#F97583>/</span><span style=color:#24292e;--shiki-dark:#E1E4E8> decay_step)</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>  #这是另一个函数（staircase=True）</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> decayed_learning_rate</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(step):</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>  return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> initial_learning_rate </span><span style=color:#d73a49;--shiki-dark:#F97583>/</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#d73a49;--shiki-dark:#F97583> +</span><span style=color:#24292e;--shiki-dark:#E1E4E8> decay_rate </span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#24292e;--shiki-dark:#E1E4E8> floor(step </span><span style=color:#d73a49;--shiki-dark:#F97583>/</span><span style=color:#24292e;--shiki-dark:#E1E4E8> decay_step))</span></span></code></pre></div><p>下一步则是加入<a href=https://www.tensorflow.org/api_docs/python/tf/keras/callbacks/EarlyStopping rel="nofollow noopener noreferrer external" target=_blank><code>tf.keras.callbacks.EarlyStopping</code></a>来避免训练太久。</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#d73a49;--shiki-dark:#F97583>def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> get_callbacks</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(name):</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>  return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> [</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    tfdocs.modeling.EpochDots(),</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    tf.keras.callbacks.EarlyStopping(</span><span style=color:#e36209;--shiki-dark:#FFAB70>monitor</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'val_binary_crossentropy'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>patience</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>200</span><span style=color:#24292e;--shiki-dark:#E1E4E8>),</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    tf.keras.callbacks.TensorBoard(logdir</span><span style=color:#d73a49;--shiki-dark:#F97583>/</span><span style=color:#24292e;--shiki-dark:#E1E4E8>name),</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  ]</span></span></code></pre></div><p>这里EarlyStopping关注的是val_binary_crossentropy，而不是val_loss，区别在后面会讲到。</p><p>tf.keras.callbacks.TensorBoard则会直接显示一些定义好的metrics给你看，就像这样，具体的等后面看一下。</p><figure><img alt="How to use Keras TensorBoard callback for grid search - Stack Overflow" src=https://raw.githubusercontent.com/lifeodyssey/Figurebed/master/image.202202211439787.png><figcaption>How to use Keras TensorBoard callback for grid search - Stack Overflow</figcaption></figure><p>然后利用Model.compile和Model.fit来构建一个网络。</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#d73a49;--shiki-dark:#F97583>def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> compile_and_fit</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(model, name, optimizer</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>None</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, max_epochs</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>10000</span><span style=color:#24292e;--shiki-dark:#E1E4E8>):</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>  if</span><span style=color:#24292e;--shiki-dark:#E1E4E8> optimizer </span><span style=color:#d73a49;--shiki-dark:#F97583>is</span><span style=color:#005cc5;--shiki-dark:#79B8FF> None</span><span style=color:#24292e;--shiki-dark:#E1E4E8>:</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    optimizer </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> get_optimizer()</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  model.compile(</span><span style=color:#e36209;--shiki-dark:#FFAB70>optimizer</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>optimizer,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                loss</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>tf.keras.losses.BinaryCrossentropy(</span><span style=color:#e36209;--shiki-dark:#FFAB70>from_logits</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>True</span><span style=color:#24292e;--shiki-dark:#E1E4E8>),</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                metrics</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>[</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>                  tf.keras.losses.BinaryCrossentropy(</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                      from_logits</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>True</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>name</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'binary_crossentropy'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>),</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>                  'accuracy'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>])</span></span>
<span class=line></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  model.summary()</span></span>
<span class=line></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  history </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> model.fit(</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    train_ds,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>    steps_per_epoch</span><span style=color:#d73a49;--shiki-dark:#F97583> =</span><span style=color:#005cc5;--shiki-dark:#79B8FF> STEPS_PER_EPOCH</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>    epochs</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>max_epochs,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>    validation_data</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>validate_ds,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>    callbacks</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>get_callbacks(name),</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>    verbose</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>  return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> history</span></span></code></pre></div><p>我们从一个小模型来开始训练</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>tiny_model </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.keras.Sequential([</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    layers.Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>16</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>activation</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'elu'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>input_shape</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>FEATURES</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,)),</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    layers.Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>])</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>size_histories </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> {}</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>size_histories[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Tiny'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>] </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> compile_and_fit(tiny_model, </span><span style=color:#032f62;--shiki-dark:#9ECBFF>'sizes/Tiny'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span></code></pre></div><p>输出为</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=bash style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Model:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> "sequential"</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>_________________________________________________________________</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0> Layer</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (type)                Output Shape              Param </span><span style=color:#6a737d;--shiki-dark:#6A737D>#   </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>=================================================================</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0> dense</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (Dense)               (</span><span style=color:#6f42c1;--shiki-dark:#B392F0>None,</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 16</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)                464       </span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>                                                                 </span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0> dense_1</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (Dense)             (</span><span style=color:#6f42c1;--shiki-dark:#B392F0>None,</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)                 17        </span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>                                                                 </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>=================================================================</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Total</span><span style=color:#032f62;--shiki-dark:#9ECBFF> params:</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 481</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Trainable</span><span style=color:#032f62;--shiki-dark:#9ECBFF> params:</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 481</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Non-trainable</span><span style=color:#032f62;--shiki-dark:#9ECBFF> params:</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 0</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>_________________________________________________________________</span></span>
<span class=line></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 0,</span><span style=color:#032f62;--shiki-dark:#9ECBFF> accuracy:0.4896,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  binary_crossentropy:0.8395,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  loss:0.8395,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_accuracy:0.5070,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_binary_crossentropy:0.7700,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_loss:0.7700,</span><span style=color:#24292e;--shiki-dark:#E1E4E8>  </span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>....................................................................................................</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 100,</span><span style=color:#032f62;--shiki-dark:#9ECBFF> accuracy:0.6016,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  binary_crossentropy:0.6240,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  loss:0.6240,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_accuracy:0.5910,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_binary_crossentropy:0.6256,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_loss:0.6256,</span><span style=color:#24292e;--shiki-dark:#E1E4E8>  </span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>....................................................................................................</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 200,</span><span style=color:#032f62;--shiki-dark:#9ECBFF> accuracy:0.6269,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  binary_crossentropy:0.6103,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  loss:0.6103,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_accuracy:0.6110,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_binary_crossentropy:0.6151,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_loss:0.6151,</span><span style=color:#24292e;--shiki-dark:#E1E4E8>  </span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>....................................................................................................</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 300,</span><span style=color:#032f62;--shiki-dark:#9ECBFF> accuracy:0.6484,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  binary_crossentropy:0.5984,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  loss:0.5984,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_accuracy:0.6340,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_binary_crossentropy:0.6038,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_loss:0.6038,</span><span style=color:#24292e;--shiki-dark:#E1E4E8>  </span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>....................................................................................................</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 400,</span><span style=color:#032f62;--shiki-dark:#9ECBFF> accuracy:0.6584,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  binary_crossentropy:0.5905,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  loss:0.5905,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_accuracy:0.6340,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_binary_crossentropy:0.5993,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_loss:0.5993,</span><span style=color:#24292e;--shiki-dark:#E1E4E8>  </span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>....................................................................................................</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 500,</span><span style=color:#032f62;--shiki-dark:#9ECBFF> accuracy:0.6694,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  binary_crossentropy:0.5860,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  loss:0.5860,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_accuracy:0.6410,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_binary_crossentropy:0.5979,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_loss:0.5979,</span><span style=color:#24292e;--shiki-dark:#E1E4E8>  </span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>....................................................................................................</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 600,</span><span style=color:#032f62;--shiki-dark:#9ECBFF> accuracy:0.6684,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  binary_crossentropy:0.5831,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  loss:0.5831,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_accuracy:0.6550,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_binary_crossentropy:0.5960,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_loss:0.5960,</span><span style=color:#24292e;--shiki-dark:#E1E4E8>  </span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>....................................................................................................</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 700,</span><span style=color:#032f62;--shiki-dark:#9ECBFF> accuracy:0.6748,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  binary_crossentropy:0.5810,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  loss:0.5810,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_accuracy:0.6510,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_binary_crossentropy:0.5967,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_loss:0.5967,</span><span style=color:#24292e;--shiki-dark:#E1E4E8>  </span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>....................................................................................................</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 800,</span><span style=color:#032f62;--shiki-dark:#9ECBFF> accuracy:0.6707,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  binary_crossentropy:0.5795,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  loss:0.5795,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_accuracy:0.6580,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_binary_crossentropy:0.5965,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_loss:0.5965,</span><span style=color:#24292e;--shiki-dark:#E1E4E8>  </span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>...........................</span></span></code></pre></div><p>我们来画一下train test plot</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>plotter </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tfdocs.plots.HistoryPlotter(</span><span style=color:#e36209;--shiki-dark:#FFAB70>metric</span><span style=color:#d73a49;--shiki-dark:#F97583> =</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 'binary_crossentropy'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>smoothing_std</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>10</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>plotter.plot(size_histories)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>plt.ylim([</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0.5</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>0.7</span><span style=color:#24292e;--shiki-dark:#E1E4E8>])</span></span></code></pre></div><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=bash style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#6f42c1;--shiki-dark:#B392F0>0.5,</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 0.7</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span></code></pre></div><figure><img alt=png src=https://raw.githubusercontent.com/lifeodyssey/Figurebed/master/image.202202211439438.png><figcaption>png</figcaption></figure><p>接着我们来换一个更大一点的模型来看看会不会好一点</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>small_model </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.keras.Sequential([</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>    # `input_shape` is only required here so that `.summary` works.</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    layers.Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>16</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>activation</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'elu'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>input_shape</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>FEATURES</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,)),</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    layers.Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>16</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>activation</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'elu'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>),</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    layers.Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>])</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>size_histories[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Small'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>] </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> compile_and_fit(small_model, </span><span style=color:#032f62;--shiki-dark:#9ECBFF>'sizes/Small'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span></code></pre></div><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=bash style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Model:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> "sequential_1"</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>_________________________________________________________________</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0> Layer</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (type)                Output Shape              Param </span><span style=color:#6a737d;--shiki-dark:#6A737D>#   </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>=================================================================</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0> dense_2</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (Dense)             (</span><span style=color:#6f42c1;--shiki-dark:#B392F0>None,</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 16</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)                464       </span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>                                                                 </span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0> dense_3</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (Dense)             (</span><span style=color:#6f42c1;--shiki-dark:#B392F0>None,</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 16</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)                272       </span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>                                                                 </span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0> dense_4</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (Dense)             (</span><span style=color:#6f42c1;--shiki-dark:#B392F0>None,</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)                 17        </span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>                                                                 </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>=================================================================</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Total</span><span style=color:#032f62;--shiki-dark:#9ECBFF> params:</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 753</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Trainable</span><span style=color:#032f62;--shiki-dark:#9ECBFF> params:</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 753</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Non-trainable</span><span style=color:#032f62;--shiki-dark:#9ECBFF> params:</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 0</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>_________________________________________________________________</span></span>
<span class=line></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 0,</span><span style=color:#032f62;--shiki-dark:#9ECBFF> accuracy:0.4877,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  binary_crossentropy:0.7209,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  loss:0.7209,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_accuracy:0.4860,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_binary_crossentropy:0.7025,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_loss:0.7025,</span><span style=color:#24292e;--shiki-dark:#E1E4E8>  </span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>....................................................................................................</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 100,</span><span style=color:#032f62;--shiki-dark:#9ECBFF> accuracy:0.6212,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  binary_crossentropy:0.6148,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  loss:0.6148,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_accuracy:0.6200,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_binary_crossentropy:0.6184,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_loss:0.6184,</span><span style=color:#24292e;--shiki-dark:#E1E4E8>  </span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>....................................................................................................</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 200,</span><span style=color:#032f62;--shiki-dark:#9ECBFF> accuracy:0.6657,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  binary_crossentropy:0.5853,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  loss:0.5853,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_accuracy:0.6570,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_binary_crossentropy:0.5949,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_loss:0.5949,</span><span style=color:#24292e;--shiki-dark:#E1E4E8>  </span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>....................................................................................................</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 300,</span><span style=color:#032f62;--shiki-dark:#9ECBFF> accuracy:0.6774,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  binary_crossentropy:0.5750,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  loss:0.5750,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_accuracy:0.6720,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_binary_crossentropy:0.5868,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_loss:0.5868,</span><span style=color:#24292e;--shiki-dark:#E1E4E8>  </span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>....................................................................................................</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 400,</span><span style=color:#032f62;--shiki-dark:#9ECBFF> accuracy:0.6838,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  binary_crossentropy:0.5683,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  loss:0.5683,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_accuracy:0.6760,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_binary_crossentropy:0.5859,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_loss:0.5859,</span><span style=color:#24292e;--shiki-dark:#E1E4E8>  </span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>....................................................................................................</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 500,</span><span style=color:#032f62;--shiki-dark:#9ECBFF> accuracy:0.6897,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  binary_crossentropy:0.5632,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  loss:0.5632,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_accuracy:0.6720,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_binary_crossentropy:0.5863,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_loss:0.5863,</span><span style=color:#24292e;--shiki-dark:#E1E4E8>  </span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>....................................................................................................</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 600,</span><span style=color:#032f62;--shiki-dark:#9ECBFF> accuracy:0.6946,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  binary_crossentropy:0.5593,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  loss:0.5593,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_accuracy:0.6670,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_binary_crossentropy:0.5883,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_loss:0.5883,</span><span style=color:#24292e;--shiki-dark:#E1E4E8>  </span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>....................................................................................................</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 700,</span><span style=color:#032f62;--shiki-dark:#9ECBFF> accuracy:0.6963,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  binary_crossentropy:0.5558,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  loss:0.5558,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_accuracy:0.6730,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_binary_crossentropy:0.5869,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_loss:0.5869,</span><span style=color:#24292e;--shiki-dark:#E1E4E8>  </span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>....................................................................................................</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>Epoch:</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 800,</span><span style=color:#032f62;--shiki-dark:#9ECBFF> accuracy:0.7006,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  binary_crossentropy:0.5531,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  loss:0.5531,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_accuracy:0.6620,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_binary_crossentropy:0.5894,</span><span style=color:#032f62;--shiki-dark:#9ECBFF>  val_loss:0.5894,</span><span style=color:#24292e;--shiki-dark:#E1E4E8>  </span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>.........................</span></span></code></pre></div><p>他还尝试了大的 更大的 最大的 来看Loss的图</p><figure><img alt=png src=https://raw.githubusercontent.com/lifeodyssey/Figurebed/master/image.202202211851159.png><figcaption>png</figcaption></figure><p>在notebook里面可以查看TensorBoard</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>#docs_infra: no_execute</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Load the TensorBoard notebook extension</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>%</span><span style=color:#24292e;--shiki-dark:#E1E4E8>load_ext tensorboard</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Open an embedded TensorBoard viewer</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>%</span><span style=color:#24292e;--shiki-dark:#E1E4E8>tensorboard </span><span style=color:#b31d28;--shiki-light-font-style:italic;--shiki-dark:#FDAEB7;--shiki-dark-font-style:italic>--</span><span style=color:#24292e;--shiki-dark:#E1E4E8>logdir {logdir}</span><span style=color:#d73a49;--shiki-dark:#F97583>/</span><span style=color:#24292e;--shiki-dark:#E1E4E8>sizes</span></span>
<span class=line></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>display.IFrame(</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>    src</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"https://tensorboard.dev/experiment/vW7jmmF9TmKmy3rbheMQpw/#scalars&#x26;_smoothingWeight=0.97"</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>    width</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"100%"</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>height</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"800px"</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span></code></pre></div><p>具体效果看着挺不错的，不放图了。</p><h2 id=保存和恢复模型>保存和恢复模型<a href=#保存和恢复模型 class=heading-anchor-link aria-label="Link to 保存和恢复模型"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M2.6 21.4c2 2 5.9 2.9 8.9 0l3.5-3.5-1-1-3.5 3.5c-1.4 1.4-4.2 1.9-6.4-.3s-1.8-5-.3-6.4l3.5-3.5-1-1-3.5 3.5c-3 3-2 6.9 0 8.9ZM21.4 2.6c2 2 2.9 5.9 0 8.9L17.9 15l-1-1 3.5-3.5c1.4-1.4 1.9-4.2-.3-6.4s-5-1.8-6.4-.3l-3.5 3.5-1-1 3.5-3.5c3-3 6.9-2 8.9 0Z"></path><path d="m8.01 14.97 6.93-6.93 1.061 1.06-6.93 6.93z"></path></svg></a></h2><p>我去 居然是拿hdf5格式保存的 怪不得 OC-SMART是这个格式</p><p>那或许我可以试着读取一下</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>pip install pyyaml h5py  </span><span style=color:#6a737d;--shiki-dark:#6A737D># Required to save models in HDF5 format</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>import</span><span style=color:#24292e;--shiki-dark:#E1E4E8> os</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>import</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tensorflow </span><span style=color:#d73a49;--shiki-dark:#F97583>as</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>from</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tensorflow </span><span style=color:#d73a49;--shiki-dark:#F97583>import</span><span style=color:#24292e;--shiki-dark:#E1E4E8> keras</span></span>
<span class=line></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>print</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(tf.version.</span><span style=color:#005cc5;--shiki-dark:#79B8FF>VERSION</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>#省略一部分</span></span>
<span class=line></span></code></pre></div><p>在训练期间保存模型的话，用的是tf.keras.callbacks.ModelCheckpoint</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>checkpoint_path </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF> "training_1/cp.ckpt"</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>checkpoint_dir </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> os.path.dirname(checkpoint_path)</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Create a callback that saves the model's weights</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>cp_callback </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.keras.callbacks.ModelCheckpoint(</span><span style=color:#e36209;--shiki-dark:#FFAB70>filepath</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>checkpoint_path,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                                                 save_weights_only</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>True</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                                                 verbose</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Train the model with the new callback</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>model.fit(train_images, </span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>          train_labels,  </span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>          epochs</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>10</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>          validation_data</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(test_images, test_labels),</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>          callbacks</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>[cp_callback])  </span><span style=color:#6a737d;--shiki-dark:#6A737D># Pass callback to training</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># This may generate warnings related to saving the state of the optimizer.</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># These warnings (and similar warnings throughout this notebook)</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># are in place to discourage outdated usage, and can be ignored.</span></span></code></pre></div><p>这将创建一个 TensorFlow checkpoint 文件集合，这些文件在每个 epoch 结束时更新.</p><p>只要两个模型共享相同的架构，您就可以在它们之间共享权重。因此，当从仅权重恢复模型时，创建一个与原始模型具有相同架构的模型，然后设置其权重。</p><p>读取的方式则是</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Create a basic model instance</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>model </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> create_model()</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Evaluate the model</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>loss, acc </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> model.evaluate(test_images, test_labels, </span><span style=color:#e36209;--shiki-dark:#FFAB70>verbose</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>2</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>print</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"Untrained model, accuracy: </span><span style=color:#005cc5;--shiki-dark:#79B8FF>{</span><span style=color:#d73a49;--shiki-dark:#F97583>:5.2f</span><span style=color:#005cc5;--shiki-dark:#79B8FF>}</span><span style=color:#032f62;--shiki-dark:#9ECBFF>%"</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.format(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>100</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#24292e;--shiki-dark:#E1E4E8> acc))</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Loads the weights</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>model.load_weights(checkpoint_path)</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Re-evaluate the model</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>loss, acc </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> model.evaluate(test_images, test_labels, </span><span style=color:#e36209;--shiki-dark:#FFAB70>verbose</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>2</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>print</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"Restored model, accuracy: </span><span style=color:#005cc5;--shiki-dark:#79B8FF>{</span><span style=color:#d73a49;--shiki-dark:#F97583>:5.2f</span><span style=color:#005cc5;--shiki-dark:#79B8FF>}</span><span style=color:#032f62;--shiki-dark:#9ECBFF>%"</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.format(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>100</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#24292e;--shiki-dark:#E1E4E8> acc))</span></span></code></pre></div><h3 id=checkpoint-回调选项>checkpoint 回调选项<a href=#checkpoint-回调选项 class=heading-anchor-link aria-label="Link to checkpoint 回调选项"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M2.6 21.4c2 2 5.9 2.9 8.9 0l3.5-3.5-1-1-3.5 3.5c-1.4 1.4-4.2 1.9-6.4-.3s-1.8-5-.3-6.4l3.5-3.5-1-1-3.5 3.5c-3 3-2 6.9 0 8.9ZM21.4 2.6c2 2 2.9 5.9 0 8.9L17.9 15l-1-1 3.5-3.5c1.4-1.4 1.9-4.2-.3-6.4s-5-1.8-6.4-.3l-3.5 3.5-1-1 3.5-3.5c3-3 6.9-2 8.9 0Z"></path><path d="m8.01 14.97 6.93-6.93 1.061 1.06-6.93 6.93z"></path></svg></a></h3><p>回调提供了几个选项，为 checkpoint 提供唯一名称并调整 checkpoint 频率。</p><p>训练一个新模型，每五个 epochs 保存一次唯一命名的 checkpoint ：</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Include the epoch in the file name (uses `str.format`)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>checkpoint_path </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF> "training_2/cp-</span><span style=color:#005cc5;--shiki-dark:#79B8FF>{epoch</span><span style=color:#d73a49;--shiki-dark:#F97583>:04d</span><span style=color:#005cc5;--shiki-dark:#79B8FF>}</span><span style=color:#032f62;--shiki-dark:#9ECBFF>.ckpt"</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>checkpoint_dir </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> os.path.dirname(checkpoint_path)</span></span>
<span class=line></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>batch_size </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 32</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Create a callback that saves the model's weights every 5 epochs</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>cp_callback </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.keras.callbacks.ModelCheckpoint(</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>    filepath</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>checkpoint_path, </span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>    verbose</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>    save_weights_only</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>True</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>    save_freq</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>5</span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#24292e;--shiki-dark:#E1E4E8>batch_size)</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Create a new model instance</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>model </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> create_model()</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Save the weights using the `checkpoint_path` format</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>model.save_weights(checkpoint_path.format(</span><span style=color:#e36209;--shiki-dark:#FFAB70>epoch</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>))</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Train the model with the new callback</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>model.fit(train_images, </span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>          train_labels,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>          epochs</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>50</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>          batch_size</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>batch_size, </span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>          callbacks</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>[cp_callback],</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>          validation_data</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(test_images, test_labels),</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>          verbose</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span></code></pre></div><h2 id=手动保存权重>手动保存权重<a href=#手动保存权重 class=heading-anchor-link aria-label="Link to 手动保存权重"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M2.6 21.4c2 2 5.9 2.9 8.9 0l3.5-3.5-1-1-3.5 3.5c-1.4 1.4-4.2 1.9-6.4-.3s-1.8-5-.3-6.4l3.5-3.5-1-1-3.5 3.5c-3 3-2 6.9 0 8.9ZM21.4 2.6c2 2 2.9 5.9 0 8.9L17.9 15l-1-1 3.5-3.5c1.4-1.4 1.9-4.2-.3-6.4s-5-1.8-6.4-.3l-3.5 3.5-1-1 3.5-3.5c3-3 6.9-2 8.9 0Z"></path><path d="m8.01 14.97 6.93-6.93 1.061 1.06-6.93 6.93z"></path></svg></a></h2><p>使用 <code>Model.save_weights</code> 方法手动保存权重。默认情况下，<code>tf.keras</code>（尤其是 <code>save_weights</code>）使用扩展名为 <code>.ckpt</code> 的 TensorFlow <a href="https://www.tensorflow.org/guide/checkpoint?hl=zh_cn" rel="nofollow noopener noreferrer external" target=_blank>检查点</a>格式（保存在扩展名为 <code>.h5</code> 的 <a href="https://js.tensorflow.org/tutorials/import-keras.html?hl=zh_cn" rel="nofollow noopener noreferrer external" target=_blank>HDF5</a> 中，<a href="https://www.tensorflow.org/guide/keras/save_and_serialize?hl=zh_cn#weights-only_saving_in_savedmodel_format" rel="nofollow noopener noreferrer external" target=_blank>保存和序列化模型</a>指南中会讲到这一点）：</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Save the weights</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>model.save_weights(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'./checkpoints/my_checkpoint'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Create a new model instance</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>model </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> create_model()</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Restore the weights</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>model.load_weights(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'./checkpoints/my_checkpoint'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Evaluate the model</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>loss, acc </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> model.evaluate(test_images, test_labels, </span><span style=color:#e36209;--shiki-dark:#FFAB70>verbose</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>2</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>print</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"Restored model, accuracy: </span><span style=color:#005cc5;--shiki-dark:#79B8FF>{</span><span style=color:#d73a49;--shiki-dark:#F97583>:5.2f</span><span style=color:#005cc5;--shiki-dark:#79B8FF>}</span><span style=color:#032f62;--shiki-dark:#9ECBFF>%"</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.format(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>100</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#24292e;--shiki-dark:#E1E4E8> acc))</span></span></code></pre></div><h3 id=hdf5-格式>HDF5 格式<a href=#hdf5-格式 class=heading-anchor-link aria-label="Link to HDF5 格式"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M2.6 21.4c2 2 5.9 2.9 8.9 0l3.5-3.5-1-1-3.5 3.5c-1.4 1.4-4.2 1.9-6.4-.3s-1.8-5-.3-6.4l3.5-3.5-1-1-3.5 3.5c-3 3-2 6.9 0 8.9ZM21.4 2.6c2 2 2.9 5.9 0 8.9L17.9 15l-1-1 3.5-3.5c1.4-1.4 1.9-4.2-.3-6.4s-5-1.8-6.4-.3l-3.5 3.5-1-1 3.5-3.5c3-3 6.9-2 8.9 0Z"></path><path d="m8.01 14.97 6.93-6.93 1.061 1.06-6.93 6.93z"></path></svg></a></h3><p>Keras使用 <a href=https://en.wikipedia.org/wiki/Hierarchical_Data_Format rel="nofollow noopener noreferrer external" target=_blank>HDF5</a> 标准提供了一种基本的保存格式。</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Create and train a new model instance.</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>model </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> create_model()</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>model.fit(train_images, train_labels, </span><span style=color:#e36209;--shiki-dark:#FFAB70>epochs</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>5</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Save the entire model to a HDF5 file.</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># The '.h5' extension indicates that the model should be saved to HDF5.</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>model.save(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'my_model.h5'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span></code></pre></div><p>现在，从该文件重新创建模型：</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Recreate the exact same model, including its weights and the optimizer</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>new_model </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.keras.models.load_model(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'my_model.h5'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Show the model architecture</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>new_model.summary()</span></span></code></pre></div><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>loss, acc </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> new_model.evaluate(test_images, test_labels, </span><span style=color:#e36209;--shiki-dark:#FFAB70>verbose</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>2</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>print</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Restored model, accuracy: </span><span style=color:#005cc5;--shiki-dark:#79B8FF>{</span><span style=color:#d73a49;--shiki-dark:#F97583>:5.2f</span><span style=color:#005cc5;--shiki-dark:#79B8FF>}</span><span style=color:#032f62;--shiki-dark:#9ECBFF>%'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.format(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>100</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#24292e;--shiki-dark:#E1E4E8> acc))</span></span></code></pre></div><h4 id=限制>限制<a href=#限制 class=heading-anchor-link aria-label="Link to 限制"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M2.6 21.4c2 2 5.9 2.9 8.9 0l3.5-3.5-1-1-3.5 3.5c-1.4 1.4-4.2 1.9-6.4-.3s-1.8-5-.3-6.4l3.5-3.5-1-1-3.5 3.5c-3 3-2 6.9 0 8.9ZM21.4 2.6c2 2 2.9 5.9 0 8.9L17.9 15l-1-1 3.5-3.5c1.4-1.4 1.9-4.2-.3-6.4s-5-1.8-6.4-.3l-3.5 3.5-1-1 3.5-3.5c3-3 6.9-2 8.9 0Z"></path><path d="m8.01 14.97 6.93-6.93 1.061 1.06-6.93 6.93z"></path></svg></a></h4><p>与 SavedModel 格式相比，H5 文件不包括以下两方面内容：</p><ul><li>通过 <code>model.add_loss()</code> 和 <code>model.add_metric()</code> 添加的<strong>外部损失和指标</strong>不会被保存（这与 SavedModel 不同）。如果您的模型有此类损失和指标且您想要恢复训练，则您需要在加载模型后自行重新添加这些损失。请注意，这不适用于通过 <code>self.add_loss()</code> 和 <code>self.add_metric()</code> 在层<em>内</em>创建的损失/指标。只要该层被加载，这些损失和指标就会被保留，因为它们是该层 <code>call</code> 方法的一部分。</li><li>已保存的文件中不包含<strong>自定义对象（如自定义层）的计算图</strong>。在加载时，Keras 需要访问这些对象的 Python 类/函数以重建模型。请参阅<a href="https://www.tensorflow.org/guide/keras/save_and_serialize?hl=zh_cn#custom-objects" rel="nofollow noopener noreferrer external" target=_blank>自定义对象</a>。</li></ul><h1 id=超参数调节>超参数调节<a href=#超参数调节 class=heading-anchor-link aria-label="Link to 超参数调节"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M2.6 21.4c2 2 5.9 2.9 8.9 0l3.5-3.5-1-1-3.5 3.5c-1.4 1.4-4.2 1.9-6.4-.3s-1.8-5-.3-6.4l3.5-3.5-1-1-3.5 3.5c-3 3-2 6.9 0 8.9ZM21.4 2.6c2 2 2.9 5.9 0 8.9L17.9 15l-1-1 3.5-3.5c1.4-1.4 1.9-4.2-.3-6.4s-5-1.8-6.4-.3l-3.5 3.5-1-1 3.5-3.5c3-3 6.9-2 8.9 0Z"></path><path d="m8.01 14.97 6.93-6.93 1.061 1.06-6.93 6.93z"></path></svg></a></h1><p>Keras Tuner 是一个库，可帮助您为 TensorFlow 程序选择最佳的超参数集。为您的机器学习 (ML) 应用选择正确的超参数集，这一过程称为<em>超参数调节</em>或<em>超调</em>。</p><p>超参数是控制训练过程和 ML 模型拓扑的变量。这些变量在训练过程中保持不变，并会直接影响 ML 程序的性能。超参数有两种类型：</p><ol><li><strong>模型超参数</strong>：影响模型的选择，例如隐藏层的数量和宽度</li><li><strong>算法超参数</strong>：影响学习算法的速度和质量，例如随机梯度下降 (SGD) 的学习率以及 k 近邻 (KNN) 分类器的近邻数</li></ol><p>在本教程中，您将使用 Keras Tuner 对图像分类应用执行超调。</p><p>直接跳过一堆</p><h2 id=定义模型>定义模型<a href=#定义模型 class=heading-anchor-link aria-label="Link to 定义模型"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M2.6 21.4c2 2 5.9 2.9 8.9 0l3.5-3.5-1-1-3.5 3.5c-1.4 1.4-4.2 1.9-6.4-.3s-1.8-5-.3-6.4l3.5-3.5-1-1-3.5 3.5c-3 3-2 6.9 0 8.9ZM21.4 2.6c2 2 2.9 5.9 0 8.9L17.9 15l-1-1 3.5-3.5c1.4-1.4 1.9-4.2-.3-6.4s-5-1.8-6.4-.3l-3.5 3.5-1-1 3.5-3.5c3-3 6.9-2 8.9 0Z"></path><path d="m8.01 14.97 6.93-6.93 1.061 1.06-6.93 6.93z"></path></svg></a></h2><p>构建用于超调的模型时，除了模型架构之外，还要定义超参数搜索空间。您为超调设置的模型称为<em>超模型</em>。</p><p>您可以通过两种方式定义超模型：</p><ul><li>使用模型构建工具函数</li><li>将 Keras Tuner API 的 <code>HyperModel</code> 类子类化</li></ul><p>您还可以将两个预定义的 <code>HyperModel</code> 类（<a href=https://keras-team.github.io/keras-tuner/documentation/hypermodels/#hyperxception-class rel="nofollow noopener noreferrer external" target=_blank>HyperXception</a> 和 <a href=https://keras-team.github.io/keras-tuner/documentation/hypermodels/#hyperresnet-class rel="nofollow noopener noreferrer external" target=_blank>HyperResNet</a>）用于计算机视觉应用。</p><p>在本教程中，您将使用模型构建工具函数来定义图像分类模型。模型构建工具函数将返回已编译的模型，并使用您以内嵌方式定义的超参数对模型进行超调。</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#d73a49;--shiki-dark:#F97583>def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> model_builder</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(hp):</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  model </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> keras.Sequential()</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  model.add(keras.layers.Flatten(</span><span style=color:#e36209;--shiki-dark:#FFAB70>input_shape</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>28</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>28</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)))</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>  # Tune the number of units in the first Dense layer</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>  # Choose an optimal value between 32-512</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  hp_units </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> hp.Int(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'units'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>min_value</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>32</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>max_value</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>512</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>step</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>32</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  model.add(keras.layers.Dense(</span><span style=color:#e36209;--shiki-dark:#FFAB70>units</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>hp_units, </span><span style=color:#e36209;--shiki-dark:#FFAB70>activation</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'relu'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>))</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  model.add(keras.layers.Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>10</span><span style=color:#24292e;--shiki-dark:#E1E4E8>))</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>  # Tune the learning rate for the optimizer</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>  # Choose an optimal value from 0.01, 0.001, or 0.0001</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  hp_learning_rate </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> hp.Choice(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'learning_rate'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>values</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1e-2</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>1e-3</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>1e-4</span><span style=color:#24292e;--shiki-dark:#E1E4E8>])</span></span>
<span class=line></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>  model.compile(</span><span style=color:#e36209;--shiki-dark:#FFAB70>optimizer</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>keras.optimizers.Adam(</span><span style=color:#e36209;--shiki-dark:#FFAB70>learning_rate</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>hp_learning_rate),</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                loss</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>keras.losses.SparseCategoricalCrossentropy(</span><span style=color:#e36209;--shiki-dark:#FFAB70>from_logits</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>True</span><span style=color:#24292e;--shiki-dark:#E1E4E8>),</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                metrics</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'accuracy'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>])</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>  return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> model</span></span></code></pre></div><h2 id=实例化调节器并执行超调>实例化调节器并执行超调<a href=#实例化调节器并执行超调 class=heading-anchor-link aria-label="Link to 实例化调节器并执行超调"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M2.6 21.4c2 2 5.9 2.9 8.9 0l3.5-3.5-1-1-3.5 3.5c-1.4 1.4-4.2 1.9-6.4-.3s-1.8-5-.3-6.4l3.5-3.5-1-1-3.5 3.5c-3 3-2 6.9 0 8.9ZM21.4 2.6c2 2 2.9 5.9 0 8.9L17.9 15l-1-1 3.5-3.5c1.4-1.4 1.9-4.2-.3-6.4s-5-1.8-6.4-.3l-3.5 3.5-1-1 3.5-3.5c3-3 6.9-2 8.9 0Z"></path><path d="m8.01 14.97 6.93-6.93 1.061 1.06-6.93 6.93z"></path></svg></a></h2><p>实例化调节器以执行超调。Keras Tuner 提供了四种调节器：<code>RandomSearch</code>、<code>Hyperband</code>、<code>BayesianOptimization</code> 和 <code>Sklearn</code>。在本教程中，您将使用 <a href=https://arxiv.org/pdf/1603.06560.pdf rel="nofollow noopener noreferrer external" target=_blank>Hyperband</a> 调节器。</p><p>要实例化 Hyperband 调节器，必须指定超模型、要优化的 <code>objective</code> 和要训练的最大周期数 (<code>max_epochs</code>)。</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>tuner </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> kt.Hyperband(model_builder,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                     objective</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'val_accuracy'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                     max_epochs</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>10</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                     factor</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>3</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                     directory</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'my_dir'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                     project_name</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'intro_to_kt'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span></code></pre></div><h1 id=finetune>Finetune<a href=#finetune class=heading-anchor-link aria-label="Link to Finetune"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M2.6 21.4c2 2 5.9 2.9 8.9 0l3.5-3.5-1-1-3.5 3.5c-1.4 1.4-4.2 1.9-6.4-.3s-1.8-5-.3-6.4l3.5-3.5-1-1-3.5 3.5c-3 3-2 6.9 0 8.9ZM21.4 2.6c2 2 2.9 5.9 0 8.9L17.9 15l-1-1 3.5-3.5c1.4-1.4 1.9-4.2-.3-6.4s-5-1.8-6.4-.3l-3.5 3.5-1-1 3.5-3.5c3-3 6.9-2 8.9 0Z"></path><path d="m8.01 14.97 6.93-6.93 1.061 1.06-6.93 6.93z"></path></svg></a></h1><p>在本教程中，您将学习如何使用迁移学习通过预训练网络对猫和狗的图像进行分类。</p><p>预训练模型是一个之前基于大型数据集（通常是大型图像分类任务）训练的已保存网络。您可以按原样使用预训练模型，也可以使用迁移学习针对给定任务自定义此模型。</p><p>用于图像分类的迁移学习背后的理念是，如果一个模型是基于足够大且通用的数据集训练的，那么该模型将有效地充当视觉世界的通用模型。随后，您可以利用这些学习到的特征映射，而不必通过基于大型数据集训练大型模型而从头开始。</p><p>在此笔记本中，您将尝试通过以下两种方式来自定义预训练模型：</p><ol><li>特征提取：使用先前网络学习的表示从新样本中提取有意义的特征。您只需在预训练模型上添加一个将从头开始训练的新分类器，这样便可重复利用先前针对数据集学习的特征映射。</li></ol><p>您无需（重新）训练整个模型。基础卷积网络已经包含通常用于图片分类的特征。但是，预训练模型的最终分类部分特定于原始分类任务，随后特定于训练模型所使用的类集。</p><ol><li>微调：解冻已冻结模型库的一些顶层，并共同训练新添加的分类器层和基础模型的最后几层。这样，我们便能“微调”基础模型中的高阶特征表示，以使其与特定任务更相关。</li></ol><p>您将遵循通用的机器学习工作流。</p><ol><li>检查并理解数据</li><li>构建输入流水线，在本例中使用 Keras ImageDataGenerator</li><li>构成模型<ul><li>加载预训练的基础模型（和预训练权重）</li><li>将分类层堆叠在顶部</li></ul></li><li>训练模型</li><li>评估模型</li></ol><p>忽略一堆</p><h2 id=从预训练卷积网络创建基础模型>从预训练卷积网络创建基础模型<a href=#从预训练卷积网络创建基础模型 class=heading-anchor-link aria-label="Link to 从预训练卷积网络创建基础模型"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M2.6 21.4c2 2 5.9 2.9 8.9 0l3.5-3.5-1-1-3.5 3.5c-1.4 1.4-4.2 1.9-6.4-.3s-1.8-5-.3-6.4l3.5-3.5-1-1-3.5 3.5c-3 3-2 6.9 0 8.9ZM21.4 2.6c2 2 2.9 5.9 0 8.9L17.9 15l-1-1 3.5-3.5c1.4-1.4 1.9-4.2-.3-6.4s-5-1.8-6.4-.3l-3.5 3.5-1-1 3.5-3.5c3-3 6.9-2 8.9 0Z"></path><path d="m8.01 14.97 6.93-6.93 1.061 1.06-6.93 6.93z"></path></svg></a></h2><p>您将根据 Google 开发的 <strong>MobileNet V2</strong> 模型来创建基础模型。此模型已基于 ImageNet 数据集进行预训练，ImageNet 数据集是一个包含 140 万个图像和 1000 个类的大型数据集。ImageNet 是一个研究训练数据集，具有各种各样的类别，例如 <code>jackfruit</code> 和 <code>syringe</code>。此知识库将帮助我们对特定数据集中的猫和狗进行分类。</p><p>首先，您需要选择将 MobileNet V2 的哪一层用于特征提取。最后的分类层（在“顶部”，因为大多数机器学习模型的图表是从下到上的）不是很有用。相反，您将按照常见做法依赖于展平操作之前的最后一层。此层被称为“瓶颈层”。与最后一层/顶层相比，瓶颈层的特征保留了更多的通用性。</p><p>首先，实例化一个已预加载基于 ImageNet 训练的权重的 MobileNet V2 模型。通过指定 <strong>include_top=False</strong> 参数，可以加载不包括顶部分类层的网络，这对于特征提取十分理想</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># Create the base model from the pre-trained model MobileNet V2</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>IMG_SHAPE</span><span style=color:#d73a49;--shiki-dark:#F97583> =</span><span style=color:#005cc5;--shiki-dark:#79B8FF> IMG_SIZE</span><span style=color:#d73a49;--shiki-dark:#F97583> +</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (</span><span style=color:#005cc5;--shiki-dark:#79B8FF>3</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>base_model </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.keras.applications.MobileNetV2(</span><span style=color:#e36209;--shiki-dark:#FFAB70>input_shape</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>IMG_SHAPE</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                                               include_top</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>False</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                                               weights</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'imagenet'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span></code></pre></div><h1 id=回到我自己的问题上>回到我自己的问题上<a href=#回到我自己的问题上 class=heading-anchor-link aria-label="Link to 回到我自己的问题上"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M2.6 21.4c2 2 5.9 2.9 8.9 0l3.5-3.5-1-1-3.5 3.5c-1.4 1.4-4.2 1.9-6.4-.3s-1.8-5-.3-6.4l3.5-3.5-1-1-3.5 3.5c-3 3-2 6.9 0 8.9ZM21.4 2.6c2 2 2.9 5.9 0 8.9L17.9 15l-1-1 3.5-3.5c1.4-1.4 1.9-4.2-.3-6.4s-5-1.8-6.4-.3l-3.5 3.5-1-1 3.5-3.5c3-3 6.9-2 8.9 0Z"></path><path d="m8.01 14.97 6.93-6.93 1.061 1.06-6.93 6.93z"></path></svg></a></h1><p>我现在是属于要用H5的那个，那么 首先我需要自己重新创建一个模型。</p><p>先补一下<a href=http://zh.d2l.ai/chapter_multilayer-perceptrons/mlp.html rel="nofollow noopener noreferrer external" target=_blank>MLP</a></p><p>然后我也手动测试出了模型结构 下一个问题就是 怎么给Weight和Bias赋值</p><figure><img alt=image-20220222222953159 src=https://raw.githubusercontent.com/lifeodyssey/Figurebed/master/image.202202222229236.png><figcaption>image-20220222222953159</figcaption></figure><p>好简单。。。只要肯查源码，什么都不是问题</p><p>这么写的</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>Fmodel.add(Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>100</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>input_shape</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>7</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,),</span><span style=color:#e36209;--shiki-dark:#FFAB70>activation</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'relu'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                 kernel_initializer</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>keras.initializers.Constant(np.array(f[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Weights'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Layer1'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>])),</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                bias_initializer</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>keras.initializers.Constant(np.array(f[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Bias'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Layer1'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]))))</span></span>
<span class=line></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>Fmodel.add(Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>75</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>activation</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'relu'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                 kernel_initializer</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>keras.initializers.Constant(np.array(f[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Weights'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Layer2'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>])),</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                bias_initializer</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>keras.initializers.Constant(np.array(f[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Bias'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Layer2'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]))))</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>Fmodel.add(Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>50</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>activation</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'relu'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                 kernel_initializer</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>keras.initializers.Constant(np.array(f[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Weights'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Layer3'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>])),</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                bias_initializer</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>keras.initializers.Constant(np.array(f[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Bias'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Layer3'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]))))</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>Fmodel.add(Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>25</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>activation</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'relu'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                 kernel_initializer</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>keras.initializers.Constant(np.array(f[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Weights'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Layer4'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>])),</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                bias_initializer</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>keras.initializers.Constant(np.array(f[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Bias'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Layer4'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]))))</span></span>
<span class=line></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>Fmodel.add(Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>7</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>activation</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'linear'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                 kernel_initializer</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>keras.initializers.Constant(np.array(f[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Weights'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Layer5'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>])),</span></span>
<span class=line><span style=color:#e36209;--shiki-dark:#FFAB70>                bias_initializer</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>keras.initializers.Constant(np.array(f[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Bias'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Layer5'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]))))</span></span></code></pre></div><p>为什么他们结果不太一样呢</p><p>自己一开始是把activation写错了 写成了relu 就是上面那个，后面改成了tanh 应该一样了啊</p><p>再次开启debug，然后发现从第一层开始就有问题了。</p><p>所以这个dense tanh到底是怎么计算的呢</p><p><code>Dense</code> implements the operation: <code>output = activation(dot(input, kernel) + bias)</code> where <code>activation</code> is the element-wise activation function passed as the <code>activation</code> argument, <code>kernel</code> is a weights matrix created by the layer, and <code>bias</code> is a bias vector created by the layer (only applicable if <code>use_bias</code> is <code>True</code>). These are all attributes of <code>Dense</code>.</p><p>对于原来的代码</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>lastlayer</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>np.tanh(np.matmul(aphnn_weights[i],aphinput.transpose())</span><span style=color:#d73a49;--shiki-dark:#F97583>+</span><span style=color:#24292e;--shiki-dark:#E1E4E8>aphnn_bias[i])</span></span></code></pre></div><p>np.matmul和dot都是一样的，矩阵乘法</p><p>啊搞定了</p><p>因为keras.initializers.Constant只能给所有的weight和bias赋一样的值，所以会有差别。</p><p>新的写法改成了</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>Fmodel.add(Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>100</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>input_shape</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>7</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,),</span><span style=color:#e36209;--shiki-dark:#FFAB70>activation</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'tanh'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#e36209;--shiki-dark:#FFAB70>use_bias</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>True</span><span style=color:#24292e;--shiki-dark:#E1E4E8>))</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>Fmodel.layers[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>].set_weights([np.array(f[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Weights'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Layer1'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]).T,np.array(f[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Bias'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Layer1'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]).flatten()])</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>Fmodel.add(Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>75</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>activation</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'tanh'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#e36209;--shiki-dark:#FFAB70>use_bias</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>True</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>Fmodel.layers[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>].set_weights([np.array(f[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Weights'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Layer2'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]).T,np.array(f[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Bias'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Layer2'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]).flatten()])</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>Fmodel.add(Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>50</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>activation</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'tanh'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#e36209;--shiki-dark:#FFAB70>use_bias</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>True</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>Fmodel.layers[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>2</span><span style=color:#24292e;--shiki-dark:#E1E4E8>].set_weights([np.array(f[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Weights'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Layer3'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]).T,np.array(f[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Bias'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Layer3'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]).flatten()])</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>Fmodel.add(Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>25</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>activation</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'tanh'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,,</span><span style=color:#e36209;--shiki-dark:#FFAB70>use_bias</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>True</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>Fmodel.layers[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>3</span><span style=color:#24292e;--shiki-dark:#E1E4E8>].set_weights([np.array(f[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Weights'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Layer4'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]).T,np.array(f[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Bias'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Layer4'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]).flatten()])</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>Fmodel.add(Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>7</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>activation</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'linear'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#e36209;--shiki-dark:#FFAB70>use_bias</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>True</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#e36209;--shiki-dark:#FFAB70>use_bias</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>True</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>Fmodel.layers[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>4</span><span style=color:#24292e;--shiki-dark:#E1E4E8>].set_weights([np.array(f[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Weights'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Layer5'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]).T,np.array(f[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Bias'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Layer5'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]).flatten()])</span></span></code></pre></div><p>终于搞定了 后面做个finetune就可以了</p><p><a href=https://www.kaggle.com/c/tensorflow-great-barrier-reef rel="nofollow noopener noreferrer external" target=_blank>https://www.kaggle.com/c/tensorflow-great-barrier-reef</a></p><p><a href=https://tensorflow.google.cn/api_docs/python/tf/keras/optimizers/schedules/InverseTimeDecay rel="nofollow noopener noreferrer external" target=_blank>https://tensorflow.google.cn/api_docs/python/tf/keras/optimizers/schedules/InverseTimeDecay</a></p><p><a href=https://stackoverflow.com/questions/44747343/keras-input-explanation-input-shape-units-batch-size-dim-etc rel="nofollow noopener noreferrer external" target=_blank>https://stackoverflow.com/questions/44747343/keras-input-explanation-input-shape-units-batch-size-dim-etc</a></p><p><a href=https://vimsky.com/examples/usage/python-tf.keras.layers.Dropout-tf.html rel="nofollow noopener noreferrer external" target=_blank>https://vimsky.com/examples/usage/python-tf.keras.layers.Dropout-tf.html</a></p><p><a href=https://cnbeining.github.io/deep-learning-with-python-cn/4-advanced-multi-layer-perceptrons-and-keras/ch16-reduce-overfitting-with-dropout-regularization.html rel="nofollow noopener noreferrer external" target=_blank>https://cnbeining.github.io/deep-learning-with-python-cn/4-advanced-multi-layer-perceptrons-and-keras/ch16-reduce-overfitting-with-dropout-regularization.html</a></p><div id=post-copyright></div><div class="mt-12.6 uno-decorative-line"></div><div class="no-heti flex flex-wrap gap-x-3 gap-y-3.2"><a href=/tags/机器学习/ class="hover:c-primary border border-secondary/25 ease-out hover:border-secondary/80 hover:font-medium hover:ring-0.2 inline-block px-3.2 py-0.7 relative ring-0 ring-secondary/80 rounded-full transition-[colors,box-shadow]"><span class="flex absolute inset-0 items-center justify-center transition-font-weight whitespace-nowrap">机器学习 </span><span class="inline-block font-medium opacity-0" aria-hidden=true>机器学习 </span></a><a href=/tags/Inversion/ class="hover:c-primary border border-secondary/25 ease-out hover:border-secondary/80 hover:font-medium hover:ring-0.2 inline-block px-3.2 py-0.7 relative ring-0 ring-secondary/80 rounded-full transition-[colors,box-shadow]"><span class="flex absolute inset-0 items-center justify-center transition-font-weight whitespace-nowrap">Inversion </span><span class="inline-block font-medium opacity-0" aria-hidden=true>Inversion </span></a><a href="/tags/Deep Learning/" class="hover:c-primary border border-secondary/25 ease-out hover:border-secondary/80 hover:font-medium hover:ring-0.2 inline-block px-3.2 py-0.7 relative ring-0 ring-secondary/80 rounded-full transition-[colors,box-shadow]"><span class="flex absolute inset-0 items-center justify-center transition-font-weight whitespace-nowrap">Deep Learning </span><span class="inline-block font-medium opacity-0" aria-hidden=true>Deep Learning </span></a><a href=/tags/tensorflow/ class="hover:c-primary border border-secondary/25 ease-out hover:border-secondary/80 hover:font-medium hover:ring-0.2 inline-block px-3.2 py-0.7 relative ring-0 ring-secondary/80 rounded-full transition-[colors,box-shadow]"><span class="flex absolute inset-0 items-center justify-center transition-font-weight whitespace-nowrap">tensorflow </span><span class="inline-block font-medium opacity-0" aria-hidden=true>tensorflow</span></a></div></div></article></main><footer class="leading-1.25em font-navbar lg:text-3.5 text-3" lg="uno-desktop-column bottom-20"><p><a href=/atom.xml/ class="highlight-hover hover:c-primary after:bottom-0.35em py-0.8 transition-colors" rel="noopener noreferrer" target=_blank>RSS</a>&nbsp;/ <a href=https://github.com/lifeodyssey class="highlight-hover hover:c-primary after:bottom-0.35em py-0.8 transition-colors" rel="noopener noreferrer" target=_blank>GitHub</a>&nbsp;/ <a href=mailto:email@radishzz.cc class="highlight-hover hover:c-primary after:bottom-0.35em py-0.8 transition-colors" rel="noopener noreferrer" target=_blank>Email</a>&nbsp;</p><p>© 2025-2026 周大侠</p><p>Powered by <a href=https://astro.build/ class="highlight-hover hover:c-primary after:bottom-0.35em py-0.8 transition-colors" rel="noopener noreferrer" target=_blank>Astro</a> and <a href=https://github.com/radishzzz/astro-theme-retypeset class="highlight-hover hover:c-primary after:bottom-0.35em py-0.8 transition-colors" rel="noopener noreferrer" target=_blank>Retypeset</a></p></footer></div><div class="flex absolute gap-6 lg:bottom-[min(10.27rem+1.92vw,12rem)] lg:fixed lg:right-[max(5rem,calc(50vw-35rem))] lg:top-auto lg:w-14rem min-[823px]:max-lg:right-[calc(50vw-22rem)] right-7.25vw top-14.6"><a href=/posts/fd169b9d.html.html/ class="hover:c-primary active:scale-90 aspect-square c-secondary w-4" aria-label="Switch website language" id=language-switcher><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M19.18 21.1 12.4 1.89h-1.21L4.52 21.1l-2.53.2v.81h6.37v-.81l-2.83-.2 2.02-5.97h7.58l2.02 5.97-3.34.2v.81H22v-.81l-2.83-.2zM7.85 14.33l3.44-10.21 3.54 10.21z"/></svg> </a><button aria-label="Switch light/dark theme" class="hover:c-primary active:scale-90 aspect-square c-secondary w-4" id=theme-toggle-button><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M12.06.61C5.66.61.46 5.71.46 12.11s5.1 11.5 11.6 11.5 11.5-5.1 11.5-11.5S18.46.61 12.06.61m0 21c-6.07 0-10.94-4.2-10.94-9.5s4.87-9.4 10.94-9.4S23 6.91 23 12.21s-4.88 9.4-10.94 9.4"/></svg></button></div><script>!function(){const e="oklch(96% 0.005 298)",t="oklch(22% 0.005 298)";function n(n){document.documentElement.classList.toggle("dark",n);const o=document.head.querySelector('meta[name="theme-color"]');o&&e&&t&&o.setAttribute("content",n?t:e),localStorage.setItem("theme",n?"dark":"light"),document.dispatchEvent(new Event("theme-changed"))}function o(){n(!document.documentElement.classList.contains("dark"))}document.addEventListener("click",(function(e){const t=e.target instanceof Element?e.target:null,n=t?.closest("#theme-toggle-button");if(!n)return;if(document.documentElement.classList.contains("reduce-motion"))return void o();document.documentElement.style.setProperty("view-transition-name","animation-theme-toggle"),document.documentElement.setAttribute("data-theme-changing",""),document.startViewTransition(o).finished.then((()=>{document.documentElement.style.removeProperty("view-transition-name"),document.documentElement.removeAttribute("data-theme-changing")}))}),{passive:!0}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(e=>{n(e.matches)}))}()</script><script type=module>const o={click:"tap",typing:"type"},l={[o.click]:.8,[o.typing]:.4},d=["#language-switcher","#theme-toggle-button"],f=[".el-input__inner",".el-textarea__inner","#wl-nick","#wl-mail","#wl-link","#wl-edit"],h=new Set(["Shift","Control","Alt","Meta","Tab","Escape","CapsLock"]),p=d.join(","),g=f.join(",");function r(){return window.matchMedia("(max-width: 1023px)").matches}function w(){return document.head.querySelector('link[rel="sitemap"]')?.getAttribute("href")?.replace("/sitemap-index.xml","")||""}class y{audioContext=null;audioBuffers={[o.click]:[],[o.typing]:[]};initPromise=null;async fetchAndCacheSound(t,e){if(!this.audioContext)throw new Error("Audio context not initialized");const n=`${t}_0${e+1}`,i=await(await fetch(`${w()}/sounds/${n}.wav`)).arrayBuffer(),a=await this.audioContext.decodeAudioData(i);this.audioBuffers[t].push(a)}async preloadAllSounds(){const t=Object.values(o).flatMap((t=>Array.from({length:5},((e,n)=>this.fetchAndCacheSound(t,n)))));await Promise.allSettled(t)}async initialize(){return this.initPromise??=(async()=>{const t=window.AudioContext||window.webkitAudioContext;this.audioContext=new t,await this.preloadAllSounds()})()}async playSound(t){try{if(await this.initialize(),!this.audioContext)return;"suspended"===this.audioContext.state&&await this.audioContext.resume();const e=this.audioBuffers[t];if(0===e.length)return;const n=this.audioContext.createBufferSource();n.buffer=e[Math.floor(Math.random()*e.length)];const i=this.audioContext.createGain();i.gain.value=l[t],n.connect(i).connect(this.audioContext.destination),n.start(0)}catch(t){console.warn("Sound playback failed:",t)}}}const c=new y;function m(t){r()||!t.target?.closest(p)||c.playSound(o.click)}function x(t){r()||t.ctrlKey||t.altKey||t.metaKey||h.has(t.key)||!t.target?.closest(g)||c.playSound(o.typing)}document.addEventListener("click",m,{passive:!0}),document.addEventListener("keydown",x,{passive:!0})</script><script type=module>const s={copy:'<svg\n      viewBox="0 0 24 24"\n      fill="currentColor"\n    >\n      <path d="M6.9.8v18h14.5V.8zm12.8 16h-11v-14h11z"/>\n      <path d="M4.3 21.2V5.6l-1.7.5v17.1h14.3l.6-2z"/>\n    </svg>',success:'<svg\n      viewBox="0 0 24 24"\n      fill="currentColor"\n    >\n      <path d="m23.1 6.4-1.3-1.3L9.4 16.6l-6.3-5.4-1.2 1.2L9.4 20z"/>\n    </svg>'},o=new WeakMap;function r(){const e=document.querySelectorAll(".code-copy-button");0!==e.length&&e.forEach((e=>{e.innerHTML=s.copy}))}async function a(e){if(e.classList.contains("copy-success"))return;const t=e.parentElement?.querySelector("pre code"),n=t?.textContent??"";if(t&&n)try{await navigator.clipboard.writeText(n);const t=o.get(e);t&&clearTimeout(t),e.innerHTML=s.success,e.classList.add("copy-success");const c=setTimeout((()=>{e.isConnected&&(e.innerHTML=s.copy,e.classList.remove("copy-success"),o.delete(e))}),1500);o.set(e,c)}catch(e){console.error("Failed to copy code",e)}}function l(e){const t=e.target instanceof Element&&e.target.closest(".code-copy-button");t&&a(t)}document.addEventListener("astro:page-load",r),document.addEventListener("click",l,{passive:!0}),r()</script><script type=module>async function p(t){const e=t.dataset.repo;if(!e)return;const o=t.getElementsByClassName("gc-owner-avatar")[0],n=t.getElementsByClassName("gc-repo-description")[0],s=t.getElementsByClassName("gc-stars-count")[0],a=t.getElementsByClassName("gc-forks-count")[0],r=t.getElementsByClassName("gc-license-info")[0];function c(t){const e=new Intl.NumberFormat("en",{notation:"compact",maximumFractionDigits:1});o&&t.owner?.avatar_url&&(o.style.backgroundImage=`url(${t.owner.avatar_url})`),n&&(n.textContent=t.description??"No description"),s&&(s.textContent=e.format(t.stargazers_count??0)),a&&(a.textContent=e.format(t.forks_count??0)),r&&(r.textContent=t.license?.spdx_id??"No License")}const i=`github-repo-${e}`,m=sessionStorage.getItem(i);if(m){c(JSON.parse(m))}else try{const t=await fetch(`https://api.github.com/repos/${e}`);if(!t.ok){if(n){const e=404===t.status?"Repository not found":"Failed to load repository data";n.textContent=e}return}const o=await t.json();sessionStorage.setItem(i,JSON.stringify(o)),c(o)}catch(t){console.error(`Failed to fetch ${e}:`,t)}}function f(){const t=document.getElementsByClassName("gc-container");0!==t.length&&Array.from(t).forEach((t=>{p(t)}))}document.addEventListener("astro:page-load",f),f()</script><script type=module src=/_astro/MediaEmbed.astro_astro_type_script_index_0_lang.wKrCMCCr.js></script><script type=module>const n={overlay:document.querySelector(".zoom-overlay"),zoomedImg:null,originalImg:null,createOverlay(){this.overlay&&this.overlay.isConnected||(this.overlay=document.createElement("div"),this.overlay.classList.add("zoom-overlay"),this.overlay.setAttribute("role","dialog"),this.overlay.setAttribute("aria-modal","true"),this.overlay.setAttribute("aria-label","Image Viewer"),this.overlay.setAttribute("tabindex","-1"),Object.assign(this.overlay.style,{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",zIndex:"999",backgroundColor:"oklch(var(--un-preset-theme-colors-background) / 0.95)",opacity:"0",transition:"opacity 300ms cubic-bezier(0.4, 0, 0.2, 1)",cursor:"zoom-out",display:"none"}),document.body.appendChild(this.overlay))},zoomImg(e){if(!this.overlay)return;document.body.style.overflow="hidden";const t=e.getBoundingClientRect();this.originalImg=e,this.zoomedImg=e.cloneNode(),Object.assign(this.zoomedImg.style,{position:"fixed",top:`${t.top}px`,left:`${t.left}px`,width:`${t.width}px`,height:`${t.height}px`,transition:"transform 300ms cubic-bezier(0.4, 0, 0.2, 1)",zIndex:"1000",cursor:"zoom-out"}),document.body.appendChild(this.zoomedImg),this.overlay.style.display="block",this.overlay.focus();const o=window.innerWidth,i=window.innerHeight,s=window.innerWidth<768?1:.8,l=Math.min(o*s/t.width,i*s/t.height),a=(-t.left+(o-t.width)/2)/l,n=(-t.top+(i-t.height)/2)/l;requestAnimationFrame((()=>{this.overlay&&(this.overlay.style.opacity="1"),this.zoomedImg&&(this.zoomedImg.style.transform=`scale(${l}) translate3d(${a}px, ${n}px, 0)`)}))},close(){!this.overlay||!this.zoomedImg||!this.originalImg||(this.zoomedImg.style.transform="",this.overlay.style.opacity="0",document.body.style.overflow="",setTimeout((()=>{this.zoomedImg&&this.zoomedImg.parentNode&&document.body.removeChild(this.zoomedImg),this.zoomedImg=null,this.overlay&&(this.overlay.style.display="none"),this.originalImg&&this.originalImg.focus(),this.originalImg=null}),300))},setupOverlay(){this.createOverlay(),this.zoomedImg=null,this.originalImg=null},handleClick(e){if(this.zoomedImg)return void this.close();const t=e.target;t instanceof HTMLImageElement&&t.complete&&t.naturalWidth>=100&&t.naturalHeight>=100&&this.zoomImg(t)},handleResize(){this.zoomedImg&&this.close()},init(){this.createOverlay(),document.addEventListener("astro:page-load",(()=>this.setupOverlay())),document.addEventListener("click",(e=>this.handleClick(e)),{passive:!0}),window.addEventListener("resize",(()=>this.handleResize()),{passive:!0})}};n.init()</script></body></html>