<!DOCTYPE html><html class="font-sans scroll-smooth" lang=zh-CN><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1,viewport-fit=cover" name=viewport><link href=/icons/favicon.svg rel=icon type=image/svg+xml><title>Mixture Density Network(2) | 乔克叔叔的床边故事</title><meta content="太长了，分P the likelihood is the possibility that fit a distribution 例えば 抛一枚匀质硬币，抛10次，6次正面向上的可能性多大？这里的可能性是probability 是某个时间发..." name=description><meta content=周大侠 name=author><meta content="Astro v5.13.7" name=generator><meta content="oklch(96% 0.005 298)" name=theme-color><link href=/fonts/EarlySummer-VF-Split/EarlySummer-VF-Subset.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Snell-Black-SF.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Snell-Bold-SF.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/STIX-VF.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/STIX-Italic-VF.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/_astro/katex.min.COXD5gRV.css rel=stylesheet media=print onload="this.media=&#34;all&#34;"><link href=https://lifeodyssey.github.io/posts/8bb8e4ec.html.html rel=canonical><link href=/sitemap-index.xml rel=sitemap><link href=/rss.xml rel=alternate type=application/rss+xml title="RSS Feed"><link href=/atom.xml rel=alternate type=application/atom+xml title="Atom Feed"><link href=https://lifeodyssey.github.io rel=alternate hreflang=zh><link href=https://lifeodyssey.github.io/en/ rel=alternate hreflang=en><link href=https://lifeodyssey.github.io/ja/ rel=alternate hreflang=ja><meta content=article property=og:type><meta content=https://lifeodyssey.github.io/posts/8bb8e4ec.html.html property=og:url><meta content="Mixture Density Network(2) | 乔克叔叔的床边故事" property=og:title><meta content="太长了，分P the likelihood is the possibility that fit a distribution 例えば 抛一枚匀质硬币，抛10次，6次正面向上的可能性多大？这里的可能性是probability 是某个时间发..." property=og:description><meta content=https://lifeodyssey.github.io/og/8bb8e4ec.png property=og:image><meta content=summary_large_image name=twitter:card><meta content=true name=astro-view-transitions-enabled><meta content=none name=astro-view-transitions-fallback><script type=module src=/_astro/ClientRouter.astro_astro_type_script_index_0_lang.1k2cUud7.js></script><script>!function(){function e(e=document){const t=function(){const e=localStorage.getItem("theme");return!!e&&"dark"===e}();e.documentElement.classList.toggle("dark",t);const n=e.head.querySelector('meta[name="theme-color"]');n&&n.setAttribute("content",t?"oklch(22% 0.005 298)":"oklch(96% 0.005 298)")}function t(e=document){const t=window.matchMedia("(prefers-reduced-motion: reduce)").matches||!("startViewTransition"in e);e.documentElement.classList.toggle("reduce-motion",t)}document.addEventListener("astro:before-swap",(({newDocument:n})=>{e(n),t(n)})),e(),t()}()</script><link href=/_astro/_about_.Dzb1Me_E.css rel=stylesheet><link href=/_astro/_posts_slug_.CM85RmC-.css rel=stylesheet><script type=module src=/_astro/page.BNYwb576.js></script><script>!function(t,e,n,r){(window.crossOriginIsolated||navigator.serviceWorker)&&((r=t[e]=Object.assign(t[e]||{},{lib:"/~partytown/",debug:!1}))[n]=(r[n]||[]).concat(["dataLayer.push","gtag"]))}(window,"partytown","forward");const tp={preserveBehavior:!1},ep=t=>{if("string"==typeof t)return[t,tp];const[e,n=tp]=t;return[e,{...tp,...n}]},n=Object.freeze((()=>{const t=new Set;let e=[];do{Object.getOwnPropertyNames(e).forEach((n=>{"function"==typeof e[n]&&t.add(n)}))}while((e=Object.getPrototypeOf(e))!==Object.prototype);return Array.from(t)})());!function(t,e,r,o,i,a,s,c,d,p,l=t,u){function f(){u||(u=1,"/"==(s=(a.lib||"/~partytown/")+(a.debug?"debug/":""))[0]&&(d=e.querySelectorAll('script[type="text/partytown"]'),o!=t?o.dispatchEvent(new CustomEvent("pt1",{detail:t})):(c=setTimeout(w,(null==a?void 0:a.fallbackTimeout)||1e4),e.addEventListener("pt0",h),i?y(1):r.serviceWorker?r.serviceWorker.register(s+(a.swPath||"partytown-sw.js"),{scope:s}).then((function(t){t.active?y():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&y()}))}),console.error):w())))}function y(n){p=e.createElement(n?"script":"iframe"),t._pttab=Date.now(),n||(p.style.display="block",p.style.width="0",p.style.height="0",p.style.border="0",p.style.visibility="hidden",p.setAttribute("aria-hidden",!0)),p.src=s+"partytown-"+(n?"atomics.js?v=0.11.1":"sandbox-sw.html?"+t._pttab),e.querySelector(a.sandboxParent||"body").appendChild(p)}function w(n,r){for(h(),o==t&&(a.forward||[]).map((function(e){const[n]=ep(e);delete t[n.split(".")[0]]})),n=0;n<d.length;n++)(r=e.createElement("script")).innerHTML=d[n].innerHTML,r.nonce=a.nonce,e.head.appendChild(r);p&&p.parentNode.removeChild(p)}function h(){clearTimeout(c)}a=t.partytown||{},o==t&&(a.forward||[]).map((function(e){const[r,{preserveBehavior:o}]=ep(e);l=t,r.split(".").map((function(e,r,i){var a;l=l[i[r]]=r+1<i.length?l[i[r]]||(a=i[r+1],n.includes(a)?[]:{}):(()=>{let e=null;if(o){const{methodOrProperty:n,thisObject:r}=((t,e)=>{let n=t;for(let t=0;t<e.length-1;t+=1)n=n[e[t]];return{thisObject:n,methodOrProperty:e.length>0?n[e[e.length-1]]:void 0}})(t,i);"function"==typeof n&&(e=(...t)=>n.apply(r,...t))}return function(){let n;return e&&(n=e(arguments)),(t._ptf=t._ptf||[]).push(i,arguments),n}})()}))})),"complete"==e.readyState?f():(t.addEventListener("DOMContentLoaded",f),t.addEventListener("load",f))}(window,document,navigator,top,window.crossOriginIsolated),document.addEventListener("astro:before-swap",(t=>{let e=document.body.querySelector("iframe[src*='/~partytown/']");e&&t.newDocument.body.append(e)}))</script><style>[data-astro-transition-scope=astro-va26yt7w-1]{view-transition-name:post-8bb8e4ec-zh}@layer astro{::view-transition-old(post-8bb8e4ec-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}::view-transition-new(post-8bb8e4ec-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}[data-astro-transition=back]::view-transition-old(post-8bb8e4ec-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}[data-astro-transition=back]::view-transition-new(post-8bb8e4ec-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}}[data-astro-transition-fallback=old] [data-astro-transition-scope=astro-va26yt7w-1],[data-astro-transition-fallback=old][data-astro-transition-scope=astro-va26yt7w-1]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}[data-astro-transition-fallback=new] [data-astro-transition-scope=astro-va26yt7w-1],[data-astro-transition-fallback=new][data-astro-transition-scope=astro-va26yt7w-1]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}[data-astro-transition=back][data-astro-transition-fallback=old] [data-astro-transition-scope=astro-va26yt7w-1],[data-astro-transition=back][data-astro-transition-fallback=old][data-astro-transition-scope=astro-va26yt7w-1]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}[data-astro-transition=back][data-astro-transition-fallback=new] [data-astro-transition-scope=astro-va26yt7w-1],[data-astro-transition=back][data-astro-transition-fallback=new][data-astro-transition-scope=astro-va26yt7w-1]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}</style><style>[data-astro-transition-scope=astro-aqc54ihn-2]{view-transition-name:time-8bb8e4ec-zh}@layer astro{::view-transition-old(time-8bb8e4ec-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}::view-transition-new(time-8bb8e4ec-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}[data-astro-transition=back]::view-transition-old(time-8bb8e4ec-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}[data-astro-transition=back]::view-transition-new(time-8bb8e4ec-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}}[data-astro-transition-fallback=old] [data-astro-transition-scope=astro-aqc54ihn-2],[data-astro-transition-fallback=old][data-astro-transition-scope=astro-aqc54ihn-2]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}[data-astro-transition-fallback=new] [data-astro-transition-scope=astro-aqc54ihn-2],[data-astro-transition-fallback=new][data-astro-transition-scope=astro-aqc54ihn-2]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}[data-astro-transition=back][data-astro-transition-fallback=old] [data-astro-transition-scope=astro-aqc54ihn-2],[data-astro-transition=back][data-astro-transition-fallback=old][data-astro-transition-scope=astro-aqc54ihn-2]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}[data-astro-transition=back][data-astro-transition-fallback=new] [data-astro-transition-scope=astro-aqc54ihn-2],[data-astro-transition=back][data-astro-transition-fallback=new][data-astro-transition-scope=astro-aqc54ihn-2]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}</style><style>[data-astro-transition-scope=astro-wif6pdce-3]{view-transition-name:site-title-zh}@layer astro{::view-transition-old(site-title-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}::view-transition-new(site-title-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}[data-astro-transition=back]::view-transition-old(site-title-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}[data-astro-transition=back]::view-transition-new(site-title-zh){animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}}[data-astro-transition-fallback=old] [data-astro-transition-scope=astro-wif6pdce-3],[data-astro-transition-fallback=old][data-astro-transition-scope=astro-wif6pdce-3]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}[data-astro-transition-fallback=new] [data-astro-transition-scope=astro-wif6pdce-3],[data-astro-transition-fallback=new][data-astro-transition-scope=astro-wif6pdce-3]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}[data-astro-transition=back][data-astro-transition-fallback=old] [data-astro-transition-scope=astro-wif6pdce-3],[data-astro-transition=back][data-astro-transition-fallback=old][data-astro-transition-scope=astro-wif6pdce-3]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeOut}[data-astro-transition=back][data-astro-transition-fallback=new] [data-astro-transition-scope=astro-wif6pdce-3],[data-astro-transition=back][data-astro-transition-fallback=new][data-astro-transition-scope=astro-wif6pdce-3]{animation-duration:180ms;animation-timing-function:cubic-bezier(0.76,0,0.24,1);animation-fill-mode:both;animation-name:astroFadeIn}</style></head><body><div class="w-full max-w-205.848 min-h-dvh min-h-vh mx-auto" lg="mx-[max(5.75rem,calc(50vw-34.25rem))] my-20 max-w-[min(calc(75vw-16rem),44rem)] min-h-full p-0" p="x-[min(7.25vw,3.731rem)] y-10"><header class="cjk:tracking-0.02em lg:uno-desktop-column lg:top-20 mb-10.8"><h2 class="font-bold c-secondary font-title lg:c-primary lg:mb-1.8 lg:mt-0 lg:text-9 mb-2.8 mt-3 text-5.375"><div class="inline-block box-content pr-1" data-astro-transition-scope=astro-wif6pdce-3 data-disable-theme-transition><a href=/ id=site-title-link>乔克叔叔的床边故事</a></div></h2></header><nav aria-label="Site Navigation" class="hidden cjk:tracking-0.02em font-navbar font-semibold leading-2.45em lg:block lg:bottom-[min(9.04rem+3.85vw,12.5rem)] lg:text-4 lg:uno-desktop-column mb-10.5 text-3.6"><ul><li><a href=/ class="c-primary after:bottom-0.7em font-bold highlight-static">文章</a></li><li><a href=/tags/ class="hover:c-primary highlight-hover after:bottom-0.7em hover:font-bold transition-[colors,font-weight]">标签</a></li><li><a href=/about/ class="hover:c-primary highlight-hover after:bottom-0.7em hover:font-bold transition-[colors,font-weight]">关于</a></li><li><a href=/search/ class="hover:c-primary highlight-hover after:bottom-0.7em hover:font-bold transition-[colors,font-weight]">Search</a></li></ul></nav><main class=mb-10><article class=heti><div class=relative><button aria-label="Go back" class=hidden id=back-button lg="absolute left--10 top-3.8 block aspect-square w-4.5 c-secondary/40 transition-colors ease-out hover:c-secondary/80 active:scale-90!"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d=M17.8.7L4,12l13.8,11.4.7-.9L7.2,12,18.5,1.5l-.7-.8Z /></svg></button><script type=module>function e(t){if(!(t.target instanceof Element?t.target:null)?.closest("#back-button"))return;if(window.history.length>1)return void window.history.back();const e=document.getElementById("site-title-link");e&&e.click()}document.addEventListener("click",e,{passive:!0})</script><h1 class=post-title><span data-astro-transition-scope=astro-va26yt7w-1 data-disable-theme-transition>Mixture Density Network(2)</span></h1></div><div class="c-primary block font-time mb-17.2" data-astro-transition-scope=astro-aqc54ihn-2 data-disable-theme-transition id=post-date><time datetime=2022-02-10>2022-02-10 </time><span class=ml-1.75>21 min</span></div><div class="2xl:bg-secondary/0 2xl:border-none 2xl:fixed 2xl:left-0 2xl:max-w-[min(calc(50vw-38rem),13rem)] 2xl:top-44.5 bg-secondary/5 mb-6 uno-round-border" data-astro-cid-v5otsao3 id=toc-container><input data-astro-cid-v5otsao3 hidden id=toc-toggle type=checkbox><div class="w-full h-12 relative" data-astro-cid-v5otsao3><label class="flex absolute inset-0 items-center 2xl:c-secondary/40 2xl:ease-out 2xl:flex 2xl:hover:c-secondary/80 2xl:static 2xl:transition-colors cursor-pointer" data-astro-cid-v5otsao3 for=toc-toggle><span data-astro-cid-v5otsao3 id=toc-mobile-text>目录</span><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24" class="aspect-square 2xl:active:scale-90! 2xl:block 2xl:mt-4 2xl:origin-center hidden ml-4 w-4.2" data-astro-cid-v5otsao3=true id=toc-desktop-icon><path d="M22.2 2.3H1.8V4h19.9zM22.2 20H1.8v1.7h19.9zM15.5 11.2H1.8v1.6H15z"/></svg></label></div><div id=toc-accordion-wrapper data-astro-cid-v5otsao3><nav aria-label="Table of Contents" data-astro-cid-v5otsao3 id=toc-accordion-content><ul data-astro-cid-v5otsao3 id=toc-links-list><li class=ml-0 data-astro-cid-v5otsao3><a href=#what-is-maximum-likelihood class="highlight-hover no-heti toc-links-h2" data-astro-cid-v5otsao3>What is maximum likelihood</a></li><li class=ml-0 data-astro-cid-v5otsao3><a href=#how-to-get-likelihood class="highlight-hover no-heti toc-links-h2" data-astro-cid-v5otsao3>How to get likelihood</a></li><li class=ml-0 data-astro-cid-v5otsao3><a href=#说了那么多-到底怎么算呢 class="highlight-hover no-heti toc-links-h2" data-astro-cid-v5otsao3>说了那么多 到底怎么算呢</a></li></ul></nav></div></div><script type=module>let s=null,i=null;function g(){if(!(window.innerWidth>=1536))return;const t=document.getElementById("toc-accordion-content");if(!t)return;const e=t.getElementsByTagName("a");if(0===e.length)return;const n=Array.from(e,(t=>t)),o=n.some((t=>t.classList.contains("toc-links-h2")))?"toc-links-h2":"toc-links-h3",c=new Map;n.forEach((t=>{const e=t.getAttribute("href")?.substring(1);e&&c.set(e,t)}));let r=null;function l(t){t!==r&&(n.forEach((t=>{t.classList.remove("toc-link-active")})),t.classList.add("toc-link-active"),t.classList.contains(o)||function(t){for(let e=n.indexOf(t)-1;e>=0;e--){const t=n[e];if(t.classList.contains(o)){t.classList.add("toc-link-active");break}}}(t),r=t,t.scrollIntoView({behavior:"smooth",block:"nearest"}))}s=new IntersectionObserver((t=>{const e=t.find((t=>t.isIntersecting))?.target?.id;if(e){const t=c.get(e);t&&l(t)}}),{rootMargin:"0% 0% -66% 0%",threshold:[.4]}),Array.from(document.querySelectorAll("h2, h3, h4")).filter((t=>t.id&&"footnotes"!==t.id)).forEach((t=>s?.observe(t)));const a=document.getElementById("post-copyright");a&&(i=new IntersectionObserver((t=>{!t[0].isIntersecting&&t[0].boundingClientRect.top<0&&(n.forEach((t=>t.classList.remove("toc-link-active"))),r=null)}),{rootMargin:"0px 0px 0px 0px",threshold:0}),i?.observe(a),n.length>0&&l(n[0]))}function m(){s?.disconnect(),i?.disconnect(),s=null,i=null}document.addEventListener("astro:after-swap",g),document.addEventListener("astro:before-swap",m),g()</script><div id=post-content><p>太长了，分P</p><h1 id=数学补课>数学补课<a href=#数学补课 class=heading-anchor-link aria-label="Link to 数学补课"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M2.6 21.4c2 2 5.9 2.9 8.9 0l3.5-3.5-1-1-3.5 3.5c-1.4 1.4-4.2 1.9-6.4-.3s-1.8-5-.3-6.4l3.5-3.5-1-1-3.5 3.5c-3 3-2 6.9 0 8.9ZM21.4 2.6c2 2 2.9 5.9 0 8.9L17.9 15l-1-1 3.5-3.5c1.4-1.4 1.9-4.2-.3-6.4s-5-1.8-6.4-.3l-3.5 3.5-1-1 3.5-3.5c3-3 6.9-2 8.9 0Z"></path><path d="m8.01 14.97 6.93-6.93 1.061 1.06-6.93 6.93z"></path></svg></a></h1><h2 id=what-is-maximum-likelihood>What is maximum likelihood<a href=#what-is-maximum-likelihood class=heading-anchor-link aria-label="Link to What is maximum likelihood"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M2.6 21.4c2 2 5.9 2.9 8.9 0l3.5-3.5-1-1-3.5 3.5c-1.4 1.4-4.2 1.9-6.4-.3s-1.8-5-.3-6.4l3.5-3.5-1-1-3.5 3.5c-3 3-2 6.9 0 8.9ZM21.4 2.6c2 2 2.9 5.9 0 8.9L17.9 15l-1-1 3.5-3.5c1.4-1.4 1.9-4.2-.3-6.4s-5-1.8-6.4-.3l-3.5 3.5-1-1 3.5-3.5c3-3 6.9-2 8.9 0Z"></path><path d="m8.01 14.97 6.93-6.93 1.061 1.06-6.93 6.93z"></path></svg></a></h2><p>the likelihood is the possibility that fit a distribution</p><p>例えば 抛一枚匀质硬币，抛10次，6次正面向上的可能性多大？ 这里的可能性是probability 是某个时间发生的可能性</p><p>而似然值是给定某一结果，求是这个分布的可能性。</p><p>例如 抛一枚硬币，抛10次，结果是6次正面向上，其是匀质的可能性多大？</p><p>再举个例子，比如经过统计，这次期末考试泛函分析的成绩服从<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mi>N</mi><mo stretchy=false>(</mo><mn>80</mn><mo separator=true>,</mo><msup><mn>4</mn><mn>2</mn></msup><mo stretchy=false>)</mo></mrow><annotation encoding=application/x-tex>N(80,4^2)</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:1.0641em;vertical-align:-.25em class=strut></span><span style=margin-right:.10903em class="mord mathnormal">N</span><span class=mopen>(</span><span class=mord>80</span><span class=mpunct>,</span><span style=margin-right:.1667em class=mspace></span><span class=mord><span class=mord>4</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span style=height:.8141em class=vlist><span style=top:-3.063em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class=mclose>)</span></span></span></span>，问小黄这次考了90分的概率是多少。这个计算的就是probability</p><p>再比如，小黄这次考了90，问这次期末考试泛函服从<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mi>N</mi><mo stretchy=false>(</mo><mn>80</mn><mo separator=true>,</mo><msup><mn>4</mn><mn>2</mn></msup><mo stretchy=false>)</mo></mrow><annotation encoding=application/x-tex>N(80,4^2 )</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:1.0641em;vertical-align:-.25em class=strut></span><span style=margin-right:.10903em class="mord mathnormal">N</span><span class=mopen>(</span><span class=mord>80</span><span class=mpunct>,</span><span style=margin-right:.1667em class=mspace></span><span class=mord><span class=mord>4</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span style=height:.8141em class=vlist><span style=top:-3.063em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class=mclose>)</span></span></span></span>的概率是多少，这个就是likelihood。</p><p>我们要用的就是这个，来选取一个让likelihood最大的参数。</p><p>那么，怎么计算likelihood呢？</p><h2 id=how-to-get-likelihood>How to get likelihood<a href=#how-to-get-likelihood class=heading-anchor-link aria-label="Link to How to get likelihood"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M2.6 21.4c2 2 5.9 2.9 8.9 0l3.5-3.5-1-1-3.5 3.5c-1.4 1.4-4.2 1.9-6.4-.3s-1.8-5-.3-6.4l3.5-3.5-1-1-3.5 3.5c-3 3-2 6.9 0 8.9ZM21.4 2.6c2 2 2.9 5.9 0 8.9L17.9 15l-1-1 3.5-3.5c1.4-1.4 1.9-4.2-.3-6.4s-5-1.8-6.4-.3l-3.5 3.5-1-1 3.5-3.5c3-3 6.9-2 8.9 0Z"></path><path d="m8.01 14.97 6.93-6.93 1.061 1.06-6.93 6.93z"></path></svg></a></h2><p>其实这个问题就是极大似然估计。</p><p>我到这里才发现这个概念我大二就学过，然而现在完全忘记了。</p><p>就当复习了。</p><p>我们来换个更简单一点的问题来理解这个概念，最简单的分布是二项分布。这里我们就拿抛硬币为例。</p><p>在我拿硬币举例子的时候其实就暗含了一个要求，就是每个事件是独立的。只要能够用到likelihood这个概念，就得要求每个事件都是独立的。</p><p>一个质量均匀的硬币，抛出来是正面的概率 是0.5这里这个概率是probability。</p><p>一个硬币，抛了一次是正面，求下一次抛出来是正面的概率（即确定这个二项分布的参数），这个是likelihood。</p><p>但是我们举得这个例子显然无法计算出来likelihood，因为样本太少了。从直觉来想，我们需要做足够多的采样，用频率来替代概率。更学术一点，这个东西其实就是大数定律和中心极限定理。</p><p>###　大数定律和中心极限定理</p><p>这是整个数理统计最基础的东西了，既然复习我们就复习到底</p><p><strong>例子：</strong> 抛一个均匀的硬币，正面朝上和反面朝上的概率是相等的。我们把正面朝上的频率记为 <span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><msub><mi>v</mi><mi>n</mi></msub><mo>=</mo><msub><mi>S</mi><mi>n</mi></msub><mi mathvariant=normal>/</mi><mi>n</mi></mrow><annotation encoding=application/x-tex>v_n=S_n/n</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:.5806em;vertical-align:-.15em class=strut></span><span class=mord><span style=margin-right:.03588em class="mord mathnormal">v</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1514em class=vlist><span style=top:-2.55em;margin-left:-.0359em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mathnormal mtight">n</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span><span style=margin-right:.2778em class=mspace></span><span class=mrel>=</span><span style=margin-right:.2778em class=mspace></span></span><span class=base><span style=height:1em;vertical-align:-.25em class=strut></span><span class=mord><span style=margin-right:.05764em class="mord mathnormal">S</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1514em class=vlist><span style=top:-2.55em;margin-left:-.0576em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mathnormal mtight">n</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span><span class=mord>/</span><span class="mord mathnormal">n</span></span></span></span>，其中<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><msub><mi>S</mi><mi>n</mi></msub></mrow><annotation encoding=application/x-tex>S_n</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:.8333em;vertical-align:-.15em class=strut></span><span class=mord><span style=margin-right:.05764em class="mord mathnormal">S</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1514em class=vlist><span style=top:-2.55em;margin-left:-.0576em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mathnormal mtight">n</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span></span></span></span>为正面朝上出现的次数，n为抛硬币的总次数，那么当把硬币一直抛下去，我们会发现频率序列 <span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><msub><mi>v</mi><mi>n</mi></msub></mrow><annotation encoding=application/x-tex>{v_n}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:.5806em;vertical-align:-.15em class=strut></span><span class=mord><span class=mord><span style=margin-right:.03588em class="mord mathnormal">v</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1514em class=vlist><span style=top:-2.55em;margin-left:-.0359em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mathnormal mtight">n</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span></span></span></span></span> 会出现两个现象：</p><ol><li>频率 <span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><msub><mi>v</mi><mi>n</mi></msub></mrow><annotation encoding=application/x-tex>{v_n}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:.5806em;vertical-align:-.15em class=strut></span><span class=mord><span class=mord><span style=margin-right:.03588em class="mord mathnormal">v</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1514em class=vlist><span style=top:-2.55em;margin-left:-.0359em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mathnormal mtight">n</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span></span></span></span></span> 对频率p的绝对偏差 <span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mi mathvariant=normal>∣</mi><msub><mi>v</mi><mi>n</mi></msub><mo>−</mo><mi>p</mi><mi mathvariant=normal>∣</mi></mrow><annotation encoding=application/x-tex>|v_n-p|</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:1em;vertical-align:-.25em class=strut></span><span class=mord>∣</span><span class=mord><span style=margin-right:.03588em class="mord mathnormal">v</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1514em class=vlist><span style=top:-2.55em;margin-left:-.0359em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mathnormal mtight">n</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span><span style=margin-right:.2222em class=mspace></span><span class=mbin>−</span><span style=margin-right:.2222em class=mspace></span></span><span class=base><span style=height:1em;vertical-align:-.25em class=strut></span><span class="mord mathnormal">p</span><span class=mord>∣</span></span></span></span> 将随着n的增大而呈现逐渐减小的趋势，但无法说它就收敛域0</li><li>由于频率的随机性，绝对偏差 <span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mi mathvariant=normal>∣</mi><msub><mi>v</mi><mi>n</mi></msub><mo>−</mo><mi>p</mi><mi mathvariant=normal>∣</mi></mrow><annotation encoding=application/x-tex>|v_n-p|</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:1em;vertical-align:-.25em class=strut></span><span class=mord>∣</span><span class=mord><span style=margin-right:.03588em class="mord mathnormal">v</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1514em class=vlist><span style=top:-2.55em;margin-left:-.0359em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mathnormal mtight">n</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span><span style=margin-right:.2222em class=mspace></span><span class=mbin>−</span><span style=margin-right:.2222em class=mspace></span></span><span class=base><span style=height:1em;vertical-align:-.25em class=strut></span><span class="mord mathnormal">p</span><span class=mord>∣</span></span></span></span> 时大时小，虽然我们无法排除大偏差发生的可能性，但随着n的不断增大，大偏差发生的可能性会越来越小。 <strong>这是一种新的极限概念</strong></li></ol><p>定义</p><p>如果对于任何<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mi>ε</mi></mrow><annotation encoding=application/x-tex>\varepsilon</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:.4306em class=strut></span><span class="mord mathnormal">ε</span></span></span></span>，都有</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML display=block><semantics><mrow><munder><mrow><mi>lim</mi><mo>⁡</mo></mrow><mrow><mi>n</mi><mo>→</mo><mi mathvariant=normal>∞</mi></mrow></munder><mi>P</mi><mo stretchy=false>(</mo><mi mathvariant=normal>∣</mi><msub><mi>ξ</mi><mi>n</mi></msub><mo>−</mo><mi>ξ</mi><mi mathvariant=normal>∣</mi><mo>≥</mo><mi>ε</mi><mo stretchy=false>)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding=application/x-tex>\lim_{n\to\infty}P(|\xi_n-\xi|\ge\varepsilon)=0</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:1.45em;vertical-align:-.7em class=strut></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.6944em class=vlist><span style=top:-2.4em;margin-left:0><span style=height:3em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mtight mrel">→</span><span class="mord mtight">∞</span></span></span></span><span style=top:-3em><span style=height:3em class=pstrut></span><span><span class=mop>lim</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.7em class=vlist><span></span></span></span></span></span><span style=margin-right:.1667em class=mspace></span><span style=margin-right:.13889em class="mord mathnormal">P</span><span class=mopen>(</span><span class=mord>∣</span><span class=mord><span style=margin-right:.04601em class="mord mathnormal">ξ</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1514em class=vlist><span style=top:-2.55em;margin-left:-.046em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mathnormal mtight">n</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span><span style=margin-right:.2222em class=mspace></span><span class=mbin>−</span><span style=margin-right:.2222em class=mspace></span></span><span class=base><span style=height:1em;vertical-align:-.25em class=strut></span><span style=margin-right:.04601em class="mord mathnormal">ξ</span><span class=mord>∣</span><span style=margin-right:.2778em class=mspace></span><span class=mrel>≥</span><span style=margin-right:.2778em class=mspace></span></span><span class=base><span style=height:1em;vertical-align:-.25em class=strut></span><span class="mord mathnormal">ε</span><span class=mclose>)</span><span style=margin-right:.2778em class=mspace></span><span class=mrel>=</span><span style=margin-right:.2778em class=mspace></span></span><span class=base><span style=height:.6444em class=strut></span><span class=mord>0</span></span></span></span></span><p>那么我们就称随机变量序列{<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><msub><mi>ξ</mi><mi>n</mi></msub><mo separator=true>,</mo><mi>n</mi><mo>∈</mo><mi>N</mi></mrow><annotation encoding=application/x-tex>\xi_n,n\in N</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:.8889em;vertical-align:-.1944em class=strut></span><span class=mord><span style=margin-right:.04601em class="mord mathnormal">ξ</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1514em class=vlist><span style=top:-2.55em;margin-left:-.046em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mathnormal mtight">n</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span><span class=mpunct>,</span><span style=margin-right:.1667em class=mspace></span><span class="mord mathnormal">n</span><span style=margin-right:.2778em class=mspace></span><span class=mrel>∈</span><span style=margin-right:.2778em class=mspace></span></span><span class=base><span style=height:.6833em class=strut></span><span style=margin-right:.10903em class="mord mathnormal">N</span></span></span></span>}依概率收敛到随机变量<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mi>ξ</mi></mrow><annotation encoding=application/x-tex>\xi</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:.8889em;vertical-align:-.1944em class=strut></span><span style=margin-right:.04601em class="mord mathnormal">ξ</span></span></span></span>，记为<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><msub><mi>ξ</mi><mi>n</mi></msub><msup><mo>→</mo><mi>P</mi></msup><mi>ξ</mi></mrow><annotation encoding=application/x-tex>\xi_n\to^{P}\xi</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:1.0358em;vertical-align:-.1944em class=strut></span><span class=mord><span style=margin-right:.04601em class="mord mathnormal">ξ</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1514em class=vlist><span style=top:-2.55em;margin-left:-.046em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mathnormal mtight">n</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span><span style=margin-right:.2778em class=mspace></span><span class=mrel><span class=mrel>→</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span style=height:.8413em class=vlist><span style=top:-3.063em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mtight"><span style=margin-right:.13889em class="mord mathnormal mtight">P</span></span></span></span></span></span></span></span></span><span style=margin-right:.2778em class=mspace></span></span><span class=base><span style=height:.8889em;vertical-align:-.1944em class=strut></span><span style=margin-right:.04601em class="mord mathnormal">ξ</span></span></span></span></p><p>依概率收敛的含义是：<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><msub><mi>ξ</mi><mi>n</mi></msub></mrow><annotation encoding=application/x-tex>\xi_n</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:.8889em;vertical-align:-.1944em class=strut></span><span class=mord><span style=margin-right:.04601em class="mord mathnormal">ξ</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1514em class=vlist><span style=top:-2.55em;margin-left:-.046em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mathnormal mtight">n</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span></span></span></span> 对<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mi>ξ</mi></mrow><annotation encoding=application/x-tex>\xi</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:.8889em;vertical-align:-.1944em class=strut></span><span style=margin-right:.04601em class="mord mathnormal">ξ</span></span></span></span> 的绝对偏差不小于任意给定量的可能性将随着n的增大而越来越小。反过来说，绝对偏差<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mi mathvariant=normal>∣</mi><msub><mi>ξ</mi><mi>n</mi></msub><mo>−</mo><mi>ξ</mi><mi mathvariant=normal>∣</mi></mrow><annotation encoding=application/x-tex>|\xi_n-\xi|</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:1em;vertical-align:-.25em class=strut></span><span class=mord>∣</span><span class=mord><span style=margin-right:.04601em class="mord mathnormal">ξ</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1514em class=vlist><span style=top:-2.55em;margin-left:-.046em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mathnormal mtight">n</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span><span style=margin-right:.2222em class=mspace></span><span class=mbin>−</span><span style=margin-right:.2222em class=mspace></span></span><span class=base><span style=height:1em;vertical-align:-.25em class=strut></span><span style=margin-right:.04601em class="mord mathnormal">ξ</span><span class=mord>∣</span></span></span></span>小于任一给定量的可能性将随着 n的增大而越来越接近与1。</p><p>我们来换个写法</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML display=block><semantics><mrow><munder><mrow><mi>lim</mi><mo>⁡</mo></mrow><mrow><mi>n</mi><mo>→</mo><mi mathvariant=normal>∞</mi></mrow></munder><mi>P</mi><mo stretchy=false>(</mo><mi mathvariant=normal>∣</mi><msub><mi>ξ</mi><mi>n</mi></msub><mo>−</mo><mi>ξ</mi><mi mathvariant=normal>∣</mi><mo>≤</mo><mi>ε</mi><mo stretchy=false>)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding=application/x-tex>\lim_{n\to\infty}P(|\xi_n-\xi|\leq\varepsilon)=1</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:1.45em;vertical-align:-.7em class=strut></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.6944em class=vlist><span style=top:-2.4em;margin-left:0><span style=height:3em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mtight mrel">→</span><span class="mord mtight">∞</span></span></span></span><span style=top:-3em><span style=height:3em class=pstrut></span><span><span class=mop>lim</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.7em class=vlist><span></span></span></span></span></span><span style=margin-right:.1667em class=mspace></span><span style=margin-right:.13889em class="mord mathnormal">P</span><span class=mopen>(</span><span class=mord>∣</span><span class=mord><span style=margin-right:.04601em class="mord mathnormal">ξ</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1514em class=vlist><span style=top:-2.55em;margin-left:-.046em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mathnormal mtight">n</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span><span style=margin-right:.2222em class=mspace></span><span class=mbin>−</span><span style=margin-right:.2222em class=mspace></span></span><span class=base><span style=height:1em;vertical-align:-.25em class=strut></span><span style=margin-right:.04601em class="mord mathnormal">ξ</span><span class=mord>∣</span><span style=margin-right:.2778em class=mspace></span><span class=mrel>≤</span><span style=margin-right:.2778em class=mspace></span></span><span class=base><span style=height:1em;vertical-align:-.25em class=strut></span><span class="mord mathnormal">ε</span><span class=mclose>)</span><span style=margin-right:.2778em class=mspace></span><span class=mrel>=</span><span style=margin-right:.2778em class=mspace></span></span><span class=base><span style=height:.6444em class=strut></span><span class=mord>1</span></span></span></span></span><p>举个例子就是<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><msub><mi>v</mi><mi>n</mi></msub></mrow><annotation encoding=application/x-tex>v_n</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:.5806em;vertical-align:-.15em class=strut></span><span class=mord><span style=margin-right:.03588em class="mord mathnormal">v</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1514em class=vlist><span style=top:-2.55em;margin-left:-.0359em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mathnormal mtight">n</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span></span></span></span>这个序列将越来越倾向于某一个数。</p><p>其实这个东西，就是叫大数定理</p><p>定理</p><p>在n次独立重复实验中，事件A发生了<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><msub><mi>k</mi><mi>n</mi></msub></mrow><annotation encoding=application/x-tex>k_n</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:.8444em;vertical-align:-.15em class=strut></span><span class=mord><span style=margin-right:.03148em class="mord mathnormal">k</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1514em class=vlist><span style=top:-2.55em;margin-left:-.0315em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mathnormal mtight">n</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span></span></span></span>次，且<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mi>P</mi><mo stretchy=false>(</mo><mi>A</mi><mo stretchy=false>)</mo><mo>=</mo><mi>p</mi></mrow><annotation encoding=application/x-tex>P(A)=p</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:1em;vertical-align:-.25em class=strut></span><span style=margin-right:.13889em class="mord mathnormal">P</span><span class=mopen>(</span><span class="mord mathnormal">A</span><span class=mclose>)</span><span style=margin-right:.2778em class=mspace></span><span class=mrel>=</span><span style=margin-right:.2778em class=mspace></span></span><span class=base><span style=height:.625em;vertical-align:-.1944em class=strut></span><span class="mord mathnormal">p</span></span></span></span>，则对任意<span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML><semantics><mrow><mi>ε</mi><mo>></mo><mn>0</mn></mrow><annotation encoding=application/x-tex>\varepsilon>0</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:.5782em;vertical-align:-.0391em class=strut></span><span class="mord mathnormal">ε</span><span style=margin-right:.2778em class=mspace></span><span class=mrel>></span><span style=margin-right:.2778em class=mspace></span></span><span class=base><span style=height:.6444em class=strut></span><span class=mord>0</span></span></span></span>，有</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML display=block><semantics><mrow><munder><mrow><mi>lim</mi><mo>⁡</mo></mrow><mrow><mi>n</mi><mo>→</mo><mi mathvariant=normal>∞</mi></mrow></munder><mi>P</mi><mo stretchy=false>(</mo><mi mathvariant=normal>∣</mi><mfrac><msub><mi>k</mi><mi>n</mi></msub><mi>n</mi></mfrac><mo>−</mo><mi>p</mi><mi mathvariant=normal>∣</mi><mo>&#x3C;</mo><mi>ε</mi><mo stretchy=false>)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding=application/x-tex>\lim_{n\to\infty}P(|\frac{k_n}{n}-p|&#x3C;\varepsilon)=0</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:2.0714em;vertical-align:-.7em class=strut></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.6944em class=vlist><span style=top:-2.4em;margin-left:0><span style=height:3em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mtight mrel">→</span><span class="mord mtight">∞</span></span></span></span><span style=top:-3em><span style=height:3em class=pstrut></span><span><span class=mop>lim</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.7em class=vlist><span></span></span></span></span></span><span style=margin-right:.1667em class=mspace></span><span style=margin-right:.13889em class="mord mathnormal">P</span><span class=mopen>(</span><span class=mord>∣</span><span class=mord><span class="mopen nulldelimiter"></span><span class=mfrac><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:1.3714em class=vlist><span style=top:-2.314em><span style=height:3em class=pstrut></span><span class=mord><span class="mord mathnormal">n</span></span></span><span style=top:-3.23em><span style=height:3em class=pstrut></span><span style=border-bottom-width:.04em class=frac-line></span></span><span style=top:-3.677em><span style=height:3em class=pstrut></span><span class=mord><span class=mord><span style=margin-right:.03148em class="mord mathnormal">k</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.1514em class=vlist><span style=top:-2.55em;margin-left:-.0315em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mathnormal mtight">n</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.15em class=vlist><span></span></span></span></span></span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.686em class=vlist><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span style=margin-right:.2222em class=mspace></span><span class=mbin>−</span><span style=margin-right:.2222em class=mspace></span></span><span class=base><span style=height:1em;vertical-align:-.25em class=strut></span><span class="mord mathnormal">p</span><span class=mord>∣</span><span style=margin-right:.2778em class=mspace></span><span class=mrel>&#x3C;</span><span style=margin-right:.2778em class=mspace></span></span><span class=base><span style=height:1em;vertical-align:-.25em class=strut></span><span class="mord mathnormal">ε</span><span class=mclose>)</span><span style=margin-right:.2778em class=mspace></span><span class=mrel>=</span><span style=margin-right:.2778em class=mspace></span></span><span class=base><span style=height:.6444em class=strut></span><span class=mord>0</span></span></span></span></span><p>这个东西就是伯努利大数定律，可以利用切比雪夫不等式来证明。</p><p>很容易可以看到，伯努利大数定律是针对二项分布的一个特殊情况。</p><p>除了这个还有。</p><table><thead><tr><th>切比雪夫大数定律</th><th><img alt="X_{1}, X_{2}, \cdots" src="https://math.fivecakes.com/?latex=X_%7B1%7D%2C%20X_%7B2%7D%2C%20%5Ccdots"> 独立，存在期望及方差，且方差有界</th><th><img alt="\frac{1}{n} \sum_{k=1}^{n} X_{k}\stackrel{P}{\longrightarrow}\frac{1}{n} \sum_{k=1}^{n} E\left(X_{k}\right)" src="https://math.fivecakes.com/?latex=%5Cfrac%7B1%7D%7Bn%7D%20%5Csum_%7Bk%3D1%7D%5E%7Bn%7D%20X_%7Bk%7D%5Cstackrel%7BP%7D%7B%5Clongrightarrow%7D%5Cfrac%7B1%7D%7Bn%7D%20%5Csum_%7Bk%3D1%7D%5E%7Bn%7D%20E%5Cleft(X_%7Bk%7D%5Cright)"></th></tr></thead><tbody><tr><td>伯努利大数定律</td><td><img alt="n_{A} \sim B(n, p)" src="https://math.fivecakes.com/?latex=n_%7BA%7D%20%5Csim%20B(n%2C%20p)"></td><td><img alt=\frac{n_{A}}{n}\stackrel{P}{\longrightarrow}p src="https://math.fivecakes.com/?latex=%5Cfrac%7Bn_%7BA%7D%7D%7Bn%7D%5Cstackrel%7BP%7D%7B%5Clongrightarrow%7Dp"></td></tr><tr><td>辛钦大数定律</td><td><img alt="X_{1}, X_{2}, \cdots" src="https://math.fivecakes.com/?latex=X_%7B1%7D%2C%20X_%7B2%7D%2C%20%5Ccdots"> 独立同分布，期望为<img alt=\mu src="https://math.fivecakes.com/?latex=%5Cmu"></td><td>![\frac{1}{n} \sum_{k=1}^{n} X_{k}\stackrel{P}{\longrightarrow}\mu](<a href="https://math.fivecakes.com/?latex=%5Cfrac%7B1%7D%7Bn%7D" rel="nofollow noopener noreferrer external" target=_blank>https://math.fivecakes.com/?latex=\frac{1}{n}</a> \sum_{k%3D1}^{n} X_{k}\stackrel{P}{\longrightarrow}\mu)</td></tr></tbody></table><p>切比雪夫大数定律是最宽泛的大数定律，不需要每个序列具有相同的分布；辛钦大数定律则是在他们分布相同的情况下的特殊情况，没有规定是什么分布；伯努利大数定律则是这个分布是二项分布的特殊情况。大数定律的左边的本质是求整个随机变量分布列的平均数，右边则是总体的平均值（期望），即样本的平均值等于总体的平均值。</p><p>在概率论中, <strong>中心极限定理</strong>是对一列独立同分布的随机变量之平均值的描述.</p><p>具体而言, 大数定律表明, 对一列独立同分布的随机变量而言, 当随机变量的个数 <em>n</em>→∞ 时, 其均值几乎必然收敛于其期望. 中心极限定理则表明, 其均值与期望的差大约满足 1/<em>n</em> 倍的正态分布 N(0,<em>σ</em>2), 其中 <em>σ</em>2 是原来随机变量的方差.</p><p><strong>同分布的中心极限定理</strong> 设 X1, X2, …, Xn 相互独立，服从同一分布，具有数学期望和方差：</p><p><a href=https://db.yihui.org/hexun/b_4FE2288307FFF259.jpg rel="nofollow noopener noreferrer external" target=_blank><img alt=img src=https://db.yihui.org/hexun/b_4FE2288307FFF259.jpg></a></p><p>则对任意的 x，恒有</p><p><a href=https://db.yihui.org/hexun/b_94BC3E85BB876C97.jpg rel="nofollow noopener noreferrer external" target=_blank><img alt=img src=https://db.yihui.org/hexun/b_94BC3E85BB876C97.jpg></a></p><h2 id=说了那么多-到底怎么算呢>说了那么多 到底怎么算呢<a href=#说了那么多-到底怎么算呢 class=heading-anchor-link aria-label="Link to 说了那么多 到底怎么算呢"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M2.6 21.4c2 2 5.9 2.9 8.9 0l3.5-3.5-1-1-3.5 3.5c-1.4 1.4-4.2 1.9-6.4-.3s-1.8-5-.3-6.4l3.5-3.5-1-1-3.5 3.5c-3 3-2 6.9 0 8.9ZM21.4 2.6c2 2 2.9 5.9 0 8.9L17.9 15l-1-1 3.5-3.5c1.4-1.4 1.9-4.2-.3-6.4s-5-1.8-6.4-.3l-3.5 3.5-1-1 3.5-3.5c3-3 6.9-2 8.9 0Z"></path><path d="m8.01 14.97 6.93-6.93 1.061 1.06-6.93 6.93z"></path></svg></a></h2><p>我们这里来抛十次硬币试试，似然函数通常用<em>L</em>表示，对应英文Likelihood。观察到抛硬币“6正4反”的事实，硬币参数<em>θ</em>取不同值时，似然函数表示为：</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns=http://www.w3.org/1998/Math/MathML display=block><semantics><mrow><mi>L</mi><mo stretchy=false>(</mo><mi>θ</mi><mo separator=true>;</mo><mn>6</mn><mtext>正</mtext><mn>4</mn><mtext>反</mtext><mo stretchy=false>)</mo><mo>=</mo><msubsup><mi>C</mi><mn>10</mn><mn>6</mn></msubsup><mo>∗</mo><msup><mi>θ</mi><mn>6</mn></msup><mo>∗</mo><mo stretchy=false>(</mo><mn>1</mn><mo>−</mo><mi>θ</mi><msup><mo stretchy=false>)</mo><mn>4</mn></msup></mrow><annotation encoding=application/x-tex>L(\theta;6正4反)=C^6_{10}*\theta^6*(1-\theta)^4</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span style=height:1em;vertical-align:-.25em class=strut></span><span class="mord mathnormal">L</span><span class=mopen>(</span><span style=margin-right:.02778em class="mord mathnormal">θ</span><span class=mpunct>;</span><span style=margin-right:.1667em class=mspace></span><span class=mord>6</span><span class="mord cjk_fallback">正</span><span class=mord>4</span><span class="mord cjk_fallback">反</span><span class=mclose>)</span><span style=margin-right:.2778em class=mspace></span><span class=mrel>=</span><span style=margin-right:.2778em class=mspace></span></span><span class=base><span style=height:1.1111em;vertical-align:-.247em class=strut></span><span class=mord><span style=margin-right:.07153em class="mord mathnormal">C</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span style=height:.8641em class=vlist><span style=top:-2.453em;margin-left:-.0715em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mtight"><span class="mord mtight">10</span></span></span></span><span style=top:-3.113em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mtight">6</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span style=height:.247em class=vlist><span></span></span></span></span></span></span><span style=margin-right:.2222em class=mspace></span><span class=mbin>∗</span><span style=margin-right:.2222em class=mspace></span></span><span class=base><span style=height:.8641em class=strut></span><span class=mord><span style=margin-right:.02778em class="mord mathnormal">θ</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span style=height:.8641em class=vlist><span style=top:-3.113em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mtight">6</span></span></span></span></span></span></span></span><span style=margin-right:.2222em class=mspace></span><span class=mbin>∗</span><span style=margin-right:.2222em class=mspace></span></span><span class=base><span style=height:1em;vertical-align:-.25em class=strut></span><span class=mopen>(</span><span class=mord>1</span><span style=margin-right:.2222em class=mspace></span><span class=mbin>−</span><span style=margin-right:.2222em class=mspace></span></span><span class=base><span style=height:1.1141em;vertical-align:-.25em class=strut></span><span style=margin-right:.02778em class="mord mathnormal">θ</span><span class=mclose><span class=mclose>)</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span style=height:.8641em class=vlist><span style=top:-3.113em;margin-right:.05em><span style=height:2.7em class=pstrut></span><span class="mtight reset-size6 size3 sizing"><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span></span><p>这个公式的图形如下图所示。从图中可以看出：参数θ*为0.6时，似然函数最大，参数为其他值时，“6正4反”发生的概率都相对更小。在这个赌局中，我会猜测下次硬币为正，因为根据已有观察，硬币很可能以0.6的概率为正。</p><figure><img alt=“6正4反”的似然函数 src=https://raw.githubusercontent.com/lifeodyssey/Figurebed/master/image/gamewin202202131440250.png><figcaption>“6正4反”的似然函数</figcaption></figure><p>推广到更为一般的场景，似然函数的一般形式可以用下面公式来表示，也就是之前提到的，各个样本发生的概率的乘积。</p><figure><img alt=image-20220213144122733 src=https://raw.githubusercontent.com/lifeodyssey/Figurebed/master/image/gamewin202202131441773.png><figcaption>image-20220213144122733</figcaption></figure><p>这里还涉及到一个东西叫极大似然估计，不过好像这篇论文的loss就只是用了极大似然值，先在这里省略一下</p><p>参考资料</p><p>lulaoshi.info/machine-learning/linear-model/maximum-likelihood-estimation</p><p><a href=https://www.cnblogs.com/BlairGrowing/p/14877125.html rel="nofollow noopener noreferrer external" target=_blank>https://www.cnblogs.com/BlairGrowing/p/14877125.html</a></p><h1 id=来看代码>来看代码<a href=#来看代码 class=heading-anchor-link aria-label="Link to 来看代码"><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M2.6 21.4c2 2 5.9 2.9 8.9 0l3.5-3.5-1-1-3.5 3.5c-1.4 1.4-4.2 1.9-6.4-.3s-1.8-5-.3-6.4l3.5-3.5-1-1-3.5 3.5c-3 3-2 6.9 0 8.9ZM21.4 2.6c2 2 2.9 5.9 0 8.9L17.9 15l-1-1 3.5-3.5c1.4-1.4 1.9-4.2-.3-6.4s-5-1.8-6.4-.3l-3.5 3.5-1-1 3.5-3.5c3-3 6.9-2 8.9 0Z"></path><path d="m8.01 14.97 6.93-6.93 1.061 1.06-6.93 6.93z"></path></svg></a></h1><p>然后再来看看论文的源代码.</p><p>写的好长…而且是用tensorflow写的..自己这不是得重写了…</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#d73a49;--shiki-dark:#F97583>class</span><span style=color:#6f42c1;--shiki-dark:#B392F0> MDN</span><span style=color:#24292e;--shiki-dark:#E1E4E8>:</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	''' Mixture Density Network which handles multi-output, full (symmetric) covariance.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	Parameters</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	----------</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	n_mix : int, optional (default=5)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		Number of mixtures used in the gaussian mixture model.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	hidden : list, optional (default=[100, 100, 100, 100, 100])</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		Number of layers and hidden units per layer in the neural network.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	lr : float, optional (default=1e-3)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		Learning rate for the model.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	l2 : float, optional (default=1e-3)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		L2 regularization scale for the model weights.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	n_iter : int, optional (default=1e4)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		Number of iterations to train the model for </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	batch : int, optional (default=128)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		Size of the minibatches for stochastic optimization.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	imputations : int, optional (default=5)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		Number of samples used in multiple imputation when handling NaN</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		target values during training. More samples results in a higher</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		accuracy for the likelihood estimate, but takes longer and may</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		result in overfitting. Assumption is that any missing data is </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		MAR / MCAR, in order to allow a multiple imputation approach.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	epsilon : float, optional (default=1e-3)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		Normalization constant added to diagonal of the covariance matrix.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	activation : str, optional (default=relu)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		Activation function applied to hidden layers.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	scalerx : transformer, optional (default=IdentityTransformer)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		Transformer which has fit, transform, and inverse_transform methods</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		(i.e. follows the format of sklearn transformers). Scales the x </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		values prior to training / prediction. Stored along with the saved</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		model in order to have consistent inputs to the model.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	scalery : transformer, optional (default=IdentityTransformer)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		Transformer which has fit, transform, and inverse_transform methods</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		(i.e. follows the format of sklearn transformers). Scales the y </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		values prior to training, and the output values after prediction. </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		Stored along with the saved model in order to have consistent </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		outputs from the model.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	model_path : pathlib.Path, optional (default=./Weights)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		Folder location to store saved models.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	model_name : str, optional (default=MDN)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		Name to assign to the model. </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	no_load : bool, optional (default=False)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		If true, train a new model rather than loading a previously </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		trained one.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	no_save : bool, optional (default=False)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		If true, do not save the model when training is completed.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	seed : int, optional (default=None)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		Random seed. If set, ensure consistent output.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	verbose : bool, optional (default=False)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		If true, print various information while loading / training.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	debug : bool, optional (default=False)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		If true, use control flow dependencies to determine where NaN</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		values are entering the model. Model runs slower with this </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		parameter set to true.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	'''</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>	distribution </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 'MultivariateNormalTriL'</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#005cc5;--shiki-dark:#79B8FF> __init__</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, n_mix</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>5</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, hidden</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>100</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]</span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#005cc5;--shiki-dark:#79B8FF>5</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, lr</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1e-3</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, l2</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1e-3</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, n_iter</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1e4</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>				 batch</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>128</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, imputations</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>5</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, epsilon</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1e-3</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>				 activation</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'relu'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>				 scalerx</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>None</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, scalery</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>None</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>				 model_path</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Weights'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, model_name</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'MDN'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>				 no_load</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>False</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, no_save</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>False</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>				 seed</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>None</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, verbose</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>False</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, debug</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>False</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#d73a49;--shiki-dark:#F97583>**</span><span style=color:#24292e;--shiki-dark:#E1E4E8>kwargs):</span></span>
<span class=line></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		config </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> initialize_random_states(seed)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		config.update({</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'n_mix'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>        : n_mix,</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'hidden'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>       : </span><span style=color:#005cc5;--shiki-dark:#79B8FF>list</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(np.atleast_1d(hidden)),</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'lr'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>           : lr,</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'l2'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>           : l2,</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'n_iter'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>       : n_iter,</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'batch'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>        : batch,</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'imputations'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>  : imputations,</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'epsilon'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>      : epsilon,</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'activation'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>   : activation,</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'scalerx'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>      : scalerx </span><span style=color:#d73a49;--shiki-dark:#F97583>if</span><span style=color:#24292e;--shiki-dark:#E1E4E8> scalerx </span><span style=color:#d73a49;--shiki-dark:#F97583>is</span><span style=color:#d73a49;--shiki-dark:#F97583> not</span><span style=color:#005cc5;--shiki-dark:#79B8FF> None</span><span style=color:#d73a49;--shiki-dark:#F97583> else</span><span style=color:#24292e;--shiki-dark:#E1E4E8> IdentityTransformer(),</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'scalery'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>      : scalery </span><span style=color:#d73a49;--shiki-dark:#F97583>if</span><span style=color:#24292e;--shiki-dark:#E1E4E8> scalery </span><span style=color:#d73a49;--shiki-dark:#F97583>is</span><span style=color:#d73a49;--shiki-dark:#F97583> not</span><span style=color:#005cc5;--shiki-dark:#79B8FF> None</span><span style=color:#d73a49;--shiki-dark:#F97583> else</span><span style=color:#24292e;--shiki-dark:#E1E4E8> IdentityTransformer(),</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'model_path'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>   : Path(model_path),</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'model_name'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>   : model_name,</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'no_load'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>      : no_load,</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'no_save'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>      : no_save,</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'seed'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>         : seed,</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'verbose'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>      : verbose,</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'debug'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>        : debug,</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		})</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>		self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.set_config(config)</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>#前面 构造函数 定义变量</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		for</span><span style=color:#24292e;--shiki-dark:#E1E4E8> k </span><span style=color:#d73a49;--shiki-dark:#F97583>in</span><span style=color:#24292e;--shiki-dark:#E1E4E8> kwargs: </span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>			warnings.warn(</span><span style=color:#d73a49;--shiki-dark:#F97583>f</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Unused keyword given to MDN: "</span><span style=color:#005cc5;--shiki-dark:#79B8FF>{</span><span style=color:#24292e;--shiki-dark:#E1E4E8>k</span><span style=color:#005cc5;--shiki-dark:#79B8FF>}</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>UserWarning</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> _predict_chunk</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, X, return_coefs</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>False</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, use_gpu</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>False</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#d73a49;--shiki-dark:#F97583>**</span><span style=color:#24292e;--shiki-dark:#E1E4E8>kwargs):</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		''' Generates estimates for the given set. X may be only a subset of the full</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			data, which speeds up the prediction process and limits memory consumption.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			use_gpu : bool, optional (default=False)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>				Use the GPU to generate estimates if True, otherwise use the CPU.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			 '''</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		with</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.device(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'/gpu:0'</span><span style=color:#d73a49;--shiki-dark:#F97583> if</span><span style=color:#24292e;--shiki-dark:#E1E4E8> use_gpu </span><span style=color:#d73a49;--shiki-dark:#F97583>else</span><span style=color:#032f62;--shiki-dark:#9ECBFF> '/cpu:0'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>):</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>#确定位置</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>			model_out </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.model( </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.scalerx.transform(ensure_format(X)) )</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>    #先处理成一样的类型</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>			coefs_out </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.get_coefs(model_out)</span><span style=color:#6a737d;--shiki-dark:#6A737D>#解析模型输出</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>			outputs   </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.extract_predictions(coefs_out, </span><span style=color:#d73a49;--shiki-dark:#F97583>**</span><span style=color:#24292e;--shiki-dark:#E1E4E8>kwargs)</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>	# 这个是得到最后的输出，</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>			if</span><span style=color:#24292e;--shiki-dark:#E1E4E8> return_coefs: </span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>				return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> outputs, [c.numpy() </span><span style=color:#d73a49;--shiki-dark:#F97583>for</span><span style=color:#24292e;--shiki-dark:#E1E4E8> c </span><span style=color:#d73a49;--shiki-dark:#F97583>in</span><span style=color:#24292e;--shiki-dark:#E1E4E8> coefs_out]</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>			return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> outputs</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>	@ignore_warnings</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> predict</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, X, chunk_size</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1e5</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, return_coefs</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>False</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#d73a49;--shiki-dark:#F97583>**</span><span style=color:#24292e;--shiki-dark:#E1E4E8>kwargs):</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>        #这个是预测的主函数</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		'''</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		Top level interface to get predictions for a given dataset, which wraps _predict_chunk </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		to generate estimates in smaller chunks. See the docstring of extract_predictions() for </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		a description of other keyword parameters that can be given. </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		chunk_size : int, optional (default=1e5)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			Controls the size of chunks which are estimated by the model. If None is passed,</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			chunking is not used and the model is given all of the X dataset at once. </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		return_coefs : bool, optional (default=False)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			If True, return the estimated coefficients (prior, mu, sigma) along with the </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			other requested outputs. Note that rescaling the coefficients using scalerx/y</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			is left up to the user, as calculations involving sigma must be performed in </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			the basis learned by the model.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		'''</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		chunk_size    </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> int</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(chunk_size </span><span style=color:#d73a49;--shiki-dark:#F97583>or</span><span style=color:#005cc5;--shiki-dark:#79B8FF> len</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(X))</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		partial_coefs </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> []</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		partial_estim </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> []</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		for</span><span style=color:#24292e;--shiki-dark:#E1E4E8> i </span><span style=color:#d73a49;--shiki-dark:#F97583>in</span><span style=color:#24292e;--shiki-dark:#E1E4E8> trange(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>len</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(X), chunk_size, </span><span style=color:#e36209;--shiki-dark:#FFAB70>disable</span><span style=color:#d73a49;--shiki-dark:#F97583>=not</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.verbose):</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>			chunk_est, chunk_coef </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>._predict_chunk(X[i:i</span><span style=color:#d73a49;--shiki-dark:#F97583>+</span><span style=color:#24292e;--shiki-dark:#E1E4E8>chunk_size], </span><span style=color:#e36209;--shiki-dark:#FFAB70>return_coefs</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>True</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#d73a49;--shiki-dark:#F97583>**</span><span style=color:#24292e;--shiki-dark:#E1E4E8>kwargs)</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>            # 把总的数据分成好几块来进行预测</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>            #每个小块都是在predict_chunk里预测的</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>			partial_coefs.append(chunk_coef)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>			partial_estim.append( np.array(chunk_est, </span><span style=color:#e36209;--shiki-dark:#FFAB70>ndmin</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>3</span><span style=color:#24292e;--shiki-dark:#E1E4E8>) )</span></span>
<span class=line></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		coefs </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> [np.vstack(c) </span><span style=color:#d73a49;--shiki-dark:#F97583>for</span><span style=color:#24292e;--shiki-dark:#E1E4E8> c </span><span style=color:#d73a49;--shiki-dark:#F97583>in</span><span style=color:#005cc5;--shiki-dark:#79B8FF> zip</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#24292e;--shiki-dark:#E1E4E8>partial_coefs)]</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		preds </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> np.hstack(partial_estim)</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		if</span><span style=color:#24292e;--shiki-dark:#E1E4E8> return_coefs:</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>			return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> preds, coefs </span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> preds</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> extract_predictions</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, coefs, confidence_interval</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>None</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, threshold</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>None</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, avg_est</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>False</span><span style=color:#24292e;--shiki-dark:#E1E4E8>):</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		'''</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		Function used to extract model predictions from the given set of </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		coefficients. Users should call the predict() method instead, if</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		predictions from input data are needed. </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		confidence_interval : float, optional (default=None)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			If a confidence interval value is given, then this function</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			returns (along with the predictions) the upper and lower </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			{confidence_interval*100}% confidence bounds around the prediction.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		threshold : float, optional (default=None)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			If set, the model outputs the maximum prior estimate when the prior</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			probability is above this threshold; and outputs the average estimate</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			when below the threshold. Any passed value should be in the range (0, 1],</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			though the sign of the threshold can be negative in order to switch the</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			estimates (i.e. negative threshold would output average estimate when prior</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			is greater than the (absolute) value).  </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		avg_est : bool, optional (default=False)</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			If true, model outputs the prior probability weighted mean as the</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			estimate. Otherwise, model outputs the maximum prior estimate.</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		'''</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		assert</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(confidence_interval </span><span style=color:#d73a49;--shiki-dark:#F97583>is</span><span style=color:#005cc5;--shiki-dark:#79B8FF> None</span><span style=color:#d73a49;--shiki-dark:#F97583> or</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#d73a49;--shiki-dark:#F97583> &#x3C;</span><span style=color:#24292e;--shiki-dark:#E1E4E8> confidence_interval </span><span style=color:#d73a49;--shiki-dark:#F97583>&#x3C;</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)), </span><span style=color:#032f62;--shiki-dark:#9ECBFF>'confidence_interval must be in the range (0,1)'</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		assert</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(threshold </span><span style=color:#d73a49;--shiki-dark:#F97583>is</span><span style=color:#005cc5;--shiki-dark:#79B8FF> None</span><span style=color:#d73a49;--shiki-dark:#F97583> or</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#d73a49;--shiki-dark:#F97583> &#x3C;</span><span style=color:#24292e;--shiki-dark:#E1E4E8> threshold </span><span style=color:#d73a49;--shiki-dark:#F97583>&#x3C;=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)), </span><span style=color:#032f62;--shiki-dark:#9ECBFF>'threshold must be in the range (0,1]'</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>#检查是不是在0-1</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		target </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'avg'</span><span style=color:#d73a49;--shiki-dark:#F97583> if</span><span style=color:#24292e;--shiki-dark:#E1E4E8> avg_est </span><span style=color:#d73a49;--shiki-dark:#F97583>else</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 'top'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>) </span><span style=color:#d73a49;--shiki-dark:#F97583>if</span><span style=color:#24292e;--shiki-dark:#E1E4E8> threshold </span><span style=color:#d73a49;--shiki-dark:#F97583>is</span><span style=color:#005cc5;--shiki-dark:#79B8FF> None</span><span style=color:#d73a49;--shiki-dark:#F97583> else</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 'threshold'</span><span style=color:#6a737d;--shiki-dark:#6A737D># 选一个方式来处理模型的输出，比如avg</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		output </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> getattr</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#d73a49;--shiki-dark:#F97583>f</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'_get_</span><span style=color:#005cc5;--shiki-dark:#79B8FF>{</span><span style=color:#24292e;--shiki-dark:#E1E4E8>target</span><span style=color:#005cc5;--shiki-dark:#79B8FF>}</span><span style=color:#032f62;--shiki-dark:#9ECBFF>_estimate'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)(coefs)</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>        #然后处理输出</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		scale  </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#d73a49;--shiki-dark:#F97583> lambda</span><span style=color:#24292e;--shiki-dark:#E1E4E8> x: </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.scalery.inverse_transform(x.numpy())</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		if</span><span style=color:#24292e;--shiki-dark:#E1E4E8> confidence_interval </span><span style=color:#d73a49;--shiki-dark:#F97583>is</span><span style=color:#d73a49;--shiki-dark:#F97583> not</span><span style=color:#005cc5;--shiki-dark:#79B8FF> None</span><span style=color:#24292e;--shiki-dark:#E1E4E8>:</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>			assert</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(threshold </span><span style=color:#d73a49;--shiki-dark:#F97583>is</span><span style=color:#005cc5;--shiki-dark:#79B8FF> None</span><span style=color:#24292e;--shiki-dark:#E1E4E8>), </span><span style=color:#d73a49;--shiki-dark:#F97583>f</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Cannot calculate confidence on thresholded estimates'</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>			confidence </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> getattr</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#d73a49;--shiki-dark:#F97583>f</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'_get_</span><span style=color:#005cc5;--shiki-dark:#79B8FF>{</span><span style=color:#24292e;--shiki-dark:#E1E4E8>target</span><span style=color:#005cc5;--shiki-dark:#79B8FF>}</span><span style=color:#032f62;--shiki-dark:#9ECBFF>_confidence'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)(coefs, confidence_interval)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>			upper_bar  </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> output </span><span style=color:#d73a49;--shiki-dark:#F97583>+</span><span style=color:#24292e;--shiki-dark:#E1E4E8> confidence</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>			lower_bar  </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> output </span><span style=color:#d73a49;--shiki-dark:#F97583>-</span><span style=color:#24292e;--shiki-dark:#E1E4E8> confidence</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>			return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> scale(output), scale(upper_bar), scale(lower_bar)</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>        #k</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> scale(output)</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>	@ignore_warnings</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> fit</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, X, Y, output_slices</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>None</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#d73a49;--shiki-dark:#F97583>**</span><span style=color:#24292e;--shiki-dark:#E1E4E8>kwargs):</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		with</span><span style=color:#24292e;--shiki-dark:#E1E4E8> get_device(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.config):</span><span style=color:#6a737d;--shiki-dark:#6A737D>#数据放在CPU还是GPU </span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>			checkpoint </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.model_path.joinpath(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'checkpoint'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>#加载模型文件</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>			if</span><span style=color:#24292e;--shiki-dark:#E1E4E8> checkpoint.exists() </span><span style=color:#d73a49;--shiki-dark:#F97583>and</span><span style=color:#d73a49;--shiki-dark:#F97583> not</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.no_load:</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>				if</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.verbose: </span><span style=color:#005cc5;--shiki-dark:#79B8FF>print</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>f</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Restoring model weights from </span><span style=color:#005cc5;--shiki-dark:#79B8FF>{</span><span style=color:#24292e;--shiki-dark:#E1E4E8>checkpoint</span><span style=color:#005cc5;--shiki-dark:#79B8FF>}</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>				self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.load()</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>#如果模型存在的话，就加载，不存在的话就不加载</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>			elif</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.no_load </span><span style=color:#d73a49;--shiki-dark:#F97583>and</span><span style=color:#24292e;--shiki-dark:#E1E4E8> X </span><span style=color:#d73a49;--shiki-dark:#F97583>is</span><span style=color:#005cc5;--shiki-dark:#79B8FF> None</span><span style=color:#24292e;--shiki-dark:#E1E4E8>:</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>				raise</span><span style=color:#005cc5;--shiki-dark:#79B8FF> Exception</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'Model exists, but no_load is set and no training data was given.'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>			elif</span><span style=color:#24292e;--shiki-dark:#E1E4E8> X </span><span style=color:#d73a49;--shiki-dark:#F97583>is</span><span style=color:#d73a49;--shiki-dark:#F97583> not</span><span style=color:#005cc5;--shiki-dark:#79B8FF> None</span><span style=color:#d73a49;--shiki-dark:#F97583> and</span><span style=color:#24292e;--shiki-dark:#E1E4E8> Y </span><span style=color:#d73a49;--shiki-dark:#F97583>is</span><span style=color:#d73a49;--shiki-dark:#F97583> not</span><span style=color:#005cc5;--shiki-dark:#79B8FF> None</span><span style=color:#24292e;--shiki-dark:#E1E4E8>:	</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>				self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.scalerx.fit( ensure_format(X), ensure_format(Y) )</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>				self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.scalery.fit( ensure_format(Y) )</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># 对数据做一下预处理，看是不是符合要求，转换函数在前面有定义，在product_estimation里面自定义的</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>				# Gather all data (train, validation, test, ...) into singular object</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>				datasets </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> kwargs[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'datasets'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>] </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> kwargs.get(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'datasets'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, {})</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>				datasets.update({</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'train'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>: {</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'x'</span><span style=color:#24292e;--shiki-dark:#E1E4E8> : X, </span><span style=color:#032f62;--shiki-dark:#9ECBFF>'y'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>: Y}})</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># 分训练集和测试机</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>				for</span><span style=color:#24292e;--shiki-dark:#E1E4E8> key, data </span><span style=color:#d73a49;--shiki-dark:#F97583>in</span><span style=color:#24292e;--shiki-dark:#E1E4E8> datasets.items(): </span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>					if</span><span style=color:#24292e;--shiki-dark:#E1E4E8> data[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'x'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>] </span><span style=color:#d73a49;--shiki-dark:#F97583>is</span><span style=color:#d73a49;--shiki-dark:#F97583> not</span><span style=color:#005cc5;--shiki-dark:#79B8FF> None</span><span style=color:#24292e;--shiki-dark:#E1E4E8>:</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>						datasets[key].update({</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>							'x_t'</span><span style=color:#24292e;--shiki-dark:#E1E4E8> : </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.scalerx.transform( ensure_format(data[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'x'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]) ),</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>							'y_t'</span><span style=color:#24292e;--shiki-dark:#E1E4E8> : </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.scalery.transform( ensure_format(data[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'y'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]) ),</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>						})</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>#再次转换</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>assert</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(np.isfinite(datasets[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'train'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'x_t'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]).all()), </span><span style=color:#032f62;--shiki-dark:#9ECBFF>'NaN values found in X training data'</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>#数据检查</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>				self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.update_config({</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>					'output_slices'</span><span style=color:#24292e;--shiki-dark:#E1E4E8> : output_slices </span><span style=color:#d73a49;--shiki-dark:#F97583>or</span><span style=color:#24292e;--shiki-dark:#E1E4E8> {</span><span style=color:#032f62;--shiki-dark:#9ECBFF>''</span><span style=color:#24292e;--shiki-dark:#E1E4E8>: </span><span style=color:#005cc5;--shiki-dark:#79B8FF>slice</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>None</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)},</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>					'n_inputs'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>      : datasets[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'train'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'x_t'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>].shape[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>],</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>					'n_targets'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>     : datasets[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'train'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'y_t'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>].shape[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>],</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>				})</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>				self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.build()</span></span>
<span class=line></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>				callbacks </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> []</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>				model_kws </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> {</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>					'batch_size'</span><span style=color:#24292e;--shiki-dark:#E1E4E8> : </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.batch, </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>					'epochs'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>     : </span><span style=color:#005cc5;--shiki-dark:#79B8FF>max</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>int</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_iter </span><span style=color:#d73a49;--shiki-dark:#F97583>/</span><span style=color:#005cc5;--shiki-dark:#79B8FF> max</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>len</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(X) </span><span style=color:#d73a49;--shiki-dark:#F97583>/</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.batch))),</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>					'verbose'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>    : </span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>					'callbacks'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>  : callbacks,</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>				}</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>				if</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.verbose:</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>					callbacks.append( TqdmCallback(model_kws[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'epochs'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>], </span><span style=color:#e36209;--shiki-dark:#FFAB70>data_size</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>len</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(X), </span><span style=color:#e36209;--shiki-dark:#FFAB70>batch_size</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.batch) )</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>				if</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.debug:</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>					callbacks.append( tf.keras.callbacks.TensorBoard(</span><span style=color:#e36209;--shiki-dark:#FFAB70>histogram_freq</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>profile_batch</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>2</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>60</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)) )</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>				if</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 'args'</span><span style=color:#d73a49;--shiki-dark:#F97583> in</span><span style=color:#24292e;--shiki-dark:#E1E4E8> kwargs:</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>					if</span><span style=color:#005cc5;--shiki-dark:#79B8FF> getattr</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(kwargs[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'args'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>], </span><span style=color:#032f62;--shiki-dark:#9ECBFF>'plot_loss'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>False</span><span style=color:#24292e;--shiki-dark:#E1E4E8>):</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>						callbacks.append( PlottingCallback(kwargs[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'args'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>], datasets, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>) )</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>					if</span><span style=color:#005cc5;--shiki-dark:#79B8FF> getattr</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(kwargs[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'args'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>], </span><span style=color:#032f62;--shiki-dark:#9ECBFF>'save_stats'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>False</span><span style=color:#24292e;--shiki-dark:#E1E4E8>):</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>						callbacks.append( StatsCallback(kwargs[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'args'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>], datasets, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>) )</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>					if</span><span style=color:#005cc5;--shiki-dark:#79B8FF> getattr</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(kwargs[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'args'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>], </span><span style=color:#032f62;--shiki-dark:#9ECBFF>'best_epoch'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>False</span><span style=color:#24292e;--shiki-dark:#E1E4E8>):</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>						if</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 'valid'</span><span style=color:#d73a49;--shiki-dark:#F97583> in</span><span style=color:#24292e;--shiki-dark:#E1E4E8> datasets </span><span style=color:#d73a49;--shiki-dark:#F97583>and</span><span style=color:#032f62;--shiki-dark:#9ECBFF> 'x_t'</span><span style=color:#d73a49;--shiki-dark:#F97583> in</span><span style=color:#24292e;--shiki-dark:#E1E4E8> datasets[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'valid'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]:</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>							model_kws[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'validation_data'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>] </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (datasets[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'valid'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'x_t'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>], datasets[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'valid'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'y_t'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>])</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>							callbacks.append( ModelCheckpoint(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.model_path) )</span></span>
<span class=line></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>				self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.model.fit(datasets[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'train'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'x_t'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>], datasets[</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'train'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>][</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'y_t'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>], </span><span style=color:#d73a49;--shiki-dark:#F97583>**</span><span style=color:#24292e;--shiki-dark:#E1E4E8>model_kws)</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>				if</span><span style=color:#d73a49;--shiki-dark:#F97583> not</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.no_save:</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>					self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.save()</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>			else</span><span style=color:#24292e;--shiki-dark:#E1E4E8>:</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>				raise</span><span style=color:#005cc5;--shiki-dark:#79B8FF> Exception</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#d73a49;--shiki-dark:#F97583>f</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"No trained model exists at: </span><span style=color:#005cc5;--shiki-dark:#79B8FF>\n{self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.model_path</span><span style=color:#005cc5;--shiki-dark:#79B8FF>}</span><span style=color:#032f62;--shiki-dark:#9ECBFF>"</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>			return</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8> </span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D># 网络构建的部分在这里</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>#全连接 输入层 隐藏层 激活函数 输出层</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> build</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self):</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		layer_kwargs </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> {</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'activation'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>         : </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.activation,</span><span style=color:#6a737d;--shiki-dark:#6A737D>#激活函数</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'kernel_regularizer'</span><span style=color:#24292e;--shiki-dark:#E1E4E8> : tf.keras.regularizers.l2(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.l2),</span><span style=color:#6a737d;--shiki-dark:#6A737D>#一个正则项</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'bias_regularizer'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>   : tf.keras.regularizers.l2(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.l2),</span><span style=color:#6a737d;--shiki-dark:#6A737D>#另一个正则项</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>			# 'kernel_initializer' : tf.keras.initializers.LecunNormal(),</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>			# 'bias_initializer'   : tf.keras.initializers.LecunNormal(),</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		}</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		mixture_kwargs </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> {</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'n_mix'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>     : </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_mix,</span><span style=color:#6a737d;--shiki-dark:#6A737D>#整个模型输出几个高斯参数</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'n_targets'</span><span style=color:#24292e;--shiki-dark:#E1E4E8> : </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_targets,</span><span style=color:#6a737d;--shiki-dark:#6A737D>#在前面都定义过</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>			'epsilon'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>   : </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.epsilon,</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		}</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		mixture_kwargs.update(layer_kwargs)</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>		#字典添加到上面</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		create_layer </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#d73a49;--shiki-dark:#F97583> lambda</span><span style=color:#24292e;--shiki-dark:#E1E4E8> inp, out: tf.keras.layers.Dense(out, </span><span style=color:#e36209;--shiki-dark:#FFAB70>input_shape</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(inp,), </span><span style=color:#d73a49;--shiki-dark:#F97583>**</span><span style=color:#24292e;--shiki-dark:#E1E4E8>layer_kwargs)</span><span style=color:#6a737d;--shiki-dark:#6A737D># 第一层的全连接的方式，</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		model_layers </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> [create_layer(inp, out) </span><span style=color:#d73a49;--shiki-dark:#F97583>for</span><span style=color:#24292e;--shiki-dark:#E1E4E8> inp, out </span><span style=color:#d73a49;--shiki-dark:#F97583>in</span><span style=color:#005cc5;--shiki-dark:#79B8FF> zip</span><span style=color:#24292e;--shiki-dark:#E1E4E8>([</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_inputs] </span><span style=color:#d73a49;--shiki-dark:#F97583>+</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.hidden[:</span><span style=color:#d73a49;--shiki-dark:#F97583>-</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>], </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.hidden)]</span><span style=color:#6a737d;--shiki-dark:#6A737D>#把第一层全连接组合起来，</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		output_layer </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> MixtureLayer(</span><span style=color:#d73a49;--shiki-dark:#F97583>**</span><span style=color:#24292e;--shiki-dark:#E1E4E8>mixture_kwargs)</span><span style=color:#6a737d;--shiki-dark:#6A737D>#搭建混合密度网络</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>		#做初始化</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>		# Define yscaler.inverse_transform as a tensorflow function, and estimate extraction from outputs</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>		# yscaler_a   = self.scalery.scalers[-1].min_</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>		# yscaler_b   = self.scalery.scalers[-1].scale_</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>		# inv_scaler  = lambda y: tf.math.exp((tf.reshape(y, shape=[-1]) - yscaler_a) / yscaler_b) </span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>		# extract_est = lambda z: self._get_top_estimate( self._parse_outputs(z) )</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		optimizer  </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.keras.optimizers.Adam(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.lr)</span><span style=color:#6a737d;--shiki-dark:#6A737D>#优化器</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>		self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.model </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.keras.Sequential(model_layers </span><span style=color:#d73a49;--shiki-dark:#F97583>+</span><span style=color:#24292e;--shiki-dark:#E1E4E8> [output_layer], </span><span style=color:#e36209;--shiki-dark:#FFAB70>name</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.model_name)</span><span style=color:#6a737d;--shiki-dark:#6A737D>#网络组合起来</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>		self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.model.compile(</span><span style=color:#e36209;--shiki-dark:#FFAB70>loss</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.loss, </span><span style=color:#e36209;--shiki-dark:#FFAB70>optimizer</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>optimizer, </span><span style=color:#e36209;--shiki-dark:#FFAB70>metrics</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>[])</span><span style=color:#6a737d;--shiki-dark:#6A737D>#[MSA(extract_est, inv_scaler)])#和前面的模型叠加进行训练</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		</span></span>
<span class=line></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>	@tf.function</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    </span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> loss</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, y, output):</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		prior, mu, scale </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>._parse_outputs(output) </span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>        #对输出做解析</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		dist  </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> getattr</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(tfp.distributions, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.distribution)(mu, scale)</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>        #选出来正态分布</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		prob  </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tfp.distributions.Categorical(</span><span style=color:#e36209;--shiki-dark:#FFAB70>probs</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>prior)</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>        #类别分布</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		mix   </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tfp.distributions.MixtureSameFamily(prob, dist)</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>		#把五个分布结合起来变成一个新的分布</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> impute</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(mix, y, N):</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>			# summation  = tf.zeros(tf.shape(y)[0])</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>			# imputation = lambda i, s: [i+1, tf.add(s, mix.log_prob(tf.where(tf.math.is_nan(y), mix.sample(), y)))]</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>			# return tf.while_loop(lambda i, x: i &#x3C; N, imputation, (0, summation), maximum_iterations=N, parallel_iterations=N)[1] / N</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>			return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.reduce_mean([</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>				mix.log_prob( tf.where(tf.math.is_nan(y), mix.sample(), y) )</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>                #把y从一个数转换为一个分布</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>			for</span><span style=color:#24292e;--shiki-dark:#E1E4E8> _ </span><span style=color:#d73a49;--shiki-dark:#F97583>in</span><span style=color:#005cc5;--shiki-dark:#79B8FF> range</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(N)], </span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>		# Much slower due to cond executing both branches regardless of the conditional</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>		# likelihood = tf.cond(tf.reduce_any(tf.math.is_nan(y)), lambda: impute(mix, y, self.imputations), lambda: mix.log_prob(y))</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		likelihood </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> mix.log_prob(y)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    </span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.reduce_mean(</span><span style=color:#d73a49;--shiki-dark:#F97583>-</span><span style=color:#24292e;--shiki-dark:#E1E4E8>likelihood) </span><span style=color:#d73a49;--shiki-dark:#F97583>+</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.add_n([</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.] </span><span style=color:#d73a49;--shiki-dark:#F97583>+</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.model.losses)</span><span style=color:#6a737d;--shiki-dark:#6A737D>#计算这两个分布的相似性</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#005cc5;--shiki-dark:#79B8FF> __call__</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, inputs):</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		return</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.model(inputs)</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> get_config</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self):</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		return</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.config</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> set_config</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, config, </span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#24292e;--shiki-dark:#E1E4E8>args, </span><span style=color:#d73a49;--shiki-dark:#F97583>**</span><span style=color:#24292e;--shiki-dark:#E1E4E8>kwargs):</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>		self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.config </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> {} </span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>		self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.update_config(config, </span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#24292e;--shiki-dark:#E1E4E8>args, </span><span style=color:#d73a49;--shiki-dark:#F97583>**</span><span style=color:#24292e;--shiki-dark:#E1E4E8>kwargs)</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> update_config</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, config, keys</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>None</span><span style=color:#24292e;--shiki-dark:#E1E4E8>):</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		if</span><span style=color:#24292e;--shiki-dark:#E1E4E8> keys </span><span style=color:#d73a49;--shiki-dark:#F97583>is</span><span style=color:#d73a49;--shiki-dark:#F97583> not</span><span style=color:#005cc5;--shiki-dark:#79B8FF> None</span><span style=color:#24292e;--shiki-dark:#E1E4E8>:</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>			config </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> {k:v </span><span style=color:#d73a49;--shiki-dark:#F97583>for</span><span style=color:#24292e;--shiki-dark:#E1E4E8> k,v </span><span style=color:#d73a49;--shiki-dark:#F97583>in</span><span style=color:#24292e;--shiki-dark:#E1E4E8> config.items() </span><span style=color:#d73a49;--shiki-dark:#F97583>if</span><span style=color:#24292e;--shiki-dark:#E1E4E8> k </span><span style=color:#d73a49;--shiki-dark:#F97583>in</span><span style=color:#24292e;--shiki-dark:#E1E4E8> keys </span><span style=color:#d73a49;--shiki-dark:#F97583>or</span><span style=color:#24292e;--shiki-dark:#E1E4E8> k </span><span style=color:#d73a49;--shiki-dark:#F97583>not</span><span style=color:#d73a49;--shiki-dark:#F97583> in</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.config}</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>		self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.config.update(config)</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		for</span><span style=color:#24292e;--shiki-dark:#E1E4E8> k, v </span><span style=color:#d73a49;--shiki-dark:#F97583>in</span><span style=color:#24292e;--shiki-dark:#E1E4E8> config.items():</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>			setattr</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, k, v)</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> save</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self):</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>		self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.model_path.mkdir(</span><span style=color:#e36209;--shiki-dark:#FFAB70>parents</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>True</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#e36209;--shiki-dark:#FFAB70>exist_ok</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>True</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		store_pkl(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.model_path.joinpath(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'config.pkl'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>), </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.get_config())</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>		self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.model.save_weights(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.model_path.joinpath(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'checkpoint'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>))</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> load</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self):</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>		self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.update_config(read_pkl(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.model_path.joinpath(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'config.pkl'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)), [</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'scalerx'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#032f62;--shiki-dark:#9ECBFF>'scalery'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#032f62;--shiki-dark:#9ECBFF>'tf_random'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#032f62;--shiki-dark:#9ECBFF>'np_random'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>])</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		tf.random.set_global_generator(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.tf_random)</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		if</span><span style=color:#d73a49;--shiki-dark:#F97583> not</span><span style=color:#005cc5;--shiki-dark:#79B8FF> hasattr</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#032f62;--shiki-dark:#9ECBFF>'model'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>): </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.build()</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>		self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.model.load_weights(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.model_path.joinpath(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'checkpoint'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)).expect_partial()</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> get_coefs</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, output):</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		prior, mu, scale </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>._parse_outputs(output)</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> prior, mu, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>._covariance(scale)</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>		#scale做了协方差</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> _parse_outputs</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, output):</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		prior, mu, scale </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.split(output, [</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_mix, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_mix </span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_targets, </span><span style=color:#d73a49;--shiki-dark:#F97583>-</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>], </span><span style=color:#e36209;--shiki-dark:#FFAB70>axis</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		prior </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.reshape(prior, </span><span style=color:#e36209;--shiki-dark:#FFAB70>shape</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>[</span><span style=color:#d73a49;--shiki-dark:#F97583>-</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_mix])</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		mu    </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.reshape(mu,    </span><span style=color:#e36209;--shiki-dark:#FFAB70>shape</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>[</span><span style=color:#d73a49;--shiki-dark:#F97583>-</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_mix, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_targets])</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		scale </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.reshape(scale, </span><span style=color:#e36209;--shiki-dark:#FFAB70>shape</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>[</span><span style=color:#d73a49;--shiki-dark:#F97583>-</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_mix, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_targets, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_targets])</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> prior, mu, scale</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> _covariance</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, scale):</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.einsum(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'abij,abjk->abik'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, tf.transpose(scale, </span><span style=color:#e36209;--shiki-dark:#FFAB70>perm</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>3</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>2</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]), scale)</span></span>
<span class=line></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	'''</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	Estimate Generation</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	'''</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>    #不同的估计方式</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> _calculate_top</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, prior, values):</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		vals, idxs  </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.nn.top_k(prior, </span><span style=color:#e36209;--shiki-dark:#FFAB70>k</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		idxs </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.stack([tf.range(tf.shape(idxs)[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]), tf.reshape(idxs, [</span><span style=color:#d73a49;--shiki-dark:#F97583>-</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>])], </span><span style=color:#e36209;--shiki-dark:#FFAB70>axis</span><span style=color:#d73a49;--shiki-dark:#F97583>=-</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.gather_nd(values, idxs)</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> _get_top_estimate</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, coefs, </span><span style=color:#d73a49;--shiki-dark:#F97583>**</span><span style=color:#24292e;--shiki-dark:#E1E4E8>kwargs):</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		prior, mu, _ </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> coefs</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		return</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>._calculate_top(prior, mu)</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> _get_avg_estimate</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, coefs, </span><span style=color:#d73a49;--shiki-dark:#F97583>**</span><span style=color:#24292e;--shiki-dark:#E1E4E8>kwargs):</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		prior, mu, _ </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> coefs</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.reduce_sum(mu </span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.expand_dims(prior, </span><span style=color:#d73a49;--shiki-dark:#F97583>-</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>), </span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> _get_threshold_estimate</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, coefs, threshold</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0.5</span><span style=color:#24292e;--shiki-dark:#E1E4E8>):</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		top_estimate </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.get_top_estimate(coefs)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		avg_estimate </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.get_avg_estimate(coefs)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		prior, _, _  </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> coefs</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.compat.v2.where(tf.expand_dims(tf.math.greater(tf.reduce_max(prior, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>) </span><span style=color:#d73a49;--shiki-dark:#F97583>/</span><span style=color:#24292e;--shiki-dark:#E1E4E8> threshold, tf.math.sign(threshold)), </span><span style=color:#d73a49;--shiki-dark:#F97583>-</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>), top_estimate, avg_estimate)</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	'''</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	Confidence Estimation</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>	'''</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> _calculate_confidence</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, sigma, level</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0.9</span><span style=color:#24292e;--shiki-dark:#E1E4E8>):</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>		# For a given confidence level probability p (0&#x3C;p&#x3C;1), and number of dimensions d, rho is the error bar coefficient: rho=sqrt(2)*erfinv(p ** (1/d))</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>		# https://faculty.ucmerced.edu/mcarreira-perpinan/papers/cs-99-03.pdf</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		s, u, v </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.linalg.svd(sigma)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		rho </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 2</span><span style=color:#d73a49;--shiki-dark:#F97583>**</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0.5</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.math.erfinv(level </span><span style=color:#d73a49;--shiki-dark:#F97583>**</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.</span><span style=color:#d73a49;--shiki-dark:#F97583>/</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_targets)) </span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.cast(rho, tf.float32) </span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 2</span><span style=color:#d73a49;--shiki-dark:#F97583> *</span><span style=color:#24292e;--shiki-dark:#E1E4E8> s </span><span style=color:#d73a49;--shiki-dark:#F97583>**</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 0.5</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> _get_top_confidence</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, coefs, level</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0.9</span><span style=color:#24292e;--shiki-dark:#E1E4E8>):</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		prior, mu, sigma </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> coefs</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		top_sigma </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>._calculate_top(prior, sigma)</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		return</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>._calculate_confidence(top_sigma, level)		</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> _get_avg_confidence</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, coefs, level</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0.9</span><span style=color:#24292e;--shiki-dark:#E1E4E8>):</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		prior, mu, sigma </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> coefs</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		avg_estim </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.get_avg_estimate(coefs)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		avg_sigma </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.reduce_sum(tf.expand_dims(tf.expand_dims(prior, </span><span style=color:#d73a49;--shiki-dark:#F97583>-</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>), </span><span style=color:#d73a49;--shiki-dark:#F97583>-</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>) </span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#24292e;--shiki-dark:#E1E4E8> </span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>						(sigma </span><span style=color:#d73a49;--shiki-dark:#F97583>+</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.matmul(tf.transpose(mu </span><span style=color:#d73a49;--shiki-dark:#F97583>-</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.expand_dims(avg_estim, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>), (</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>2</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)), </span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>														mu </span><span style=color:#d73a49;--shiki-dark:#F97583>-</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.expand_dims(avg_estim, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>))), </span><span style=color:#e36209;--shiki-dark:#FFAB70>axis</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		return</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>._calculate_confidence(avg_sigma, level)		</span></span>
<span class=line></span>
<span class=line></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>class</span><span style=color:#6f42c1;--shiki-dark:#B392F0> MixtureLayer</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#6f42c1;--shiki-dark:#B392F0>tf</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.</span><span style=color:#6f42c1;--shiki-dark:#B392F0>keras</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.</span><span style=color:#6f42c1;--shiki-dark:#B392F0>layers</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.</span><span style=color:#6f42c1;--shiki-dark:#B392F0>Layer</span><span style=color:#24292e;--shiki-dark:#E1E4E8>):</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#005cc5;--shiki-dark:#79B8FF> __init__</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, n_mix, n_targets, epsilon, </span><span style=color:#d73a49;--shiki-dark:#F97583>**</span><span style=color:#24292e;--shiki-dark:#E1E4E8>layer_kwargs):</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>		super</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(MixtureLayer, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>).</span><span style=color:#005cc5;--shiki-dark:#79B8FF>__init__</span><span style=color:#24292e;--shiki-dark:#E1E4E8>()</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		layer_kwargs.pop(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'activation'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>None</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>		self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_mix     </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> n_mix </span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>		self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_targets </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> n_targets </span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>		self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.epsilon   </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.constant(epsilon)</span></span>
<span class=line><span style=color:#005cc5;--shiki-dark:#79B8FF>		self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>._layer    </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.keras.layers.Dense(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_outputs, </span><span style=color:#d73a49;--shiki-dark:#F97583>**</span><span style=color:#24292e;--shiki-dark:#E1E4E8>layer_kwargs)</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>		#前面的参数直接传过来</span></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>	@</span><span style=color:#005cc5;--shiki-dark:#79B8FF>property</span><span style=color:#24292e;--shiki-dark:#E1E4E8> </span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> layer_sizes</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self):</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		''' Sizes of the prior, mu, and (lower triangle) scale matrix outputs '''</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		sizes </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> [</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_targets, (</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_targets </span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#24292e;--shiki-dark:#E1E4E8> (</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_targets </span><span style=color:#d73a49;--shiki-dark:#F97583>+</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)) </span><span style=color:#d73a49;--shiki-dark:#F97583>//</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 2</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		return</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_mix </span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#24292e;--shiki-dark:#E1E4E8> np.array(sizes)</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style=color:#6f42c1;--shiki-dark:#B392F0>	@</span><span style=color:#005cc5;--shiki-dark:#79B8FF>property</span><span style=color:#24292e;--shiki-dark:#E1E4E8> </span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> n_outputs</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self):</span></span>
<span class=line><span style=color:#032f62;--shiki-dark:#9ECBFF>		''' Total output size of the layer object '''</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		return</span><span style=color:#005cc5;--shiki-dark:#79B8FF> sum</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.layer_sizes)</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>	# @tf.function(experimental_compile=True)</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>	def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> call</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, inputs):</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>        #这里是前向传播</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>        #整个输入分为三个部分</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		prior, mu, scale </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.split(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>._layer(inputs), </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.layer_sizes, </span><span style=color:#e36209;--shiki-dark:#FFAB70>axis</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		prior </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.nn.softmax(prior, </span><span style=color:#e36209;--shiki-dark:#FFAB70>axis</span><span style=color:#d73a49;--shiki-dark:#F97583>=-</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>) </span><span style=color:#d73a49;--shiki-dark:#F97583>+</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.constant(</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1e-9</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>        #softmax激活，为了不为0加了个常数</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		mu    </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.stack(tf.split(mu, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_mix, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>), </span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>) </span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		scale </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.stack(tf.split(scale, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_mix, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>), </span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>) </span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		scale </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tfp.math.fill_triangular(scale, </span><span style=color:#e36209;--shiki-dark:#FFAB70>upper</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF>False</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>        # 变成一个上三角矩阵</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		norm  </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.linalg.diag(tf.ones((</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_targets)))</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>        # 取出来对角线的值</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		sigma </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.einsum(</span><span style=color:#032f62;--shiki-dark:#9ECBFF>'abij,abjk->abik'</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, tf.transpose(scale, </span><span style=color:#e36209;--shiki-dark:#FFAB70>perm</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>[</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>3</span><span style=color:#24292e;--shiki-dark:#E1E4E8>,</span><span style=color:#005cc5;--shiki-dark:#79B8FF>2</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]), scale)</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>        #矩阵乘法</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		sigma</span><span style=color:#d73a49;--shiki-dark:#F97583>+=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.epsilon </span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#24292e;--shiki-dark:#E1E4E8> norm</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		scale </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.linalg.cholesky(sigma)</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>	#乘出来一个分布</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>		return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.keras.layers.concatenate([</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>			tf.reshape(prior, </span><span style=color:#e36209;--shiki-dark:#FFAB70>shape</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>[</span><span style=color:#d73a49;--shiki-dark:#F97583>-</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_mix]),</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>			tf.reshape(mu,    </span><span style=color:#e36209;--shiki-dark:#FFAB70>shape</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>[</span><span style=color:#d73a49;--shiki-dark:#F97583>-</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_mix </span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_targets]),</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>			tf.reshape(scale, </span><span style=color:#e36209;--shiki-dark:#FFAB70>shape</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>[</span><span style=color:#d73a49;--shiki-dark:#F97583>-</span><span style=color:#005cc5;--shiki-dark:#79B8FF>1</span><span style=color:#24292e;--shiki-dark:#E1E4E8>, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_mix </span><span style=color:#d73a49;--shiki-dark:#F97583>*</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.n_targets </span><span style=color:#d73a49;--shiki-dark:#F97583>**</span><span style=color:#005cc5;--shiki-dark:#79B8FF> 2</span><span style=color:#24292e;--shiki-dark:#E1E4E8>]),</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>		])</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>    #三个矩阵压缩到同一个矩阵里进行输出</span></span></code></pre></div><p>这个论文的一个特殊的地方，就是他的loss。</p><p>虽然最后输出的是只输出一个数，但是他在训练这个网络的时候，用了pdf和pdf的极大似然值来做loss</p><p>就是这里</p><div class=code-block-wrapper><button aria-label="Copy code" class=code-copy-button type=button></button><pre class="astro-code astro-code-themes github-dark github-light" data-copy-button-added=true data-language=python style=background-color:#fff;--shiki-dark-bg:#24292e;color:#24292e;--shiki-dark:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#d73a49;--shiki-dark:#F97583>def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> loss</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(self, y, output):</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    prior, mu, scale </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>._parse_outputs(output) </span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    dist  </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#005cc5;--shiki-dark:#79B8FF> getattr</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(tfp.distributions, </span><span style=color:#005cc5;--shiki-dark:#79B8FF>self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.distribution)(mu, scale)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    prob  </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tfp.distributions.Categorical(</span><span style=color:#e36209;--shiki-dark:#FFAB70>probs</span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8>prior)</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    mix   </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tfp.distributions.MixtureSameFamily(prob, dist)</span></span>
<span class=line></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    def</span><span style=color:#6f42c1;--shiki-dark:#B392F0> impute</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(mix, y, N):</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>        # summation  = tf.zeros(tf.shape(y)[0])</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>        # imputation = lambda i, s: [i+1, tf.add(s, mix.log_prob(tf.where(tf.math.is_nan(y), mix.sample(), y)))]</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>        # return tf.while_loop(lambda i, x: i &#x3C; N, imputation, (0, summation), maximum_iterations=N, parallel_iterations=N)[1] / N</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>        return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.reduce_mean([</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>            mix.log_prob( tf.where(tf.math.is_nan(y), mix.sample(), y) )</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>            for</span><span style=color:#24292e;--shiki-dark:#E1E4E8> _ </span><span style=color:#d73a49;--shiki-dark:#F97583>in</span><span style=color:#005cc5;--shiki-dark:#79B8FF> range</span><span style=color:#24292e;--shiki-dark:#E1E4E8>(N)], </span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>)</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>    # Much slower due to cond executing both branches regardless of the conditional</span></span>
<span class=line><span style=color:#6a737d;--shiki-dark:#6A737D>    # likelihood = tf.cond(tf.reduce_any(tf.math.is_nan(y)), lambda: impute(mix, y, self.imputations), lambda: mix.log_prob(y))</span></span>
<span class=line><span style=color:#24292e;--shiki-dark:#E1E4E8>    likelihood </span><span style=color:#d73a49;--shiki-dark:#F97583>=</span><span style=color:#24292e;--shiki-dark:#E1E4E8> mix.log_prob(y)</span></span>
<span class=line><span style=color:#d73a49;--shiki-dark:#F97583>    return</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.reduce_mean(</span><span style=color:#d73a49;--shiki-dark:#F97583>-</span><span style=color:#24292e;--shiki-dark:#E1E4E8>likelihood) </span><span style=color:#d73a49;--shiki-dark:#F97583>+</span><span style=color:#24292e;--shiki-dark:#E1E4E8> tf.add_n([</span><span style=color:#005cc5;--shiki-dark:#79B8FF>0</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.] </span><span style=color:#d73a49;--shiki-dark:#F97583>+</span><span style=color:#005cc5;--shiki-dark:#79B8FF> self</span><span style=color:#24292e;--shiki-dark:#E1E4E8>.model.losses)</span></span></code></pre></div><p>返回值是tf.reduce_mean(-likelihood) + tf.add_n([0.] + self.model.losses)</p><p>impute这个函数似乎一直都没有用到</p><p>计算张量的各个维度上的元素的平均值.</p><p>而这里计算的是likelihood，计算方式是mix.log_prob(y)</p><p>mix这个类来自于tfp.distributions.MixtureSameFamily(prob, dist), prob和dist来自output</p><p>tfp这个东西来自于tensorflow_probability</p><p>接下来请见第三篇，tensorflow_probability</p><div id=post-copyright></div><div class="mt-12.6 uno-decorative-line"></div><div class="flex flex-wrap gap-x-3 gap-y-3.2 no-heti"><a href=/tags/机器学习/ class="hover:c-primary border border-secondary/25 ease-out hover:border-secondary/80 hover:font-medium hover:ring-0.2 inline-block px-3.2 py-0.7 relative ring-0 ring-secondary/80 rounded-full transition-[colors,box-shadow]"><span class="flex absolute inset-0 items-center justify-center transition-font-weight whitespace-nowrap">机器学习 </span><span class="inline-block font-medium opacity-0" aria-hidden=true>机器学习 </span></a><a href=/tags/Inversion/ class="hover:c-primary border border-secondary/25 ease-out hover:border-secondary/80 hover:font-medium hover:ring-0.2 inline-block px-3.2 py-0.7 relative ring-0 ring-secondary/80 rounded-full transition-[colors,box-shadow]"><span class="flex absolute inset-0 items-center justify-center transition-font-weight whitespace-nowrap">Inversion </span><span class="inline-block font-medium opacity-0" aria-hidden=true>Inversion </span></a><a href="/tags/Deep Learning/" class="hover:c-primary border border-secondary/25 ease-out hover:border-secondary/80 hover:font-medium hover:ring-0.2 inline-block px-3.2 py-0.7 relative ring-0 ring-secondary/80 rounded-full transition-[colors,box-shadow]"><span class="flex absolute inset-0 items-center justify-center transition-font-weight whitespace-nowrap">Deep Learning </span><span class="inline-block font-medium opacity-0" aria-hidden=true>Deep Learning</span></a></div></div></article></main><footer class="leading-1.25em font-navbar lg:text-3.5 text-3" lg="uno-desktop-column bottom-20"><p><a href=/atom.xml/ class="hover:c-primary highlight-hover after:bottom-0.35em py-0.8 transition-colors" rel="noopener noreferrer" target=_blank>RSS</a>&nbsp;/ <a href=https://github.com/lifeodyssey class="hover:c-primary highlight-hover after:bottom-0.35em py-0.8 transition-colors" rel="noopener noreferrer" target=_blank>GitHub</a>&nbsp;/ <a href=mailto:email@radishzz.cc class="hover:c-primary highlight-hover after:bottom-0.35em py-0.8 transition-colors" rel="noopener noreferrer" target=_blank>Email</a>&nbsp;</p><p>© 2025-2026 周大侠</p><p>Powered by <a href=https://astro.build/ class="hover:c-primary highlight-hover after:bottom-0.35em py-0.8 transition-colors" rel="noopener noreferrer" target=_blank>Astro</a> and <a href=https://github.com/radishzzz/astro-theme-retypeset class="hover:c-primary highlight-hover after:bottom-0.35em py-0.8 transition-colors" rel="noopener noreferrer" target=_blank>Retypeset</a></p></footer></div><div class="flex absolute gap-6 lg:bottom-[min(10.27rem+1.92vw,12rem)] lg:fixed lg:right-[max(5rem,calc(50vw-35rem))] lg:top-auto lg:w-14rem min-[823px]:max-lg:right-[calc(50vw-22rem)] right-7.25vw top-14.6"><a href=/posts/8bb8e4ec.html.html/ class="hover:c-primary active:scale-90 aspect-square c-secondary w-4" aria-label="Switch website language" id=language-switcher><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M19.18 21.1 12.4 1.89h-1.21L4.52 21.1l-2.53.2v.81h6.37v-.81l-2.83-.2 2.02-5.97h7.58l2.02 5.97-3.34.2v.81H22v-.81l-2.83-.2zM7.85 14.33l3.44-10.21 3.54 10.21z"/></svg> </a><button aria-label="Switch light/dark theme" class="hover:c-primary active:scale-90 aspect-square c-secondary w-4" id=theme-toggle-button><svg aria-hidden=true fill=currentColor viewBox="0 0 24 24"><path d="M12.06.61C5.66.61.46 5.71.46 12.11s5.1 11.5 11.6 11.5 11.5-5.1 11.5-11.5S18.46.61 12.06.61m0 21c-6.07 0-10.94-4.2-10.94-9.5s4.87-9.4 10.94-9.4S23 6.91 23 12.21s-4.88 9.4-10.94 9.4"/></svg></button></div><script>!function(){const e="oklch(96% 0.005 298)",t="oklch(22% 0.005 298)";function n(n){document.documentElement.classList.toggle("dark",n);const o=document.head.querySelector('meta[name="theme-color"]');o&&e&&t&&o.setAttribute("content",n?t:e),localStorage.setItem("theme",n?"dark":"light"),document.dispatchEvent(new Event("theme-changed"))}function o(){n(!document.documentElement.classList.contains("dark"))}document.addEventListener("click",(function(e){const t=e.target instanceof Element?e.target:null,n=t?.closest("#theme-toggle-button");if(!n)return;if(document.documentElement.classList.contains("reduce-motion"))return void o();document.documentElement.style.setProperty("view-transition-name","animation-theme-toggle"),document.documentElement.setAttribute("data-theme-changing",""),document.startViewTransition(o).finished.then((()=>{document.documentElement.style.removeProperty("view-transition-name"),document.documentElement.removeAttribute("data-theme-changing")}))}),{passive:!0}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(e=>{n(e.matches)}))}()</script><script type=module>const o={click:"tap",typing:"type"},l={[o.click]:.8,[o.typing]:.4},d=["#language-switcher","#theme-toggle-button"],f=[".el-input__inner",".el-textarea__inner","#wl-nick","#wl-mail","#wl-link","#wl-edit"],h=new Set(["Shift","Control","Alt","Meta","Tab","Escape","CapsLock"]),p=d.join(","),g=f.join(",");function r(){return window.matchMedia("(max-width: 1023px)").matches}function w(){return document.head.querySelector('link[rel="sitemap"]')?.getAttribute("href")?.replace("/sitemap-index.xml","")||""}class y{audioContext=null;audioBuffers={[o.click]:[],[o.typing]:[]};initPromise=null;async fetchAndCacheSound(t,e){if(!this.audioContext)throw new Error("Audio context not initialized");const n=`${t}_0${e+1}`,i=await(await fetch(`${w()}/sounds/${n}.wav`)).arrayBuffer(),a=await this.audioContext.decodeAudioData(i);this.audioBuffers[t].push(a)}async preloadAllSounds(){const t=Object.values(o).flatMap((t=>Array.from({length:5},((e,n)=>this.fetchAndCacheSound(t,n)))));await Promise.allSettled(t)}async initialize(){return this.initPromise??=(async()=>{const t=window.AudioContext||window.webkitAudioContext;this.audioContext=new t,await this.preloadAllSounds()})()}async playSound(t){try{if(await this.initialize(),!this.audioContext)return;"suspended"===this.audioContext.state&&await this.audioContext.resume();const e=this.audioBuffers[t];if(0===e.length)return;const n=this.audioContext.createBufferSource();n.buffer=e[Math.floor(Math.random()*e.length)];const i=this.audioContext.createGain();i.gain.value=l[t],n.connect(i).connect(this.audioContext.destination),n.start(0)}catch(t){console.warn("Sound playback failed:",t)}}}const c=new y;function m(t){r()||!t.target?.closest(p)||c.playSound(o.click)}function x(t){r()||t.ctrlKey||t.altKey||t.metaKey||h.has(t.key)||!t.target?.closest(g)||c.playSound(o.typing)}document.addEventListener("click",m,{passive:!0}),document.addEventListener("keydown",x,{passive:!0})</script><script type=module>const s={copy:'<svg\n      viewBox="0 0 24 24"\n      fill="currentColor"\n    >\n      <path d="M6.9.8v18h14.5V.8zm12.8 16h-11v-14h11z"/>\n      <path d="M4.3 21.2V5.6l-1.7.5v17.1h14.3l.6-2z"/>\n    </svg>',success:'<svg\n      viewBox="0 0 24 24"\n      fill="currentColor"\n    >\n      <path d="m23.1 6.4-1.3-1.3L9.4 16.6l-6.3-5.4-1.2 1.2L9.4 20z"/>\n    </svg>'},o=new WeakMap;function r(){const e=document.querySelectorAll(".code-copy-button");0!==e.length&&e.forEach((e=>{e.innerHTML=s.copy}))}async function a(e){if(e.classList.contains("copy-success"))return;const t=e.parentElement?.querySelector("pre code"),n=t?.textContent??"";if(t&&n)try{await navigator.clipboard.writeText(n);const t=o.get(e);t&&clearTimeout(t),e.innerHTML=s.success,e.classList.add("copy-success");const c=setTimeout((()=>{e.isConnected&&(e.innerHTML=s.copy,e.classList.remove("copy-success"),o.delete(e))}),1500);o.set(e,c)}catch(e){console.error("Failed to copy code",e)}}function l(e){const t=e.target instanceof Element&&e.target.closest(".code-copy-button");t&&a(t)}document.addEventListener("astro:page-load",r),document.addEventListener("click",l,{passive:!0}),r()</script><script type=module>async function p(t){const e=t.dataset.repo;if(!e)return;const o=t.getElementsByClassName("gc-owner-avatar")[0],n=t.getElementsByClassName("gc-repo-description")[0],s=t.getElementsByClassName("gc-stars-count")[0],a=t.getElementsByClassName("gc-forks-count")[0],r=t.getElementsByClassName("gc-license-info")[0];function c(t){const e=new Intl.NumberFormat("en",{notation:"compact",maximumFractionDigits:1});o&&t.owner?.avatar_url&&(o.style.backgroundImage=`url(${t.owner.avatar_url})`),n&&(n.textContent=t.description??"No description"),s&&(s.textContent=e.format(t.stargazers_count??0)),a&&(a.textContent=e.format(t.forks_count??0)),r&&(r.textContent=t.license?.spdx_id??"No License")}const i=`github-repo-${e}`,m=sessionStorage.getItem(i);if(m){c(JSON.parse(m))}else try{const t=await fetch(`https://api.github.com/repos/${e}`);if(!t.ok){if(n){const e=404===t.status?"Repository not found":"Failed to load repository data";n.textContent=e}return}const o=await t.json();sessionStorage.setItem(i,JSON.stringify(o)),c(o)}catch(t){console.error(`Failed to fetch ${e}:`,t)}}function f(){const t=document.getElementsByClassName("gc-container");0!==t.length&&Array.from(t).forEach((t=>{p(t)}))}document.addEventListener("astro:page-load",f),f()</script><script type=module src=/_astro/MediaEmbed.astro_astro_type_script_index_0_lang.wKrCMCCr.js></script><script type=module>const n={overlay:document.querySelector(".zoom-overlay"),zoomedImg:null,originalImg:null,createOverlay(){this.overlay&&this.overlay.isConnected||(this.overlay=document.createElement("div"),this.overlay.classList.add("zoom-overlay"),this.overlay.setAttribute("role","dialog"),this.overlay.setAttribute("aria-modal","true"),this.overlay.setAttribute("aria-label","Image Viewer"),this.overlay.setAttribute("tabindex","-1"),Object.assign(this.overlay.style,{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",zIndex:"999",backgroundColor:"oklch(var(--un-preset-theme-colors-background) / 0.95)",opacity:"0",transition:"opacity 300ms cubic-bezier(0.4, 0, 0.2, 1)",cursor:"zoom-out",display:"none"}),document.body.appendChild(this.overlay))},zoomImg(e){if(!this.overlay)return;document.body.style.overflow="hidden";const t=e.getBoundingClientRect();this.originalImg=e,this.zoomedImg=e.cloneNode(),Object.assign(this.zoomedImg.style,{position:"fixed",top:`${t.top}px`,left:`${t.left}px`,width:`${t.width}px`,height:`${t.height}px`,transition:"transform 300ms cubic-bezier(0.4, 0, 0.2, 1)",zIndex:"1000",cursor:"zoom-out"}),document.body.appendChild(this.zoomedImg),this.overlay.style.display="block",this.overlay.focus();const o=window.innerWidth,i=window.innerHeight,s=window.innerWidth<768?1:.8,l=Math.min(o*s/t.width,i*s/t.height),a=(-t.left+(o-t.width)/2)/l,n=(-t.top+(i-t.height)/2)/l;requestAnimationFrame((()=>{this.overlay&&(this.overlay.style.opacity="1"),this.zoomedImg&&(this.zoomedImg.style.transform=`scale(${l}) translate3d(${a}px, ${n}px, 0)`)}))},close(){!this.overlay||!this.zoomedImg||!this.originalImg||(this.zoomedImg.style.transform="",this.overlay.style.opacity="0",document.body.style.overflow="",setTimeout((()=>{this.zoomedImg&&this.zoomedImg.parentNode&&document.body.removeChild(this.zoomedImg),this.zoomedImg=null,this.overlay&&(this.overlay.style.display="none"),this.originalImg&&this.originalImg.focus(),this.originalImg=null}),300))},setupOverlay(){this.createOverlay(),this.zoomedImg=null,this.originalImg=null},handleClick(e){if(this.zoomedImg)return void this.close();const t=e.target;t instanceof HTMLImageElement&&t.complete&&t.naturalWidth>=100&&t.naturalHeight>=100&&this.zoomImg(t)},handleResize(){this.zoomedImg&&this.close()},init(){this.createOverlay(),document.addEventListener("astro:page-load",(()=>this.setupOverlay())),document.addEventListener("click",(e=>this.handleClick(e)),{passive:!0}),window.addEventListener("resize",(()=>this.handleResize()),{passive:!0})}};n.init()</script></body></html>